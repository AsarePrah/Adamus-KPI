<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Adamus - KPI </title>
  <style>
    /* --------- Reset & Base --------- */
    :root {
      --bg: #0f1724;
      --card: #0b1220;
      --accent: #7c3aed;
      --muted: #9aa4b2;
      --success: #10b981;
      --danger: #ef4444;
      --glass: rgba(255, 255, 255, 0.04);
      --shadow: 0 6px 18px rgba(2, 6, 23, 0.6);
      --radius: 12px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", "Segoe UI Mono", monospace;
    }

    * {
      box-sizing: border-box
    }

    html,
    body {
      height: 100%;
      margin: 0;
      font-family: Inter, system-ui, -apple-system, Roboto, "Segoe UI", Arial;
      background: #ffffff;
      color: #000
    }

    .wrap {
      max-width: 1100px;
      margin: 28px 20px;
      padding: 16px 20px 16px 12px;
      display: none
    }

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 18px
    }

    header h1 {
      font-size: 20px;
      margin: 0;
      color: #000
    }

    header p {
      color: var(--muted);
      margin: 0;
      font-size: 13px
    }

    /* --------- Layout --------- */
    .grid {
      display: grid;
      grid-template-columns: 200px 1fr;
      gap: 18px
    }

    .card {
      background: linear-gradient(180deg, rgba(255, 255, 255, 0.02), rgba(255, 255, 255, 0.01));
      border-radius: var(--radius);
      padding: 16px;
      box-shadow: var(--shadow)
    }

    /* --------- Forms --------- */
    label {
      display: block;
      font-size: 13px;
      color: var(--muted);
      margin-bottom: 6px
    }

    input[type=text],
    input[type=date],
    select {
      width: 100%;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid rgba(0, 0, 0, 0.85);
      background: #ffffff;
      color: #000
    }

    input::-webkit-input-placeholder,
    textarea::-webkit-input-placeholder,
    select::-webkit-input-placeholder {
      color: #000
    }

    input:-ms-input-placeholder,
    textarea:-ms-input-placeholder {
      color: #000
    }

    input::-ms-input-placeholder,
    textarea::-ms-input-placeholder {
      color: #000
    }

    input::-moz-placeholder,
    textarea::-moz-placeholder {
      color: #000;
      opacity: 1
    }

    input::placeholder,
    textarea::placeholder,
    select::placeholder {
      color: #000
    }

    .btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 8px;
      border-radius: 10px;
      background: linear-gradient(90deg, var(--accent), #5b21b6);
      border: none;
      color: white;
      cursor: pointer
    }

    .btn.ghost {
      background: transparent;
      border: 1px solid rgba(255, 255, 255, 0.04)
    }

    /* Make ghost delete buttons in tables visible (black text) */
    table .btn.ghost {
      color: #000;
      border: none;
      background: transparent;
    }

    /* Login and header buttons specific: make Cancel, Forgot and Export buttons use black text and border */
    #btnLoginCancel,
    #btnForgot,
    #btnExport,
    #btnHeaderForgot {
      color: #000;
      border: 1px solid rgba(0, 0, 0, 0.85);
      background: transparent;
    }

    /* Employee directory: make Edit/Remove ghost buttons black (text), remove border */
    #employeeDirectoryCard .btn.ghost,
    #tblEmployees .btn.ghost {
      color: #000;
      border: none;
      background: transparent;
    }

    /* Departments: make department buttons and sub-links use black text for readability */
    .dept-btn,
    .dept-sub-btn {
      color: #000;
      border-color: rgba(0, 0, 0, 0.85);
      background: transparent;
    }

    .btn.ghost.dept-btn {
      color: #000;
      border: 1px solid rgba(0, 0, 0, 0.85);
    }

    .muted {
      color: var(--muted);
      font-size: 13px
    }

    /* --------- Directory & Requests Table --------- */
    table {
      width: auto;
      border-collapse: collapse
    }

    th,
    td {
      padding: 5px;
      text-align: left;
      font-size: 14px
    }

    thead th {
      font-size: 12px;
      color: var(--muted);
      font-weight: 600
    }

    tbody tr {
      border-top: 1px solid rgba(255, 255, 255, 0.02)
    }

    .pill {
      display: inline-block;
      padding: 6px 8px;
      border-radius: 999px;
      font-size: 12px
    }

    .pill.pending {
      background: linear-gradient(90deg, #f59e0b22, #f59e0b11);
      color: #f59e0b
    }

    .pill.approved {
      background: linear-gradient(90deg, #10b98122, #10b98111);
      color: var(--success)
    }

    .pill.rejected {
      background: linear-gradient(90deg, #ef444422, #ef444411);
      color: var(--danger)
    }

    /* --------- Small helpers --------- */
    .small {
      font-size: 13px;
      color: var(--muted)
    }

    .row {
      display: flex;
      gap: 10px;
      align-items: center
    }

    .space {
      height: 12px
    }

    footer {
      margin-top: 18px;
      color: var(--muted);
      font-size: 13px;
      text-align: center
    }

    /* Responsive */
    @media (max-width:880px) {
      .grid {
        grid-template-columns: 1fr
      }

      .wrap {
        padding: 12px
      }
    }

    .hidden {
      display: none
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Key Performance Indicators(KPI) </h1>
        <p class="small">Adamus Resources Limited (KPI-2026).</p>
      </div>
      <div class="row">
        <button class="btn ghost" id="btnExport">Export</button>
        <label class="small" style="margin-right:8px;color:var(--muted);display:flex;align-items:center">Signed in as
          <select id="currentUser"
            style="margin-left:8px;padding:6px;border-radius:8px;background:transparent;color:inherit;border:1px solid rgba(255,255,255,0.04)">
            <option value="">— none —</option>
          </select>
        </label>
        <label class="small" id="adminToggleLabel" style="margin-left:8px;display:none;align-items:center">Admin view
          <input id="adminView" type="checkbox" style="margin-left:8px;margin-top:0" />
        </label>

        <button class="btn ghost" id="btnHeaderForgot" onclick="openReset();">Forgot?</button>
        <button class="btn ghost" id="btnLoginToggle" onclick="openLogin();">Login</button>
      </div>
    </header>

    <div class="grid">
      <div class="card">
        <h3 style="margin-top:0">Navigation</h3>
        <div class="space"></div>
        <ul style="list-style:none;padding:0;margin:0">
          <li style="margin-bottom:8px"><a class="small nav-link" href="#" data-target="addEmployee">Add Employee</a>
          </li>
          <li style="margin-bottom:8px"><a class="small nav-link" href="#" data-target="employeeDirectoryCard">Employee
              Directory</a></li>
          <li style="margin-bottom:8px"><a class="small nav-link" href="#" data-target="departmentsCard">Departments</a>
          </li>
        </ul>
      </div>

      <div>
        <div class="card section hidden" id="addEmployee">
          <h3 style="margin-top:0">Add Employee</h3>
          <div class="space"></div>
          <label for="empId">Employee ID</label>
          <input id="empId" type="text" placeholder="E001" />
          <label for="empName">Name</label>
          <input id="empName" type="text" placeholder="Jane Doe" />
          <label for="empDept">Department</label>
          <select id="empDept">
            <option value="">— choose department —</option>
            <option>Geology</option>
            <option>Mining</option>
            <option>Milling_CIL</option>
            <option>Crushing</option>
            <option>OHS</option>
            <option>Engineering</option>
          </select>
          <label for="empPassword">Password (optional)</label>
          <input id="empPassword" type="password" placeholder="password" />
          <label for="empRole">Role</label>
          <select id="empRole">
            <option value="Employee">Employee</option>
            <option value="HOD">HOD</option>
            <option value="Admin">Admin</option>
          </select>
          <div class="space"></div>
          <button class="btn" id="btnAddEmp">Add Employee</button>
        </div>

        <!-- Apply for Leave, Holidays and Report UI removed (replaced by Departments/KPI forms) -->

        <div class="card section hidden" id="employeeDirectoryCard" style="margin-bottom:12px">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <h3 style="margin:0">Employee Directory</h3>
            <span class="small" id="empCount">0 employees</span>
          </div>
          <div class="space"></div>
          <table id="tblEmployees">
            <thead>
              <tr>
                <th>ID</th>
                <th>Name</th>
                <th>Dept</th>
                <th>Role</th>
                <th></th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <!-- Leave Requests removed -->

        <!-- report removed -->

        <!-- Departments inserted under Employee Directory -->
        <div class="card hidden" id="departmentsCard" style="margin-top:12px">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <h3 style="margin:0">Departments</h3>
            <span class="small">Access: Admin = all, HOD/Employee = own</span>
          </div>
          <div class="space"></div>
          <!-- Dashboard: visible to all users -->
          <div id="navDashboard" style="display:block;margin-bottom:12px">
            <h4 style="margin:0 0 8px 0;font-size:14px">Status</h4>
            <div style="display:flex;gap:8px;flex-wrap:wrap">
              <div class="pill pending" id="dashPending"
                style="padding:8px 10px;border-radius:8px;min-width:88px;text-align:center">MTD
                Actual<br><strong>0</strong></div>
              <div class="pill approved" id="dashApproved"
                style="padding:8px 10px;border-radius:8px;min-width:88px;text-align:center">MTD
                Forecast<br><strong>0</strong></div>
              <div class="pill rejected" id="dashRejected"
                style="padding:8px 10px;border-radius:8px;min-width:88px;text-align:center">
                Variance<br><strong>0</strong></div>
            </div>
          </div>
          <div id="deptList" style="display:flex;gap:12px;flex-wrap:wrap">
            <button class="btn ghost dept-btn" data-dept="Crushing">Crushing</button>
            <button class="btn ghost dept-btn" data-dept="Mining">Mining</button>
            <button class="btn ghost dept-btn" data-dept="Milling_CIL">Milling_CIL</button>
            <button class="btn ghost dept-btn" data-dept="Geology">Geology</button>
            <button class="btn ghost dept-btn" data-dept="OHS">OHS</button>
            <button class="btn ghost dept-btn" data-dept="Engineering">Engineering</button>
            <button class="btn ghost dept-btn" data-dept="GM">GM Report</button>
          </div>
          <div class="space"></div>
          <div class="small muted">Click a department to open its KPI form.</div>
        </div>

        <!-- Department forms (hidden by default) -->
        <div class="card section hidden" id="dept-Geology" style="margin-top:12px">
          <div id="breadcrumb-Geology" class="breadcrumb hidden"
            style="margin-bottom:12px;padding:8px;background:#f5f5f5;border-radius:4px;display:flex;align-items:center;gap:8px">
            <button class="btn small" id="btnBackGeology" style="padding:4px 8px">← Back</button>
            <span id="breadcrumbTextGeology">Geology — KPI</span>
          </div>
          <h3 style="margin-top:0">Geology - KPI</h3>
          <div class="space"></div>
          <!-- Dashboard: visible to HODs and Admins -->
          <div id="navDashboardGeology" style="display:none;margin-bottom:8px">
            <h4 style="margin:0 0 8px 0;font-size:14px">Status</h4>
            <div style="display:flex;gap:8px;flex-wrap:wrap">
              <div class="pill pending" id="dashPendingGeology"
                style="padding:8px 10px;border-radius:8px;min-width:88px;text-align:center">MTD
                Actual<br><strong>0</strong></div>
              <div class="pill approved" id="dashApprovedGeology"
                style="padding:8px 10px;border-radius:8px;min-width:88px;text-align:center">MTD
                Forecast<br><strong>0</strong></div>
              <div class="pill rejected" id="dashRejectedGeology"
                style="padding:8px 10px;border-radius:8px;min-width:88px;text-align:center">
                Variance<br><strong>0</strong></div>
            </div>
          </div>
          <div id="submenu-nav-Geology"
            style="display:flex;flex-direction:column;gap:8px;align-items:flex-start;margin-bottom:8px"> <a href="#"
              class="small dept-sub-btn" data-dept="Geology" data-sub="fixed-records">Fixed Inputs</a>
            <a href="#" class="small dept-sub-btn" data-dept="Geology" data-sub="grade-records">Exploration Drilling</a>
            <a href="#" class="small dept-sub-btn" data-dept="Geology" data-sub="ore-records">Grade Control Drilling</a>
            <a href="#" class="small dept-sub-btn" data-dept="Geology" data-sub="toll">Toll</a>
          </div>
          <div class="space"></div>
          <div id="Geology-fixed-records" class="dept-subpanel hidden">
            <h4 style="margin:8px 0">Fixed Inputs</h4>
            <div class="space"></div>
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
              <div class="small muted">Showing fixed inputs</div>
              <p style="margin:0"><a href="#" class="small dept-sub-btn" data-dept="Geology" data-sub="fixed">Add
                  New</a></p>
            </div>
            <table id="tblGeologyRecords" style="width:auto;border-collapse:collapse">
              <thead>
                <tr>
                  <th>KPI</th>
                  <th>Month</th>
                  <th>Days</th>
                  <th>Full Forecast</th>
                  <th>Full Budget</th>
                  <th>Forecast Per Rig</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="tbodyGeologyRecords"></tbody>
            </table>
          </div>
          <div id="Geology-fixed" class="dept-subpanel hidden">
            <h4 style="margin:8px 0">Fixed Inputs</h4>
            <label for="geoKPI">KPI</label>
            <select id="geoKPI">
              <option>Exploration Drilling</option>
              <option>Grade Control Drilling</option>
              <option>Toll</option>
            </select>
            <label for="geoTargetMonth">Target Month</label>
            <input id="geoTargetMonth" type="month" />
            <label for="geoNumDays">Number of Days</label>
            <input id="geoNumDays" type="number" placeholder="Number of days" />
            <label for="geoFullForecast">Full Forecast</label>
            <input id="geoFullForecast" type="text" placeholder="Full Forecast" />
            <label for="geoFullBudget">Full Budget</label>
            <input id="geoFullBudget" type="text" placeholder="Full Budget" />
            <label for="geoForecastPerRig">Forecast per Rig</label>
            <input id="geoForecastPerRig" type="text" placeholder="Forecast per Rig" />
            <div class="space"></div>
            <div style="display:flex;gap:8px"><button class="btn" id="btnGeoSave">Save</button><button class="btn ghost"
                id="btnGeoClear">Clear</button></div>
          </div>
          <div id="Geology-grade-records" class="dept-subpanel hidden">
            <h4 style="margin:8px 0">Exploration Drilling</h4>
            <div class="space"></div>
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
              <p style="margin:0"><a href="#" class="small dept-sub-btn" data-dept="Geology" data-sub="grade-form">Add
                  New</a></p>
            </div>
            <table id="tblGeologyGradeRecords" style="width:auto;border-collapse:collapse">
              <thead>
                <tr>
                  <th>KPI</th>
                  <th>Date</th>
                  <th>Rig</th>
                  <th>Daily Actual</th>
                  <th>Daily Forecast</th>
                  <th>Var</th>
                  <th>MTD Actual</th>
                  <th>MTD Forecast</th>
                  <th>Var</th>
                  <th>Outlook (a)</th>
                  <th>Full Forecast (b)</th>
                  <th>Full Budget (c)</th>
                  <th>Var</th>
                  <th>Month</th>
                </tr>
              </thead>
              <tbody id="tbodyGeologyGradeRecords"></tbody>
            </table>
          </div>
          <div id="Geology-grade-form" class="dept-subpanel hidden">
            <h4 style="margin:8px 0">Exploration Drilling</h4>
            <div class="space"></div>
            <div class="vertical-form" style="display:flex;flex-direction:column;gap:8px">
              <label class="small">KPI<input id="geoGrade_kpi" type="text" style="width:100%"
                  placeholder="Exploration Drilling" value="Exploration Drilling" /></label>
              <label class="small">Date<input id="geoGrade_date" type="date" style="width:100%" /></label>
              <label class="small">Rig<input id="geoGrade_rig" type="text" style="width:100%"
                  placeholder="Rig" /></label>
              <label class="small">Daily Actual<input id="geoGrade_daily_actual" type="text" style="width:100%"
                  placeholder="Daily Actual" /></label>
              <label class="small">Daily Forecast<input id="geoGrade_daily_forecast" type="text" style="width:100%"
                  placeholder="Daily Forecast" /></label>
              <label class="small">Var<input id="geoGrade_var1" type="text" style="width:100%"
                  placeholder="Var" /></label>
              <label class="small">MTD Actual<input id="geoGrade_mtd_actual" type="text" style="width:100%"
                  placeholder="MTD Actual" /></label>
              <label class="small">MTD Forecast<input id="geoGrade_mtd_forecast" type="text" style="width:100%"
                  placeholder="MTD Forecast" /></label>
              <label class="small">Var<input id="geoGrade_var2" type="text" style="width:100%"
                  placeholder="Var" /></label>
              <label class="small">Outlook (a)<input id="geoGrade_outlook" type="text" style="width:100%"
                  placeholder="Outlook (a)" /></label>
              <label class="small">Full Forecast (b)<input id="geoGrade_fullForecast" type="text" style="width:100%"
                  placeholder="Full Forecast (b)" /></label>
              <label class="small">Full Budget (c)<input id="geoGrade_fullBudget" type="text" style="width:100%"
                  placeholder="Full Budget (c)" /></label>
              <label class="small">Var<input id="geoGrade_var3" type="text" style="width:100%"
                  placeholder="Var" /></label>
              <label class="small">Month<input id="geoGrade_month" type="text" style="width:100%"
                  placeholder="Month" /></label>
            </div>
            <div class="space"></div>
            <div style="display:flex;gap:8px"><button class="btn" id="btnGeologyGradeSave">Save</button><button
                class="btn ghost" id="btnGeologyGradeClear">Clear</button></div>
          </div>
          <div id="Geology-ore-records" class="dept-subpanel hidden">
            <h4 style="margin:8px 0">Grade Control Drilling</h4>
            <div class="space"></div>
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
              <p style="margin:0"><a href="#" class="small dept-sub-btn" data-dept="Geology" data-sub="ore-form">Add
                  New</a></p>
            </div>
            <table id="tblGeologyOreRecords" style="width:auto;border-collapse:collapse">
              <thead>
                <tr>
                  <th>KPI</th>
                  <th>Date</th>
                  <th>Rig</th>
                  <th>Daily Actual</th>
                  <th>Daily Forecast</th>
                  <th>Var</th>
                  <th>MTD Actual</th>
                  <th>MTD Forecast</th>
                  <th>Var</th>
                  <th>Outlook (a)</th>
                  <th>Full Forecast (b)</th>
                  <th>Full Budget (c)</th>
                  <th>Var</th>
                  <th>Month</th>
                </tr>
              </thead>
              <tbody id="tbodyGeologyOreRecords"></tbody>
            </table>
          </div>
          <div id="Geology-ore-form" class="dept-subpanel hidden">
            <h4 style="margin:8px 0">Grade Control Drilling</h4>
            <div class="space"></div>
            <div class="vertical-form" style="display:flex;flex-direction:column;gap:8px">
              <label class="small">KPI<input id="geoOre_kpi" type="text" style="width:100%" placeholder="KPI"
                  value="Grade Control Drilling" /></label>
              <label class="small">Date<input id="geoOre_date" type="date" style="width:100%" /></label>
              <label class="small">Rig<input id="geoOre_rig" type="text" style="width:100%" placeholder="Rig" /></label>
              <label class="small">Daily Actual<input id="geoOre_daily_actual" type="text" style="width:100%"
                  placeholder="Daily Actual" /></label>
              <label class="small">Daily Forecast<input id="geoOre_daily_forecast" type="text" style="width:100%"
                  placeholder="Daily Forecast" /></label>
              <label class="small">Var<input id="geoOre_var1" type="text" style="width:100%"
                  placeholder="Var" /></label>
              <label class="small">MTD Actual<input id="geoOre_mtd_actual" type="text" style="width:100%"
                  placeholder="MTD Actual" /></label>
              <label class="small">MTD Forecast<input id="geoOre_mtd_forecast" type="text" style="width:100%"
                  placeholder="MTD Forecast" /></label>
              <label class="small">Var<input id="geoOre_var2" type="text" style="width:100%"
                  placeholder="Var" /></label>
              <label class="small">Outlook (a)<input id="geoOre_outlook" type="text" style="width:100%"
                  placeholder="Outlook (a)" /></label>
              <label class="small">Full Forecast (b)<input id="geoOre_fullForecast" type="text" style="width:100%"
                  placeholder="Full Forecast (b)" /></label>
              <label class="small">Full Budget (c)<input id="geoOre_fullBudget" type="text" style="width:100%"
                  placeholder="Full Budget (c)" /></label>
              <label class="small">Var<input id="geoOre_var3" type="text" style="width:100%"
                  placeholder="Var" /></label>
              <label class="small">Month<input id="geoOre_month" type="text" style="width:100%"
                  placeholder="Month" /></label>
            </div>
            <div class="space"></div>
            <div style="display:flex;gap:8px"><button class="btn" id="btnGeologyOreSave">Save</button><button
                class="btn ghost" id="btnGeologyOreClear">Clear</button></div>
          </div>
          <div id="Geology-toll-records" class="dept-subpanel hidden">
            <h4 style="margin:8px 0">Toll</h4>
            <div class="space"></div>
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
              <p style="margin:0"><a href="#" class="small dept-sub-btn" data-dept="Geology" data-sub="toll-form">Add
                  New</a></p>
            </div>
            <table id="tblGeologyTollRecords" style="width:auto;border-collapse:collapse">
              <thead>
                <tr>
                  <th>KPI</th>
                  <th>Date</th>
                  <th>Wet Tonnes</th>
                  <th>Daily Actual</th>
                  <th>Daily Forecast</th>
                  <th>Var</th>
                  <th>MTD Actual</th>
                  <th>MTD Forecast</th>
                  <th>Var</th>
                  <th>Outlook (a)</th>
                  <th>Full Forecast (b)</th>
                  <th>Full Budget (c)</th>
                  <th>Var</th>
                  <th>Grade</th>
                  <th>Grade(Day-7)</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="tbodyGeologyTollRecords"></tbody>
            </table>
          </div>
          <div id="Geology-toll-form" class="dept-subpanel hidden">
            <h4 style="margin:8px 0">Toll</h4>
            <div class="space"></div>
            <div class="vertical-form" style="display:flex;flex-direction:column;gap:8px">
              <label class="small">KPI<input id="geoToll_kpi" type="text" style="width:100%" placeholder="KPI"
                  value="Toll" /></label>
              <label class="small">Date<input id="geoToll_date" type="date" style="width:100%" /></label>
              <label class="small">Grade<input id="geoToll_grade" type="text" style="width:100%"
                  placeholder="Grade" /></label>
              <label class="small">Wet Tonnes<input id="geoToll_wetTonnes" type="text" style="width:100%"
                  placeholder="Wet Tonnes" /></label>
              <label class="small">Daily Actual<input id="geoToll_daily_actual" type="text" style="width:100%"
                  placeholder="Daily Actual" /></label>
              <label class="small">Daily Forecast<input id="geoToll_daily_forecast" type="text" style="width:100%"
                  placeholder="Daily Forecast" /></label>
              <label class="small">Var<input id="geoToll_var1" type="text" style="width:100%"
                  placeholder="Var" /></label>
              <label class="small">MTD Actual<input id="geoToll_mtd_actual" type="text" style="width:100%"
                  placeholder="MTD Actual" /></label>
              <label class="small">MTD Forecast<input id="geoToll_mtd_forecast" type="text" style="width:100%"
                  placeholder="MTD Forecast" /></label>
              <label class="small">Var<input id="geoToll_var2" type="text" style="width:100%"
                  placeholder="Var" /></label>
              <label class="small">Outlook (a)<input id="geoToll_outlook" type="text" style="width:100%"
                  placeholder="Outlook (a)" /></label>
              <label class="small">Full Forecast (b)<input id="geoToll_fullForecast" type="text" style="width:100%"
                  placeholder="Full Forecast (b)" /></label>
              <label class="small">Full Budget (c)<input id="geoToll_fullBudget" type="text" style="width:100%"
                  placeholder="Full Budget (c)" /></label>
              <label class="small">Var<input id="geoToll_var3" type="text" style="width:100%"
                  placeholder="Var" /></label>
              <label class="small">Grade(Day-7)<input id="geoToll_gradeDay7" type="text" style="width:100%"
                  placeholder="Grade(Day-7)" /></label>
            </div>
            <div class="space"></div>
            <div style="display:flex;gap:8px"><button class="btn" id="btnGeologyTollSave">Save</button><button
                class="btn ghost" id="btnGeologyTollClear">Clear</button></div>
          </div>
        </div>

        <div class="card section hidden" id="dept-Mining" style="margin-top:12px">
          <div id="breadcrumb-Mining" class="breadcrumb hidden"
            style="margin-bottom:12px;padding:8px;background:#f5f5f5;border-radius:4px;display:flex;align-items:center;gap:8px">
            <button class="btn small" id="btnBackMining" style="padding:4px 8px">← Back</button>
            <span id="breadcrumbTextMining">Mining — KPI</span>
          </div>
          <h3 style="margin-top:0">Mining - KPI</h3>
          <div class="space"></div>
          <!-- Dashboard: visible to HODs and Admins -->
          <div id="navDashboardMining" style="display:none;margin-bottom:8px">
            <h4 style="margin:0 0 8px 0;font-size:14px">Status</h4>
            <div style="display:flex;gap:8px;flex-wrap:wrap">
              <div class="pill pending" id="dashPendingMining"
                style="padding:8px 10px;border-radius:8px;min-width:88px;text-align:center">MTD
                Actual<br><strong>0</strong></div>
              <div class="pill approved" id="dashApprovedMining"
                style="padding:8px 10px;border-radius:8px;min-width:88px;text-align:center">MTD
                Forecast<br><strong>0</strong></div>
              <div class="pill rejected" id="dashRejectedMining"
                style="padding:8px 10px;border-radius:8px;min-width:88px;text-align:center">
                Variance<br><strong>0</strong></div>
            </div>
          </div>
          <div id="submenu-nav-Mining"
            style="display:flex;flex-direction:column;gap:8px;align-items:flex-start;margin-bottom:8px">
            <a href="#" class="small dept-sub-btn" data-dept="Mining" data-sub="fixed-records">Fixed Inputs</a>
            <a href="#" class="small dept-sub-btn" data-dept="Mining" data-sub="ore-mined">Ore Mined</a>
            <a href="#" class="small dept-sub-btn" data-dept="Mining" data-sub="grade-ore-mined">Grade - Ore Mined</a>
            <a href="#" class="small dept-sub-btn" data-dept="Mining" data-sub="total-material-moved">Total Material
              Moved</a>
            <a href="#" class="small dept-sub-btn" data-dept="Mining" data-sub="blast-hole-drilling">Blast Hole
              Drilling</a>
          </div>
          <div class="space"></div>
          <div id="Mining-fixed-records" class="dept-subpanel hidden">
            <h4 style="margin:8px 0">Fixed Inputs</h4>
            <div class="space"></div>
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
              <p style="margin:0"><a href="#" class="small dept-sub-btn" data-dept="Mining" data-sub="fixed">Add New</a>
              </p>
            </div>
            <table id="tblMiningRecords" style="width:auto;border-collapse:collapse">
              <thead>
                <tr>
                  <th>KPI</th>
                  <th>Month</th>
                  <th>Days</th>
                  <th>Full Forecast</th>
                  <th>Full Budget</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="tbodyMiningRecords"></tbody>
            </table>
          </div>
          <div id="Mining-fixed" class="dept-subpanel hidden">
            <h4 style="margin:8px 0">Fixed Inputs</h4>
            <label for="miningKPI">KPI</label>
            <select id="miningKPI">
              <option>Ore Mined</option>
              <option>Grade - Ore Mined</option>
              <option>Total Material Moved</option>
              <option>Blast Hole Drilling</option>
            </select>
            <label for="miningTargetMonth">Target Month</label>
            <input id="miningTargetMonth" type="month" />
            <label for="miningNumDays">Number of Days</label>
            <input id="miningNumDays" type="number" placeholder="Number of days" />
            <label for="miningFullForecast">Full Forecast</label>
            <input id="miningFullForecast" type="text" placeholder="Full Forecast" />
            <label for="miningFullBudget">Full Budget</label>
            <input id="miningFullBudget" type="text" placeholder="Full Budget" />
            <div class="space"></div>
            <div style="display:flex;gap:8px"><button class="btn" id="btnMiningSave">Save</button><button
                class="btn ghost" id="btnMiningClear">Clear</button></div>
          </div>
          <div id="Mining-ore-mined" class="dept-subpanel hidden">
            <h4 style="margin:8px 0">Ore Mined</h4>
            <div class="space"></div>
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
              <p style="margin:0"><a href="#" class="small dept-sub-btn" data-dept="Mining"
                  data-sub="ore-mined-form">Add New</a></p>
            </div>
            <table id="tblMiningOreMinedRecords" style="width:auto;border-collapse:collapse">
              <thead>
                <tr>
                  <th>KPI</th>
                  <th>Date</th>
                  <th>Daily Actual</th>
                  <th>Daily Forecast</th>
                  <th>Var</th>
                  <th>MTD Actual</th>
                  <th>MTD Forecast</th>
                  <th>Var</th>
                  <th>Outlook (a)</th>
                  <th>Full Forecast (b)</th>
                  <th>Full Budget (c)</th>
                  <th>Var</th>
                  <th>Month</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="tbodyMiningOreMinedRecords"></tbody>
            </table>
          </div>
          <div id="Mining-ore-mined-form" class="dept-subpanel hidden">
            <h4 style="margin:8px 0">Ore Mined</h4>
            <div class="space"></div>
            <div class="vertical-form" style="display:flex;flex-direction:column;gap:8px">
              <label class="small">KPI<input id="miningOreMined_kpi" type="text" style="width:100%"
                  placeholder="Ore Mined" value="Ore Mined" /></label>
              <label class="small">Date<input id="miningOreMined_date" type="date" style="width:100%" /></label>
              <label class="small">Daily Actual<input id="miningOreMined_daily_actual" type="text" style="width:100%"
                  placeholder="Daily Actual" /></label>
              <label class="small">Daily Forecast<input id="miningOreMined_daily_forecast" type="text"
                  style="width:100%" placeholder="Daily Forecast" /></label>
              <label class="small">Var<input id="miningOreMined_var1" type="text" style="width:100%"
                  placeholder="Var" /></label>
              <label class="small">MTD Actual<input id="miningOreMined_mtd_actual" type="text" style="width:100%"
                  placeholder="MTD Actual" /></label>
              <label class="small">MTD Forecast<input id="miningOreMined_mtd_forecast" type="text" style="width:100%"
                  placeholder="MTD Forecast" /></label>
              <label class="small">Var<input id="miningOreMined_var2" type="text" style="width:100%"
                  placeholder="Var" /></label>
              <label class="small">Outlook (a)<input id="miningOreMined_outlook" type="text" style="width:100%"
                  placeholder="Outlook (a)" /></label>
              <label class="small">Full Forecast (b)<input id="miningOreMined_fullForecast" type="text"
                  style="width:100%" placeholder="Full Forecast (b)" /></label>
              <label class="small">Full Budget (c)<input id="miningOreMined_fullBudget" type="text" style="width:100%"
                  placeholder="Full Budget (c)" /></label>
              <label class="small">Var<input id="miningOreMined_var3" type="text" style="width:100%"
                  placeholder="Var" /></label>
              <label class="small">Month<input id="miningOreMined_month" type="text" style="width:100%"
                  placeholder="Month" /></label>
            </div>
            <div class="space"></div>
            <div style="display:flex;gap:8px"><button class="btn" id="btnMiningOreMinedSave">Save</button><button
                class="btn ghost" id="btnMiningOreMinedClear">Clear</button></div>
          </div>
          <div id="Mining-grade-ore-mined" class="dept-subpanel hidden">
            <h4 style="margin:8px 0">Grade - Ore Mined</h4>
            <div class="space"></div>
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
              <p style="margin:0"><a href="#" class="small dept-sub-btn" data-dept="Mining"
                  data-sub="grade-ore-mined-form">Add New</a></p>
            </div>
            <table id="tblMiningGradeOreMinedRecords" style="width:auto;border-collapse:collapse">
              <thead>
                <tr>
                  <th>KPI</th>
                  <th>Date</th>
                  <th>Daily Actual</th>
                  <th>Daily Forecast</th>
                  <th>Var</th>
                  <th>MTD Actual</th>
                  <th>MTD Forecast</th>
                  <th>Var</th>
                  <th>Outlook (a)</th>
                  <th>Full Forecast (b)</th>
                  <th>Full Budget (c)</th>
                  <th>Var</th>
                  <th>Month</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="tbodyMiningGradeOreMinedRecords"></tbody>
            </table>
          </div>
          <div id="Mining-grade-ore-mined-form" class="dept-subpanel hidden">
            <h4 style="margin:8px 0">Grade - Ore Mined</h4>
            <div class="space"></div>
            <div class="vertical-form" style="display:flex;flex-direction:column;gap:8px">
              <label class="small">KPI<input id="miningGradeOreMined_kpi" type="text" style="width:100%"
                  placeholder="Grade - Ore Mined" value="Grade - Ore Mined" /></label>
              <label class="small">Date<input id="miningGradeOreMined_date" type="date" style="width:100%" /></label>
              <label class="small">Daily Actual<input id="miningGradeOreMined_daily_actual" type="text"
                  style="width:100%" placeholder="Daily Actual" /></label>
              <label class="small">Daily Forecast<input id="miningGradeOreMined_daily_forecast" type="text"
                  style="width:100%" placeholder="Daily Forecast" /></label>
              <label class="small">Var<input id="miningGradeOreMined_var1" type="text" style="width:100%"
                  placeholder="Var" /></label>
              <label class="small">MTD Actual<input id="miningGradeOreMined_mtd_actual" type="text" style="width:100%"
                  placeholder="MTD Actual" /></label>
              <label class="small">MTD Forecast<input id="miningGradeOreMined_mtd_forecast" type="text"
                  style="width:100%" placeholder="MTD Forecast" /></label>
              <label class="small">Var<input id="miningGradeOreMined_var2" type="text" style="width:100%"
                  placeholder="Var" /></label>
              <label class="small">Outlook (a)<input id="miningGradeOreMined_outlook" type="text" style="width:100%"
                  placeholder="Outlook (a)" /></label>
              <label class="small">Full Forecast (b)<input id="miningGradeOreMined_fullForecast" type="text"
                  style="width:100%" placeholder="Full Forecast (b)" /></label>
              <label class="small">Full Budget (c)<input id="miningGradeOreMined_fullBudget" type="text"
                  style="width:100%" placeholder="Full Budget (c)" /></label>
              <label class="small">Var<input id="miningGradeOreMined_var3" type="text" style="width:100%"
                  placeholder="Var" /></label>
              <label class="small">Month<input id="miningGradeOreMined_month" type="text" style="width:100%"
                  placeholder="Month" /></label>
            </div>
            <div class="space"></div>
            <div style="display:flex;gap:8px"><button class="btn" id="btnMiningGradeOreMinedSave">Save</button><button
                class="btn ghost" id="btnMiningGradeOreMinedClear">Clear</button></div>
          </div>
          <div id="Mining-total-material-moved" class="dept-subpanel hidden">
            <h4 style="margin:8px 0">Total Material Moved</h4>
            <div class="space"></div>
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
              <p style="margin:0"><a href="#" class="small dept-sub-btn" data-dept="Mining"
                  data-sub="total-material-moved-form">Add New</a></p>
            </div>
            <table id="tblMiningTotalMaterialMovedRecords" style="width:auto;border-collapse:collapse">
              <thead>
                <tr>
                  <th>KPI</th>
                  <th>Date</th>
                  <th>Daily Actual</th>
                  <th>Daily Forecast</th>
                  <th>Var</th>
                  <th>MTD Actual</th>
                  <th>MTD Forecast</th>
                  <th>Var</th>
                  <th>Outlook (a)</th>
                  <th>Full Forecast (b)</th>
                  <th>Full Budget (c)</th>
                  <th>Var</th>
                  <th>Month</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="tbodyMiningTotalMaterialMovedRecords"></tbody>
            </table>
          </div>
          <div id="Mining-total-material-moved-form" class="dept-subpanel hidden">
            <h4 style="margin:8px 0">Total Material Moved</h4>
            <div class="space"></div>
            <div class="vertical-form" style="display:flex;flex-direction:column;gap:8px">
              <label class="small">KPI<input id="miningTotalMaterialMoved_kpi" type="text" style="width:100%"
                  placeholder="Total Material Moved" value="Total Material Moved" /></label>
              <label class="small">Date<input id="miningTotalMaterialMoved_date" type="date"
                  style="width:100%" /></label>
              <label class="small">Daily Actual<input id="miningTotalMaterialMoved_daily_actual" type="text"
                  style="width:100%" placeholder="Daily Actual" /></label>
              <label class="small">Daily Forecast<input id="miningTotalMaterialMoved_daily_forecast" type="text"
                  style="width:100%" placeholder="Daily Forecast" /></label>
              <label class="small">Var<input id="miningTotalMaterialMoved_var1" type="text" style="width:100%"
                  placeholder="Var" /></label>
              <label class="small">MTD Actual<input id="miningTotalMaterialMoved_mtd_actual" type="text"
                  style="width:100%" placeholder="MTD Actual" /></label>
              <label class="small">MTD Forecast<input id="miningTotalMaterialMoved_mtd_forecast" type="text"
                  style="width:100%" placeholder="MTD Forecast" /></label>
              <label class="small">Var<input id="miningTotalMaterialMoved_var2" type="text" style="width:100%"
                  placeholder="Var" /></label>
              <label class="small">Outlook (a)<input id="miningTotalMaterialMoved_outlook" type="text"
                  style="width:100%" placeholder="Outlook (a)" /></label>
              <label class="small">Full Forecast (b)<input id="miningTotalMaterialMoved_fullForecast" type="text"
                  style="width:100%" placeholder="Full Forecast (b)" /></label>
              <label class="small">Full Budget (c)<input id="miningTotalMaterialMoved_fullBudget" type="text"
                  style="width:100%" placeholder="Full Budget (c)" /></label>
              <label class="small">Var<input id="miningTotalMaterialMoved_var3" type="text" style="width:100%"
                  placeholder="Var" /></label>
              <label class="small">Month<input id="miningTotalMaterialMoved_month" type="text" style="width:100%"
                  placeholder="Month" /></label>
            </div>
            <div class="space"></div>
            <div style="display:flex;gap:8px"><button class="btn"
                id="btnMiningTotalMaterialMovedSave">Save</button><button class="btn ghost"
                id="btnMiningTotalMaterialMovedClear">Clear</button></div>
          </div>
          <div id="Mining-blast-hole-drilling" class="dept-subpanel hidden">
            <h4 style="margin:8px 0">Blast Hole Drilling</h4>
            <div class="space"></div>
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
              <p style="margin:0"><a href="#" class="small dept-sub-btn" data-dept="Mining"
                  data-sub="blast-hole-drilling-form">Add New</a></p>
            </div>
            <table id="tblMiningBlastHoleDrillingRecords" style="width:auto;border-collapse:collapse">
              <thead>
                <tr>
                  <th>KPI</th>
                  <th>Date</th>
                  <th>Daily Actual</th>
                  <th>Daily Forecast</th>
                  <th>Var</th>
                  <th>MTD Actual</th>
                  <th>MTD Forecast</th>
                  <th>Var</th>
                  <th>Outlook (a)</th>
                  <th>Full Forecast (b)</th>
                  <th>Full Budget (c)</th>
                  <th>Var</th>
                  <th>Month</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="tbodyMiningBlastHoleDrillingRecords"></tbody>
            </table>
          </div>
          <div id="Mining-blast-hole-drilling-form" class="dept-subpanel hidden">
            <h4 style="margin:8px 0">Blast Hole Drilling</h4>
            <div class="space"></div>
            <div class="vertical-form" style="display:flex;flex-direction:column;gap:8px">
              <label class="small">KPI<input id="miningBlastHoleDrilling_kpi" type="text" style="width:100%"
                  placeholder="Blast Hole Drilling" value="Blast Hole Drilling" /></label>
              <label class="small">Date<input id="miningBlastHoleDrilling_date" type="date"
                  style="width:100%" /></label>
              <label class="small">Daily Actual<input id="miningBlastHoleDrilling_daily_actual" type="text"
                  style="width:100%" placeholder="Daily Actual" /></label>
              <label class="small">Daily Forecast<input id="miningBlastHoleDrilling_daily_forecast" type="text"
                  style="width:100%" placeholder="Daily Forecast" /></label>
              <label class="small">Var<input id="miningBlastHoleDrilling_var1" type="text" style="width:100%"
                  placeholder="Var" /></label>
              <label class="small">MTD Actual<input id="miningBlastHoleDrilling_mtd_actual" type="text"
                  style="width:100%" placeholder="MTD Actual" /></label>
              <label class="small">MTD Forecast<input id="miningBlastHoleDrilling_mtd_forecast" type="text"
                  style="width:100%" placeholder="MTD Forecast" /></label>
              <label class="small">Var<input id="miningBlastHoleDrilling_var2" type="text" style="width:100%"
                  placeholder="Var" /></label>
              <label class="small">Outlook (a)<input id="miningBlastHoleDrilling_outlook" type="text" style="width:100%"
                  placeholder="Outlook (a)" /></label>
              <label class="small">Full Forecast (b)<input id="miningBlastHoleDrilling_fullForecast" type="text"
                  style="width:100%" placeholder="Full Forecast (b)" /></label>
              <label class="small">Full Budget (c)<input id="miningBlastHoleDrilling_fullBudget" type="text"
                  style="width:100%" placeholder="Full Budget (c)" /></label>
              <label class="small">Var<input id="miningBlastHoleDrilling_var3" type="text" style="width:100%"
                  placeholder="Var" /></label>
              <label class="small">Month<input id="miningBlastHoleDrilling_month" type="text" style="width:100%"
                  placeholder="Month" /></label>
            </div>
            <div class="space"></div>
            <div style="display:flex;gap:8px"><button class="btn"
                id="btnMiningBlastHoleDrillingSave">Save</button><button class="btn ghost"
                id="btnMiningBlastHoleDrillingClear">Clear</button></div>
          </div>
        </div>

        <div class="card section hidden" id="dept-Milling_CIL" style="margin-top:12px">
          <div id="breadcrumb-Milling_CIL" class="breadcrumb hidden"
            style="margin-bottom:12px;padding:8px;background:#f5f5f5;border-radius:4px;display:flex;align-items:center;gap:8px">
            <button class="btn small" id="btnBackMilling_CIL" style="padding:4px 8px">← Back</button>
            <span id="breadcrumbTextMilling_CIL">Milling_CIL — KPI</span>
          </div>
          <h3 style="margin-top:0">Milling_CIL - KPI</h3>
          <div class="space"></div>
          <!-- Dashboard: visible to HODs and Admins -->
          <div id="navDashboardMilling_CIL" style="display:none;margin-bottom:8px">
            <h4 style="margin:0 0 8px 0;font-size:14px">Status</h4>
            <div style="display:flex;gap:8px;flex-wrap:wrap">
              <div class="pill pending" id="dashPendingMilling_CIL"
                style="padding:8px 10px;border-radius:8px;min-width:88px;text-align:center">MTD
                Actual<br><strong>0</strong></div>
              <div class="pill approved" id="dashApprovedMilling_CIL"
                style="padding:8px 10px;border-radius:8px;min-width:88px;text-align:center">MTD
                Forecast<br><strong>0</strong></div>
              <div class="pill rejected" id="dashRejectedMilling_CIL"
                style="padding:8px 10px;border-radius:8px;min-width:88px;text-align:center">
                Variance<br><strong>0</strong></div>
            </div>
          </div>
          <div id="submenu-nav-Milling_CIL"
            style="display:flex;flex-direction:column;gap:8px;align-items:flex-start;margin-bottom:8px">
            <a href="#" class="small dept-sub-btn" data-dept="Milling_CIL" data-sub="fixed-records">Fixed Inputs</a>
            <a href="#" class="small dept-sub-btn" data-dept="Milling_CIL" data-sub="gold-contained">Gold Contained</a>
            <a href="#" class="small dept-sub-btn" data-dept="Milling_CIL" data-sub="gold-recovery">Gold Recovery</a>
            <a href="#" class="small dept-sub-btn" data-dept="Milling_CIL" data-sub="plant-feed-grade">Plant Feed
              Grade</a>
            <a href="#" class="small dept-sub-btn" data-dept="Milling_CIL" data-sub="tonnes-treated">Tonnes Treated</a>
          </div>
          <div class="space"></div>
          <div id="Milling_CIL-fixed-records" class="dept-subpanel hidden">
            <h4 style="margin:8px 0">Fixed Inputs</h4>
            <div class="space"></div>
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
              <p style="margin:0"><a href="#" class="small dept-sub-btn" data-dept="Milling_CIL" data-sub="fixed">Add
                  New</a></p>
            </div>
            <table id="tblMilling_CILRecords" style="width:auto;border-collapse:collapse">
              <thead>
                <tr>
                  <th>KPI</th>
                  <th>Month</th>
                  <th>Days</th>
                  <th>Full Forecast</th>
                  <th>Full Budget</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="tbodyMilling_CILRecords"></tbody>
            </table>
          </div>
          <div id="Milling_CIL-fixed" class="dept-subpanel hidden">
            <h4 style="margin:8px 0">Fixed Inputs</h4>
            <label for="millingCILKPI">KPI</label>
            <select id="millingCILKPI">
              <option>Gold Contained</option>
              <option>Gold Recovery</option>
              <option>Plant Feed Grade</option>
              <option>Tonnes Treated</option>
            </select>
            <label for="millingCILTargetMonth">Target Month</label>
            <input id="millingCILTargetMonth" type="month" />
            <label for="millingCILNumDays">Number of Days</label>
            <input id="millingCILNumDays" type="number" placeholder="Number of days" />
            <label for="millingCILFullForecast">Full Forecast</label>
            <input id="millingCILFullForecast" type="text" placeholder="Full Forecast" />
            <label for="millingCILFullBudget">Full Budget</label>
            <input id="millingCILFullBudget" type="text" placeholder="Full Budget" />
            <div class="space"></div>
            <div style="display:flex;gap:8px"><button class="btn" id="btnMilling_CILSave">Save</button><button
                class="btn ghost" id="btnMilling_CILClear">Clear</button></div>
          </div>
          <div id="Milling_CIL-gold-contained" class="dept-subpanel hidden">
            <h4 style="margin:8px 0">Gold Contained</h4>
            <div class="space"></div>
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
              <p style="margin:0"><a href="#" class="small dept-sub-btn" data-dept="Milling_CIL"
                  data-sub="gold-contained-form">Add New</a></p>
            </div>
            <table id="tblMilling_CILGoldContainedRecords" style="width:auto;border-collapse:collapse">
              <thead>
                <tr>
                  <th>KPI</th>
                  <th>Date</th>
                  <th>Daily Actual</th>
                  <th>Daily Forecast</th>
                  <th>Var</th>
                  <th>MTD Actual</th>
                  <th>MTD Forecast</th>
                  <th>Var</th>
                  <th>Outlook (a)</th>
                  <th>Full Forecast (b)</th>
                  <th>Full Budget (c)</th>
                  <th>Var</th>
                  <th>Month</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="tbodyMilling_CILGoldContainedRecords"></tbody>
            </table>
          </div>
          <div id="Milling_CIL-gold-contained-form" class="dept-subpanel hidden">
            <h4 style="margin:8px 0">Gold Contained</h4>
            <div class="space"></div>
            <div class="vertical-form" style="display:flex;flex-direction:column;gap:8px">
              <label class="small">KPI<input id="millingCILGoldContained_kpi" type="text" style="width:100%"
                  placeholder="Gold Contained" value="Gold Contained" /></label>
              <label class="small">Date<input id="millingCILGoldContained_date" type="date"
                  style="width:100%" /></label>
              <label class="small">Daily Actual<input id="millingCILGoldContained_daily_actual" type="text"
                  style="width:100%" placeholder="Daily Actual" /></label>
              <label class="small">Daily Forecast<input id="millingCILGoldContained_daily_forecast" type="text"
                  style="width:100%" placeholder="Daily Forecast" /></label>
              <label class="small">Var<input id="millingCILGoldContained_var1" type="text" style="width:100%"
                  placeholder="Var" /></label>
              <label class="small">MTD Actual<input id="millingCILGoldContained_mtd_actual" type="text"
                  style="width:100%" placeholder="MTD Actual" /></label>
              <label class="small">MTD Forecast<input id="millingCILGoldContained_mtd_forecast" type="text"
                  style="width:100%" placeholder="MTD Forecast" /></label>
              <label class="small">Var<input id="millingCILGoldContained_var2" type="text" style="width:100%"
                  placeholder="Var" /></label>
              <label class="small">Outlook (a)<input id="millingCILGoldContained_outlook" type="text" style="width:100%"
                  placeholder="Outlook (a)" /></label>
              <label class="small">Full Forecast (b)<input id="millingCILGoldContained_fullForecast" type="text"
                  style="width:100%" placeholder="Full Forecast (b)" /></label>
              <label class="small">Full Budget (c)<input id="millingCILGoldContained_fullBudget" type="text"
                  style="width:100%" placeholder="Full Budget (c)" /></label>
              <label class="small">Var<input id="millingCILGoldContained_var3" type="text" style="width:100%"
                  placeholder="Var" /></label>
              <label class="small">Month<input id="millingCILGoldContained_month" type="text" style="width:100%"
                  placeholder="Month" /></label>
            </div>
            <div class="space"></div>
            <div style="display:flex;gap:8px"><button class="btn"
                id="btnMilling_CILGoldContainedSave">Save</button><button class="btn ghost"
                id="btnMilling_CILGoldContainedClear">Clear</button></div>
          </div>
          <div id="Milling_CIL-gold-recovery" class="dept-subpanel hidden">
            <h4 style="margin:8px 0">Gold Recovery</h4>
            <div class="space"></div>
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
              <p style="margin:0"><a href="#" class="small dept-sub-btn" data-dept="Milling_CIL"
                  data-sub="gold-recovery-form">Add New</a></p>
            </div>
            <table id="tblMilling_CILGoldRecoveryRecords" style="width:auto;border-collapse:collapse">
              <thead>
                <tr>
                  <th>KPI</th>
                  <th>Date</th>
                  <th>Daily Actual</th>
                  <th>Daily Forecast</th>
                  <th>Var</th>
                  <th>MTD Actual</th>
                  <th>MTD Forecast</th>
                  <th>Var</th>
                  <th>Outlook (a)</th>
                  <th>Full Forecast (b)</th>
                  <th>Full Budget (c)</th>
                  <th>Var</th>
                  <th>Month</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="tbodyMilling_CILGoldRecoveryRecords"></tbody>
            </table>
          </div>
          <div id="Milling_CIL-gold-recovery-form" class="dept-subpanel hidden">
            <h4 style="margin:8px 0">Gold Recovery</h4>
            <div class="space"></div>
            <div class="vertical-form" style="display:flex;flex-direction:column;gap:8px">
              <label class="small">KPI<input id="millingCILGoldRecovery_kpi" type="text" style="width:100%"
                  placeholder="Gold Recovery" value="Gold Recovery" /></label>
              <label class="small">Date<input id="millingCILGoldRecovery_date" type="date" style="width:100%" /></label>
              <label class="small">Daily Actual<input id="millingCILGoldRecovery_daily_actual" type="text"
                  style="width:100%" placeholder="Daily Actual" /></label>
              <label class="small">Daily Forecast<input id="millingCILGoldRecovery_daily_forecast" type="text"
                  style="width:100%" placeholder="Daily Forecast" /></label>
              <label class="small">Var<input id="millingCILGoldRecovery_var1" type="text" style="width:100%"
                  placeholder="Var" /></label>
              <label class="small">MTD Actual<input id="millingCILGoldRecovery_mtd_actual" type="text"
                  style="width:100%" placeholder="MTD Actual" /></label>
              <label class="small">MTD Forecast<input id="millingCILGoldRecovery_mtd_forecast" type="text"
                  style="width:100%" placeholder="MTD Forecast" /></label>
              <label class="small">Var<input id="millingCILGoldRecovery_var2" type="text" style="width:100%"
                  placeholder="Var" /></label>
              <label class="small">Outlook (a)<input id="millingCILGoldRecovery_outlook" type="text" style="width:100%"
                  placeholder="Outlook (a)" /></label>
              <label class="small">Full Forecast (b)<input id="millingCILGoldRecovery_fullForecast" type="text"
                  style="width:100%" placeholder="Full Forecast (b)" /></label>
              <label class="small">Full Budget (c)<input id="millingCILGoldRecovery_fullBudget" type="text"
                  style="width:100%" placeholder="Full Budget (c)" /></label>
              <label class="small">Var<input id="millingCILGoldRecovery_var3" type="text" style="width:100%"
                  placeholder="Var" /></label>
              <label class="small">Month<input id="millingCILGoldRecovery_month" type="text" style="width:100%"
                  placeholder="Month" /></label>
            </div>
            <div class="space"></div>
            <div style="display:flex;gap:8px"><button class="btn"
                id="btnMilling_CILGoldRecoverySave">Save</button><button class="btn ghost"
                id="btnMilling_CILGoldRecoveryClear">Clear</button></div>
          </div>
          <div id="Milling_CIL-plant-feed-grade" class="dept-subpanel hidden">
            <h4 style="margin:8px 0">Plant Feed Grade</h4>
            <div class="space"></div>
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
              <p style="margin:0"><a href="#" class="small dept-sub-btn" data-dept="Milling_CIL"
                  data-sub="plant-feed-grade-form">Add New</a></p>
            </div>
            <table id="tblMilling_CILPlantFeedGradeRecords" style="width:auto;border-collapse:collapse">
              <thead>
                <tr>
                  <th>KPI</th>
                  <th>Date</th>
                  <th>Daily Actual</th>
                  <th>Daily Forecast</th>
                  <th>Var</th>
                  <th>MTD Actual</th>
                  <th>MTD Forecast</th>
                  <th>Var</th>
                  <th>Outlook (a)</th>
                  <th>Full Forecast (b)</th>
                  <th>Full Budget (c)</th>
                  <th>Var</th>
                  <th>Month</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="tbodyMilling_CILPlantFeedGradeRecords"></tbody>
            </table>
          </div>
          <div id="Milling_CIL-plant-feed-grade-form" class="dept-subpanel hidden">
            <h4 style="margin:8px 0">Plant Feed Grade</h4>
            <div class="space"></div>
            <div class="vertical-form" style="display:flex;flex-direction:column;gap:8px">
              <label class="small">KPI<input id="millingCILPlantFeedGrade_kpi" type="text" style="width:100%"
                  placeholder="Plant Feed Grade" value="Plant Feed Grade" /></label>
              <label class="small">Date<input id="millingCILPlantFeedGrade_date" type="date"
                  style="width:100%" /></label>
              <label class="small">Daily Actual<input id="millingCILPlantFeedGrade_daily_actual" type="text"
                  style="width:100%" placeholder="Daily Actual" /></label>
              <label class="small">Daily Forecast<input id="millingCILPlantFeedGrade_daily_forecast" type="text"
                  style="width:100%" placeholder="Daily Forecast" /></label>
              <label class="small">Var<input id="millingCILPlantFeedGrade_var1" type="text" style="width:100%"
                  placeholder="Var" /></label>
              <label class="small">MTD Actual<input id="millingCILPlantFeedGrade_mtd_actual" type="text"
                  style="width:100%" placeholder="MTD Actual" /></label>
              <label class="small">MTD Forecast<input id="millingCILPlantFeedGrade_mtd_forecast" type="text"
                  style="width:100%" placeholder="MTD Forecast" /></label>
              <label class="small">Var<input id="millingCILPlantFeedGrade_var2" type="text" style="width:100%"
                  placeholder="Var" /></label>
              <label class="small">Outlook (a)<input id="millingCILPlantFeedGrade_outlook" type="text"
                  style="width:100%" placeholder="Outlook (a)" /></label>
              <label class="small">Full Forecast (b)<input id="millingCILPlantFeedGrade_fullForecast" type="text"
                  style="width:100%" placeholder="Full Forecast (b)" /></label>
              <label class="small">Full Budget (c)<input id="millingCILPlantFeedGrade_fullBudget" type="text"
                  style="width:100%" placeholder="Full Budget (c)" /></label>
              <label class="small">Var<input id="millingCILPlantFeedGrade_var3" type="text" style="width:100%"
                  placeholder="Var" /></label>
              <label class="small">Month<input id="millingCILPlantFeedGrade_month" type="text" style="width:100%"
                  placeholder="Month" /></label>
            </div>
            <div class="space"></div>
            <div style="display:flex;gap:8px"><button class="btn"
                id="btnMilling_CILPlantFeedGradeSave">Save</button><button class="btn ghost"
                id="btnMilling_CILPlantFeedGradeClear">Clear</button></div>
          </div>
          <div id="Milling_CIL-tonnes-treated" class="dept-subpanel hidden">
            <h4 style="margin:8px 0">Tonnes Treated</h4>
            <div class="space"></div>
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
              <p style="margin:0"><a href="#" class="small dept-sub-btn" data-dept="Milling_CIL"
                  data-sub="tonnes-treated-form">Add New</a></p>
            </div>
            <table id="tblMilling_CILTonnesTreatedRecords" style="width:auto;border-collapse:collapse">
              <thead>
                <tr>
                  <th>KPI</th>
                  <th>Date</th>
                  <th>Daily Actual</th>
                  <th>Daily Forecast</th>
                  <th>Var</th>
                  <th>MTD Actual</th>
                  <th>MTD Forecast</th>
                  <th>Var</th>
                  <th>Outlook (a)</th>
                  <th>Full Forecast (b)</th>
                  <th>Full Budget (c)</th>
                  <th>Var</th>
                  <th>Month</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="tbodyMilling_CILTonnesTreatedRecords"></tbody>
            </table>
          </div>
          <div id="Milling_CIL-tonnes-treated-form" class="dept-subpanel hidden">
            <h4 style="margin:8px 0">Tonnes Treated</h4>
            <div class="space"></div>
            <div class="vertical-form" style="display:flex;flex-direction:column;gap:8px">
              <label class="small">KPI<input id="millingCILTonnesTreated_kpi" type="text" style="width:100%"
                  placeholder="Tonnes Treated" value="Tonnes Treated" /></label>
              <label class="small">Date<input id="millingCILTonnesTreated_date" type="date"
                  style="width:100%" /></label>
              <label class="small">Daily Actual<input id="millingCILTonnesTreated_daily_actual" type="text"
                  style="width:100%" placeholder="Daily Actual" /></label>
              <label class="small">Daily Forecast<input id="millingCILTonnesTreated_daily_forecast" type="text"
                  style="width:100%" placeholder="Daily Forecast" /></label>
              <label class="small">Var<input id="millingCILTonnesTreated_var1" type="text" style="width:100%"
                  placeholder="Var" /></label>
              <label class="small">MTD Actual<input id="millingCILTonnesTreated_mtd_actual" type="text"
                  style="width:100%" placeholder="MTD Actual" /></label>
              <label class="small">MTD Forecast<input id="millingCILTonnesTreated_mtd_forecast" type="text"
                  style="width:100%" placeholder="MTD Forecast" /></label>
              <label class="small">Var<input id="millingCILTonnesTreated_var2" type="text" style="width:100%"
                  placeholder="Var" /></label>
              <label class="small">Outlook (a)<input id="millingCILTonnesTreated_outlook" type="text" style="width:100%"
                  placeholder="Outlook (a)" /></label>
              <label class="small">Full Forecast (b)<input id="millingCILTonnesTreated_fullForecast" type="text"
                  style="width:100%" placeholder="Full Forecast (b)" /></label>
              <label class="small">Full Budget (c)<input id="millingCILTonnesTreated_fullBudget" type="text"
                  style="width:100%" placeholder="Full Budget (c)" /></label>
              <label class="small">Var<input id="millingCILTonnesTreated_var3" type="text" style="width:100%"
                  placeholder="Var" /></label>
              <label class="small">Month<input id="millingCILTonnesTreated_month" type="text" style="width:100%"
                  placeholder="Month" /></label>
            </div>
            <div class="space"></div>
            <div style="display:flex;gap:8px"><button class="btn"
                id="btnMilling_CILTonnesTreatedSave">Save</button><button class="btn ghost"
                id="btnMilling_CILTonnesTreatedClear">Clear</button></div>
          </div>
        </div>

        <div class="card section hidden" id="dept-OHS" style="margin-top:12px">
          <div id="breadcrumb-OHS" class="breadcrumb hidden"
            style="margin-bottom:12px;padding:8px;background:#f5f5f5;border-radius:4px;display:flex;align-items:center;gap:8px">
            <button class="btn small" id="btnBackOHS" style="padding:4px 8px">← Back</button>
            <span id="breadcrumbTextOHS">OHS — KPI</span>
          </div>
          <h3 style="margin-top:0">OHS — KPI</h3>
          <div class="space"></div>
          <!-- Dashboard: visible to HODs and Admins -->
          <div id="navDashboardOHS" style="display:none;margin-bottom:8px">
            <h4 style="margin:0 0 8px 0;font-size:14px">Status</h4>
            <div style="display:flex;gap:8px;flex-wrap:wrap">
              <div class="pill pending" id="dashPendingOHS"
                style="padding:8px 10px;border-radius:8px;min-width:88px;text-align:center">MTD
                Actual<br><strong>0</strong></div>
              <div class="pill approved" id="dashApprovedOHS"
                style="padding:8px 10px;border-radius:8px;min-width:88px;text-align:center">MTD
                Forecast<br><strong>0</strong></div>
              <div class="pill rejected" id="dashRejectedOHS"
                style="padding:8px 10px;border-radius:8px;min-width:88px;text-align:center">
                Variance<br><strong>0</strong></div>
            </div>
          </div>
          <div id="submenu-nav-OHS"
            style="display:flex;flex-direction:column;gap:8px;align-items:flex-start;margin-bottom:8px">
            <a href="#" class="small dept-sub-btn" data-dept="OHS" data-sub="fixed">Fixed Inputs</a>
            <a href="#" class="small dept-sub-btn" data-dept="OHS" data-sub="safety">Safety Incidents</a>
            <a href="#" class="small dept-sub-btn" data-dept="OHS" data-sub="environmental">Environmental Incidents</a>
            <a href="#" class="small dept-sub-btn" data-dept="OHS" data-sub="property">Property Damage</a>
          </div>
          <div class="space"></div>
          <div id="OHS-fixed" class="dept-subpanel hidden">
            <h4 style="margin:8px 0">Fixed Inputs</h4>
            <div class="space"></div>
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
              <p style="margin:0"><a href="#" class="small dept-sub-btn" data-dept="OHS" data-sub="fixed-form">Add
                  New</a></p>
            </div>
            <table id="tblOHSRecords" style="width:auto;border-collapse:collapse">
              <thead>
                <tr>
                  <th>KPI</th>
                  <th>Month</th>
                  <th>Days</th>
                  <th>Full Forecast</th>
                  <th>Full Budget</th>
                  <th>Created</th>
                  <th></th>
                </tr>
              </thead>
              <tbody id="tbodyOHSRecords"></tbody>
            </table>
          </div>
          <div id="OHS-fixed-form" class="dept-subpanel hidden">
            <h4 style="margin:8px 0">Fixed Inputs</h4>
            <label for="ohsKPI">KPI</label>
            <select id="ohsKPI">
              <option>Safety Incidents</option>
              <option>Environmental Incidents</option>
              <option>Property Damage</option>
            </select>
            <label for="ohsTargetMonth">Target Month</label>
            <input id="ohsTargetMonth" type="month" />
            <label for="ohsNumDays">Number of Days</label>
            <input id="ohsNumDays" type="number" placeholder="Number of days" />
            <label for="ohsFullForecast">Full Forecast</label>
            <input id="ohsFullForecast" type="text" placeholder="Full Forecast" />
            <label for="ohsFullBudget">Full Budget</label>
            <input id="ohsFullBudget" type="text" placeholder="Full Budget" />
            <div class="space"></div>
            <div style="display:flex;gap:8px"><button class="btn" id="btnOHSFixedSave">Save</button><button
                class="btn ghost" id="btnOHSFixedClear">Clear</button></div>
          </div>
          <div id="OHS-safety" class="dept-subpanel hidden">
            <h4 style="margin:8px 0">Safety Incidents</h4>
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
              <p style="margin:0"><a href="#" class="small dept-sub-btn" data-dept="OHS" data-sub="safety-form">Add
                  New</a></p>
            </div>
            <table id="tblOHSSafetyRecords" style="width:auto;border-collapse:collapse">
              <thead>
                <tr>
                  <th>KPI</th>
                  <th>Date</th>
                  <th>Daily Actual</th>
                  <th>Daily Forecast(DF)</th>
                  <th>Var</th>
                  <th>MTD Actual</th>
                  <th>MTD Forecast</th>
                  <th>Var</th>
                  <th>Outlook (a)</th>
                  <th>Full Forecast (b)</th>
                  <th>Full Budget (c)</th>
                  <th>Var</th>
                  <th>Month</th>
                  <th></th>
                </tr>
              </thead>
              <tbody id="tbodyOHSSafetyRecords"></tbody>
            </table>
          </div>
          <div id="OHS-safety-form" class="dept-subpanel hidden">
            <h4 style="margin:8px 0">Safety Incidents</h4>
            <div class="space"></div>
            <div class="vertical-form" style="display:flex;flex-direction:column;gap:8px">
              <label class="small">KPI<input id="ohsSafety_kpi" type="text" style="width:100%"
                  placeholder="Safety Incidents" value="Safety Incidents" /></label>
              <label class="small">Date<input id="ohsSafety_date" type="date" style="width:100%" /></label>
              <label class="small">Daily Actual<input id="ohsSafety_daily_actual" type="text" style="width:100%"
                  placeholder="Daily Actual" /></label>
              <label class="small">Daily Forecast(DF)<input id="ohsSafety_daily_forecast" type="text" style="width:100%"
                  placeholder="Daily Forecast(DF)" readonly /></label>
              <label class="small">Var<input id="ohsSafety_var1" type="text" style="width:100%"
                  placeholder="Var" /></label>
              <label id="ohsSafety_mtd_actual_label" class="small">MTD Actual<input id="ohsSafety_mtd_actual"
                  type="text" style="width:100%" placeholder="" /></label>
              <label id="ohsSafety_mtd_forecast_label" class="small">MTD Forecast<input id="ohsSafety_mtd_forecast"
                  type="text" style="width:100%" placeholder="" value="2" /></label>
              <label class="small">Var<input id="ohsSafety_var2" type="text" style="width:100%"
                  placeholder="Var" /></label>
              <label class="small">Outlook (a)<input id="ohsSafety_outlook" type="text" style="width:100%"
                  placeholder="Outlook (a)" /></label>
              <label class="small">Full Forecast (b)<input id="ohsSafety_fullForecast" type="text" style="width:100%"
                  placeholder="Full Forecast (b)" /></label>
              <label class="small">Full Budget (c)<input id="ohsSafety_fullBudget" type="text" style="width:100%"
                  placeholder="Full Budget (c)" /></label>
              <label class="small">Var<input id="ohsSafety_var3" type="text" style="width:100%"
                  placeholder="Var" /></label>
              <label class="small">Month<input id="ohsSafety_month" type="text" style="width:100%"
                  placeholder="Month" /></label>
            </div>
            <div class="space"></div>
            <div style="display:flex;gap:8px"><button class="btn" id="btnOHSSafetySave">Save</button><button
                class="btn ghost" id="btnOHSSafetyClear">Clear</button></div>
          </div>
          <div id="OHS-environmental" class="dept-subpanel hidden">
            <h4 style="margin:8px 0">Environmental Incidents</h4>
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
              <p style="margin:0"><a href="#" class="small dept-sub-btn" data-dept="OHS"
                  data-sub="environmental-form">Add New</a></p>
            </div>
            <table id="tblOHSEnvironmentalRecords" style="width:auto;border-collapse:collapse">
              <thead>
                <tr>
                  <th>KPI</th>
                  <th>Date</th>
                  <th>Daily Actual</th>
                  <th>Daily Forecast</th>
                  <th>Var</th>
                  <th>MTD Actual</th>
                  <th>MTD Forecast</th>
                  <th>Var</th>
                  <th>Outlook (a)</th>
                  <th>Full Forecast (b)</th>
                  <th>Full Budget (c)</th>
                  <th>Var</th>
                  <th>Month</th>
                  <th></th>
                </tr>
              </thead>
              <tbody id="tbodyOHSEnvironmentalRecords"></tbody>
            </table>
          </div>
          <div id="OHS-environmental-form" class="dept-subpanel hidden">
            <h4 style="margin:8px 0">Environmental Incidents</h4>
            <div class="space"></div>
            <div class="vertical-form" style="display:flex;flex-direction:column;gap:8px">
              <label class="small">KPI<input id="ohsEnvironmental_kpi" type="text" style="width:100%"
                  placeholder="Environmental Incidents" value="Environmental Incidents" /></label>
              <label class="small">Date<input id="ohsEnvironmental_date" type="date" style="width:100%" /></label>
              <label class="small">Daily Actual<input id="ohsEnvironmental_daily_actual" type="text" style="width:100%"
                  placeholder="Daily Actual" /></label>
              <label class="small">Daily Forecast<input id="ohsEnvironmental_daily_forecast" type="text"
                  style="width:100%" placeholder="Daily Forecast" readonly /></label>
              <label class="small">Var<input id="ohsEnvironmental_var1" type="text" style="width:100%"
                  placeholder="Var" /></label>
              <label class="small">MTD Actual<input id="ohsEnvironmental_mtd_actual" type="text" style="width:100%"
                  placeholder="MTD Actual" /></label>
              <label class="small">MTD Forecast<input id="ohsEnvironmental_mtd_forecast" type="text" style="width:100%"
                  placeholder="MTD Forecast" /></label>
              <label class="small">Var<input id="ohsEnvironmental_var2" type="text" style="width:100%"
                  placeholder="Var" /></label>
              <label class="small">Outlook (a)<input id="ohsEnvironmental_outlook" type="text" style="width:100%"
                  placeholder="Outlook (a)" /></label>
              <label class="small">Full Forecast (b)<input id="ohsEnvironmental_fullForecast" type="text"
                  style="width:100%" placeholder="Full Forecast (b)" /></label>
              <label class="small">Full Budget (c)<input id="ohsEnvironmental_fullBudget" type="text" style="width:100%"
                  placeholder="Full Budget (c)" /></label>
              <label class="small">Var<input id="ohsEnvironmental_var3" type="text" style="width:100%"
                  placeholder="Var" /></label>
              <label class="small">Month<input id="ohsEnvironmental_month" type="text" style="width:100%"
                  placeholder="Month" /></label>
            </div>
            <div class="space"></div>
            <div style="display:flex;gap:8px"><button class="btn" id="btnOHSEnvironmentalSave">Save</button><button
                class="btn ghost" id="btnOHSEnvironmentalClear">Clear</button></div>
          </div>
          <div id="OHS-property" class="dept-subpanel hidden">
            <h4 style="margin:8px 0">Property Damage</h4>
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
              <p style="margin:0"><a href="#" class="small dept-sub-btn" data-dept="OHS" data-sub="property-form">Add
                  New</a></p>
            </div>
            <table id="tblOHSPropertyRecords" style="width:auto;border-collapse:collapse">
              <thead>
                <tr>
                  <th>KPI</th>
                  <th>Date</th>
                  <th>Daily Actual</th>
                  <th>Daily Forecast</th>
                  <th>Var</th>
                  <th>MTD Actual</th>
                  <th>MTD Forecast</th>
                  <th>Var</th>
                  <th>Outlook (a)</th>
                  <th>Full Forecast (b)</th>
                  <th>Full Budget (c)</th>
                  <th>Var</th>
                  <th>Month</th>
                  <th></th>
                </tr>
              </thead>
              <tbody id="tbodyOHSPropertyRecords"></tbody>
            </table>
            <div class="space"></div>
          </div>
          <div id="OHS-property-form" class="dept-subpanel hidden">
            <h4 style="margin:8px 0">Property Damage</h4>
            <div class="space"></div>
            <div class="vertical-form" style="display:flex;flex-direction:column;gap:8px">
              <label class="small">KPI<input id="ohsProperty_kpi" type="text" style="width:100%"
                  placeholder="Property Damage" value="Property Damage" /></label>
              <label class="small">Date<input id="ohsProperty_date" type="date" style="width:100%" /></label>
              <label class="small">Daily Actual<input id="ohsProperty_daily_actual" type="text" style="width:100%"
                  placeholder="Daily Actual" /></label>
              <label class="small">Daily Forecast<input id="ohsProperty_daily_forecast" type="text" style="width:100%"
                  placeholder="Daily Forecast" /></label>
              <label class="small">Var<input id="ohsProperty_var1" type="text" style="width:100%"
                  placeholder="Var" /></label>
              <label class="small">MTD Actual<input id="ohsProperty_mtd_actual" type="text" style="width:100%"
                  placeholder="MTD Actual" /></label>
              <label class="small">MTD Forecast<input id="ohsProperty_mtd_forecast" type="text" style="width:100%"
                  placeholder="MTD Forecast" /></label>
              <label class="small">Var<input id="ohsProperty_var2" type="text" style="width:100%"
                  placeholder="Var" /></label>
              <label class="small">Outlook (a)<input id="ohsProperty_outlook" type="text" style="width:100%"
                  placeholder="Outlook (a)" /></label>
              <label class="small">Full Forecast<input id="ohsProperty_fullForecast" type="text" style="width:100%"
                  placeholder="Full Forecast" /></label>
              <label class="small">Full Budget (c)<input id="ohsProperty_fullBudget" type="text" style="width:100%"
                  placeholder="Full Budget (c)" /></label>
              <label class="small">Var<input id="ohsProperty_var3" type="text" style="width:100%"
                  placeholder="Var" /></label>
              <label class="small">Month<input id="ohsProperty_month" type="text" style="width:100%"
                  placeholder="Month" /></label>
            </div>
            <div class="space"></div>
            <div style="display:flex;gap:8px"><button class="btn" id="btnOHSPropertySave">Save</button><button
                class="btn ghost" id="btnOHSPropertyClear">Clear</button></div>
          </div>
        </div>

        <div class="card section hidden" id="dept-GM" style="margin-top:12px">
          <h3 style="margin-top:0">GM Report</h3>
          <div class="space"></div>
          <p>GM Report - Summary of all departments (to be implemented)</p>
        </div>

        <!-- Other departments: same placeholders for now (fillable later) -->
        <div class="card section hidden" id="dept-Mining" style="margin-top:12px">
          <h3 style="margin-top:0">Mining — KPI (placeholders)</h3>
          <div class="space"></div>
          <p class="small muted">Placeholders for Mining. Fields will match Geology when provided.</p>
        </div>
        <div class="card section hidden" id="dept-Milling_CIL" style="margin-top:12px">
          <h3 style="margin-top:0">Milling_CIL — KPI (placeholders)</h3>
          <div class="space"></div>
          <p class="small muted">Placeholders for Milling_CIL. Fields will match Geology when provided.</p>
        </div>
        <div class="card section hidden" id="dept-Crushing" style="margin-top:12px">
          <div id="breadcrumb-Crushing" class="breadcrumb hidden"
            style="margin-bottom:12px;padding:8px;background:#f5f5f5;border-radius:4px;display:flex;align-items:center;gap:8px">
            <button class="btn small" id="btnBackCrushing" style="padding:4px 8px">← Back</button>
            <span id="breadcrumbTextCrushing">Crushing — KPI</span>
          </div>
          <h3 style="margin-top:0">Crushing — KPI</h3>
          <div class="space"></div>
          <!-- Dashboard: visible to HODs and Admins -->
          <div id="navDashboardCrushing" style="display:none;margin-bottom:8px">
            <h4 style="margin:0 0 8px 0;font-size:14px">Status</h4>
            <div style="display:flex;gap:8px;flex-wrap:wrap">
              <div class="pill pending" id="dashPendingCrushing"
                style="padding:8px 10px;border-radius:8px;min-width:88px;text-align:center">MTD
                Actual<br><strong>0</strong></div>
              <div class="pill approved" id="dashApprovedCrushing"
                style="padding:8px 10px;border-radius:8px;min-width:88px;text-align:center">MTD
                Forecast<br><strong>0</strong></div>
              <div class="pill rejected" id="dashRejectedCrushing"
                style="padding:8px 10px;border-radius:8px;min-width:88px;text-align:center">
                Variance<br><strong>0</strong></div>
            </div>
          </div>
          <div id="submenu-nav-Crushing"
            style="display:flex;flex-direction:column;gap:8px;align-items:flex-start;margin-bottom:8px">
            <a href="#" class="small dept-sub-btn" data-dept="Crushing" data-sub="records">Fixed Inputs</a>
            <a href="#" class="small dept-sub-btn" data-dept="Crushing" data-sub="grade-records">Grade - Ore Crushed</a>
            <a href="#" class="small dept-sub-btn" data-dept="Crushing" data-sub="ore-records">Ore crushed</a>
          </div>
          <div class="space"></div>
          <div id="Crushing-fixed" class="dept-subpanel hidden">
            <h4 style="margin:8px 0">Fixed Input (Crushing)</h4>
            <label for="crushKPI">KPI</label>
            <select id="crushKPI">
              <option>Grade - Ore Crushed</option>
              <option>Ore Crushed</option>
            </select>
            <label for="crushTargetMonth">Target Month</label>
            <input id="crushTargetMonth" type="month" />
            <label for="crushNumDays">Number of Days</label>
            <input id="crushNumDays" type="number" placeholder="Number of days" />
            <label for="crushFullForecast">Full Forecast</label>
            <input id="crushFullForecast" type="text" placeholder="Full Forecast" />
            <label for="crushFullBudget">Full Budget</label>
            <input id="crushFullBudget" type="text" placeholder="Full Budget" />
            <div class="space"></div>
            <div style="display:flex;gap:8px"><button class="btn" id="btnCrushSave">Save</button><button
                class="btn ghost" id="btnCrushClear">Clear</button></div>
          </div>
          <div id="Crushing-records" class="dept-subpanel hidden">
            <h4 style="margin:8px 0">Fixed Inputs</h4>
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
              <div class="pill" id="varianceCrushingFixed" style="padding:8px 12px;border-radius:4px">Total Variance:
                <strong>0</strong></div>
              <p style="margin:0"><a href="#" class="small dept-sub-btn" data-dept="Crushing" data-sub="fixed">Add
                  New</a></p>
            </div>
            <table id="tblCrushingRecords" style="width:auto;border-collapse:collapse">
              <thead>
                <tr>
                  <th>KPI</th>
                  <th>Month</th>
                  <th>Days</th>
                  <th>Full Forecast</th>
                  <th>Full Budget</th>
                  <th>Created</th>
                  <th></th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
            <div class="space"></div>
          </div>
          <div id="Crushing-grade-records" class="dept-subpanel hidden">
            <h4 style="margin:8px 0">Grade - Ore Crushed</h4>
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
              <p style="margin:0"><a href="#" class="small dept-sub-btn" data-dept="Crushing" data-sub="grade">Add
                  New</a></p>
            </div>
            <table id="tblCrushingGradeRecords" style="width:auto;border-collapse:collapse">
              <thead>
                <tr>
                  <th>KPI</th>
                  <th>Date</th>
                  <th>Daily Actual (t)</th>
                  <th>Daily Actual</th>
                  <th>Daily Forecast</th>
                  <th>Var</th>
                  <th>MTD Actual</th>
                  <th>MTD Forecast</th>
                  <th>Var</th>
                  <th>Outlook (a)</th>
                  <th>Full Forecast (b)</th>
                  <th>Full Budget (c)</th>
                  <th>Var</th>
                  <th>Month</th>
                  <th></th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
            <div class="space"></div>
          </div>
          <div id="Crushing-ore-records" class="dept-subpanel hidden">
            <h4 style="margin:8px 0">Ore crushed</h4>
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
              <p style="margin:0"><a href="#" class="small dept-sub-btn" data-dept="Crushing" data-sub="ore">Add New</a>
              </p>
            </div>
            <table id="tblCrushingOreRecords" style="width:auto;border-collapse:collapse">
              <thead>
                <tr>
                  <th>KPI</th>
                  <th>Date</th>
                  <th>Daily Actual</th>
                  <th>Daily Forecast</th>
                  <th>Var</th>
                  <th>MTD Actual</th>
                  <th>MTD Forecast</th>
                  <th>Var</th>
                  <th>Outlook (a)</th>
                  <th>Full Forecast (b)</th>
                  <th>Full Budget (c)</th>
                  <th>Var</th>
                  <th>Month</th>
                  <th></th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
            <div class="space"></div>
          </div>
          <div id="Crushing-grade" class="dept-subpanel hidden">
            <h4 style="margin:8px 0">Grade — Ore Crushed</h4>
            <div class="space"></div>
            <div class="vertical-form" style="display:flex;flex-direction:column;gap:8px">
              <label class="small">KPI<input id="crushGrade_kpi" type="text" style="width:100%"
                  placeholder="Grade - Ore Crushed" /></label>
              <label class="small">Date<input id="crushGrade_date" type="date" style="width:100%" /></label>
              <label class="small">Daily Actual (t)<input id="crushGrade_daily_t" type="text" style="width:100%"
                  placeholder="Daily Actual (t)" /></label>
              <label class="small">Daily Actual<input id="crushGrade_daily_actual" type="text" style="width:100%"
                  placeholder="Daily Actual" /></label>
              <label class="small">Daily Forecast<input id="crushGrade_daily_forecast" type="text" style="width:100%"
                  placeholder="Daily Forecast" /></label>
              <label class="small">Var<input id="crushGrade_var1" type="text" style="width:100%"
                  placeholder="Var" /></label>
              <label class="small">MTD Actual<input id="crushGrade_mtd_actual" type="text" style="width:100%"
                  placeholder="Outlook (a)" /></label>
              <label class="small">MTD Forecast<input id="crushGrade_mtd_forecast" type="text" style="width:100%"
                  placeholder="MTD Forecast" /></label>
              <label class="small">Var<input id="crushGrade_var2" type="text" style="width:100%"
                  placeholder="Var" /></label>
              <label class="small">Outlook (a)<input id="crushGrade_outlook" type="text" style="width:100%"
                  placeholder="Outlook (a)" /></label>
              <label class="small">Full Forecast (b)<input id="crushGrade_fullForecast" type="text" style="width:100%"
                  placeholder="Full Forecast (b)" /></label>
              <label class="small">Full Budget (c)<input id="crushGrade_fullBudget" type="text" style="width:100%"
                  placeholder="Full Budget (c)" /></label>
              <label class="small">Var<input id="crushGrade_var3" type="text" style="width:100%"
                  placeholder="Var" /></label>
              <label class="small">Month<input id="crushGrade_month" type="text" style="width:100%"
                  placeholder="Month (YYYY-MM)" /></label>
            </div>
            <div class="space"></div>
            <div style="display:flex;gap:8px"><button class="btn" id="btnCrushingGradeSave">Save</button><button
                class="btn ghost" id="btnCrushingGradeClear">Clear</button></div>
          </div>
          <div id="Crushing-ore" class="dept-subpanel hidden">
            <h4 style="margin:8px 0">Ore Crushed</h4>
            <div class="space"></div>
            <div class="vertical-form" style="display:flex;flex-direction:column;gap:8px">
              <label class="small">KPI<input id="crushOre_kpi" type="text" style="width:100%"
                  placeholder="Ore Crushed" /></label>
              <label class="small">Date<input id="crushOre_date" type="date" style="width:100%" /></label>
              <label class="small">Daily Actual<input id="crushOre_daily_actual" type="text" style="width:100%"
                  placeholder="Daily Actual" /></label>
              <label class="small">Daily Forecast<input id="crushOre_daily_forecast" type="text" style="width:100%"
                  placeholder="Daily Forecast" /></label>
              <label class="small">Var<input id="crushOre_var1" type="text" style="width:100%"
                  placeholder="Var" /></label>
              <label class="small">MTD Actual<input id="crushOre_mtd_actual" type="text" style="width:100%"
                  placeholder="MTD Actual" /></label>
              <label class="small">MTD Forecast<input id="crushOre_mtd_forecast" type="text" style="width:100%"
                  placeholder="MTD Forecast" /></label>
              <label class="small">Var<input id="crushOre_var2" type="text" style="width:100%"
                  placeholder="Var" /></label>
              <label class="small">Outlook (a)<input id="crushOre_outlook" type="text" style="width:100%"
                  placeholder="Outlook (a)" /></label>
              <label class="small">Full Forecast (b)<input id="crushOre_fullForecast" type="text" style="width:100%"
                  placeholder="Full Forecast (b)" /></label>
              <label class="small">Full Budget (c)<input id="crushOre_fullBudget" type="text" style="width:100%"
                  placeholder="Full Budget (c)" /></label>
              <label class="small">Var<input id="crushOre_var3" type="text" style="width:100%"
                  placeholder="Var" /></label>
              <label class="small">Month<input id="crushOre_month" type="text" style="width:100%"
                  placeholder="Month" /></label>
            </div>
            <div class="space"></div>
            <div style="display:flex;gap:8px"><button class="btn" id="btnCrushingOreSave">Save</button><button
                class="btn ghost" id="btnCrushingOreClear">Clear</button></div>
          </div>
        </div>
      </div>

      <div class="card section hidden" id="dept-Engineering" style="margin-top:12px">
        <h3 style="margin-top:0">Engineering — KPI (placeholders)</h3>
        <div class="space"></div>
        <p class="small muted">Placeholders for Engineering. Fields will match Geology when provided.</p>
      </div>
    </div>
  </div>

  <footer>
    <!--This demo stores data in localStorage under key <code>leave_demo_data</code>. Open DevTools to inspect.-->
  </footer>
  </div>

  <input id="fileInput" type="file" accept="application/json" style="display:none" />

  <div id="loginModal" class="card" style="position:fixed;right:24px;top:80px;width:320px;z-index:1200">
    <h3 style="margin-top:0">Login</h3>
    <div class="space"></div>
    <label for="loginUser">Username (Employee ID)</label>
    <input id="loginUser" type="text" />
    <label for="loginPass">Password</label>
    <input id="loginPass" type="password" />
    <div class="space"></div>
    <div style="display:flex;gap:8px">
      <button class="btn" id="btnLoginSubmit">Sign in</button>
      <button class="btn ghost" id="btnLoginCancel" onclick="closeLogin()">Cancel</button>
      <button class="btn ghost" id="btnForgot" onclick="closeLogin(); openReset();">Forgot?</button>
      <button class="btn ghost" id="btnLogout" style="margin-left:auto;display:none">Logout</button>
    </div>
  </div>

  <div id="resetModal" class="card hidden" style="position:fixed;right:24px;top:80px;width:360px;z-index:1200">
    <h3 style="margin-top:0">Reset Password</h3>
    <div class="space"></div>
    <label for="resetUser">Employee ID</label>
    <input id="resetUser" type="text" />
    <label for="resetName">Full name (for verification)</label>
    <input id="resetName" type="text" />
    <label for="resetPass">New Password</label>
    <input id="resetPass" type="password" />
    <label for="resetPass2">Confirm Password</label>
    <input id="resetPass2" type="password" />
    <div class="space"></div>
    <div style="display:flex;gap:8px">
      <button class="btn" id="btnResetSubmit">Set password</button>
      <button class="btn ghost" id="btnResetCancel">Cancel</button>
    </div>
  </div>

  <script>
    (function () {
      console.log('KPI script start');
      const KEY = 'leave_demo_data';
      let state = { employees: {}, leave_requests: [], public_holidays: [], audit_log: [] };

      function save() { localStorage.setItem(KEY, JSON.stringify(state)); }
      function load() {
        const raw = localStorage.getItem(KEY);
        if (!raw) return;
        try { state = JSON.parse(raw); } catch (e) { console.warn('invalid json'); }
      }

      function daysBetween(a, b) {
        const s = new Date(a), e = new Date(b);
        if (isNaN(s) || isNaN(e) || e < s) return 0;
        let count = 0;
        for (let dt = new Date(s); dt <= e; dt.setDate(dt.getDate() + 1)) {
          const d = dt.getDay(); // 0 = Sunday, 6 = Saturday
          const dtStr = dt.toISOString().slice(0, 10);
          const isHoliday = Array.isArray(state.public_holidays) && state.public_holidays.some(h => (typeof h === 'string' ? h === dtStr : (h && h.date) === dtStr));
          if (d !== 0 && d !== 6 && !isHoliday) count++;
        }
        return count;
      }

      // compute accrued days for an employee up to a date (inclusive)
      // accrual: +2.5 days on the 28th of every month; only count accruals where the 28th is >= date_joined and <= uptoDate
      function computeAccrued(emp, uptoDate) {
        if (!emp || !emp.date_joined) return 0;
        const join = new Date(emp.date_joined);
        const upto = uptoDate ? new Date(uptoDate) : new Date();
        if (isNaN(join) || isNaN(upto) || upto < join) return 0;
        let total = 0;
        // iterate month by month starting at join month
        let cur = new Date(join.getFullYear(), join.getMonth(), 1);
        // stop when cur's month/year is beyond upto
        while (true) {
          const accrual = new Date(cur.getFullYear(), cur.getMonth(), 28);
          if (accrual >= join && accrual <= upto) total += 2.5;
          // advance month
          cur.setMonth(cur.getMonth() + 1);
          // break if accrual for new month would be after upto and current month start is after upto
          if (new Date(cur.getFullYear(), cur.getMonth(), 28) > upto) break;
        }
        // handle case where the loop didn't count any but the first month's 28th could be <= upto
        // (above loop counts months until next month's 28th > upto, so we should be correct)
        return Number(total.toFixed(2));
      }

      // Auto date/day helpers: when user enters number of days, compute end date (business days)
      function updateEndDateFromDays() {
        if (!elements || !elements.startDate || !elements.leaveDays || !elements.endDate) return;
        const start = elements.startDate.value; const days = Number(elements.leaveDays.value);
        if (!start || !days || days <= 0) return;
        // find smallest end date such that daysBetween(start, end) === days
        let end = new Date(start);
        let count = daysBetween(start, end);
        const maxIter = 365 * 3; let iter = 0;
        while (count < days && iter < maxIter) { end.setDate(end.getDate() + 1); count = daysBetween(start, end); iter++; }
        elements.endDate.value = end.toISOString().slice(0, 10);
      }

      function updateDaysFromEndDate() {
        if (!elements || !elements.startDate || !elements.leaveDays || !elements.endDate) return;
        const s = elements.startDate.value; const e = elements.endDate.value; if (!s || !e) return;
        const d = daysBetween(s, e);
        elements.leaveDays.value = d;
      }

      // UI helpers
      const elements = {
        empId: document.getElementById('empId'), empName: document.getElementById('empName'), empDept: document.getElementById('empDept'), empRole: document.getElementById('empRole'),
        btnAddEmp: document.getElementById('btnAddEmp'), leaveEmp: document.getElementById('leaveEmp'), startDate: document.getElementById('startDate'),
        endDate: document.getElementById('endDate'), leaveType: document.getElementById('leaveType'), leaveDays: document.getElementById('leaveDays'), btnApply: document.getElementById('btnApply'),
        tblEmployees: document.querySelector('#tblEmployees tbody'), tblRequests: document.querySelector('#tblRequests tbody'), empCount: document.getElementById('empCount'), reqCount: document.getElementById('reqCount'),
        btnExport: document.getElementById('btnExport'), btnImport: document.getElementById('btnImport'), fileInput: document.getElementById('fileInput'), currentUser: document.getElementById('currentUser'), btnLoginToggle: document.getElementById('btnLoginToggle'),
        holidayDate: document.getElementById('holidayDate'), holidayLabel: document.getElementById('holidayLabel'), btnAddHoliday: document.getElementById('btnAddHoliday'), tblHolidays: document.querySelector('#tblHolidays tbody'),
        adminView: document.getElementById('adminView'), adminToggleLabel: document.getElementById('adminToggleLabel'),
        loginModal: document.getElementById('loginModal'), loginUser: document.getElementById('loginUser'), loginPass: document.getElementById('loginPass'), btnLoginSubmit: document.getElementById('btnLoginSubmit'), btnLoginCancel: document.getElementById('btnLoginCancel'), btnLogout: document.getElementById('btnLogout'), empPassword: document.getElementById('empPassword'), btnForgot: document.getElementById('btnForgot'), btnHeaderForgot: document.getElementById('btnHeaderForgot'),
        resetModal: document.getElementById('resetModal'), resetUser: document.getElementById('resetUser'), resetName: document.getElementById('resetName'), resetPass: document.getElementById('resetPass'), resetPass2: document.getElementById('resetPass2'), btnResetSubmit: document.getElementById('btnResetSubmit'), btnResetCancel: document.getElementById('btnResetCancel')
      };

      console.log('Login elements:', document.getElementById('btnLoginSubmit'), document.getElementById('btnLoginCancel'), document.getElementById('btnForgot'));

      // report elements (date-range extraction and chart)
      elements.reportStart = document.getElementById('reportStart');
      elements.reportEnd = document.getElementById('reportEnd');
      elements.btnExtractReport = document.getElementById('btnExtractReport');
      elements.btnClearReport = document.getElementById('btnClearReport');
      elements.reportChart = document.getElementById('reportChart');

      function renderEmployees() {
        if (!elements.tblEmployees) return; // nothing to render
        elements.tblEmployees.innerHTML = '';
        if (elements.leaveEmp) elements.leaveEmp.innerHTML = '<option value="">— choose —</option>';
        // preserve currently signed-in user and disabled state so repopulating doesn't clear login
        const prevUser = elements.currentUser ? elements.currentUser.value : '';
        const prevDisabled = elements.currentUser ? elements.currentUser.disabled : false;
        if (elements.currentUser) elements.currentUser.innerHTML = '<option value="">— none —</option>';
        const keys = Object.keys(state.employees);
        const curSel = prevUser;
        const curRole = curSel && state.employees[curSel] ? state.employees[curSel].role : '';
        elements.empCount.textContent = keys.length + (keys.length === 1 ? ' employee' : ' employees');
        keys.forEach(id => {
          const emp = state.employees[id];
          const tr = document.createElement('tr');
          const actionsHtml = (curRole === 'Admin') ? `<div style='display:flex; gap:8px'><button class='btn ghost' data-edit-id='${id}' title='Edit'><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 113 3L7 19l-4 1 1-4L16.5 3.5z"/></svg></button><button class='btn ghost' data-id='${id}' title='Remove'><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/><path d="M10 11v6"/><path d="M14 11v6"/><path d="M9 6V4a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v2"/></svg></button></div>` : '';
          tr.innerHTML = `<td>${id}</td><td>${emp.name}</td><td>${emp.department}</td><td>${emp.role || 'Employee'}</td><td>${actionsHtml}</td>`;
          elements.tblEmployees.appendChild(tr);

          if (elements.leaveEmp) { const opt = document.createElement('option'); opt.value = id; opt.textContent = emp.name; elements.leaveEmp.appendChild(opt); }
          if (elements.currentUser) { const cu = document.createElement('option'); cu.value = id; cu.textContent = id + ' — ' + emp.name + ' (' + (emp.role || 'Employee') + ')'; elements.currentUser.appendChild(cu); }
        });
        // restore previously selected user (if still present)
        if (elements.currentUser) {
          if (prevUser && Array.from(elements.currentUser.options).some(o => o.value === prevUser)) {
            elements.currentUser.value = prevUser;
            // restore disabled state
            elements.currentUser.disabled = !!prevDisabled;
            elements.currentUser.dispatchEvent(new Event('change'));
          }
          else {
            // ensure admin toggle hidden when no user
            updateAdminToggle();
            elements.currentUser.disabled = false;
          }
        }
        // update nav access (Add Employee link) after employee list rebuild
        updateNavAccess();
      }

      function renderRequests() {
        if (!elements.tblRequests) return; // requests UI removed
        elements.tblRequests.innerHTML = '';
        const currentId = elements.currentUser ? elements.currentUser.value : '';
        const rawRole = currentId && state.employees[currentId] ? state.employees[currentId].role : undefined;
        const currentRole = rawRole || 'Employee';
        const adminActive = elements.adminView && elements.adminView.checked;
        // If signed in as an Employee (explicit or missing role), show only their own requests.
        // HODs, Admins, or when adminActive is checked see all requests.
        const isEmployeeView = currentId && currentRole === 'Employee' && !adminActive;
        const list = isEmployeeView ? state.leave_requests.filter(r => r.emp_id === currentId) : state.leave_requests;
        elements.reqCount.textContent = list.length + ' requests';
        list.forEach((r) => {
          const tr = document.createElement('tr');
          const statusClass = r.status.toLowerCase();
          tr.innerHTML = `<td>${r.name} (${r.emp_id})</td><td>${r.start_date} → ${r.end_date}</td><td>${r.days}</td><td>${r.leave_type}</td><td><span class='pill ${statusClass}'>${r.status}</span></td><td></td>`;
          const actions = tr.querySelector('td:last-child');
          if (r.status === 'Pending') {
            // allow action if adminActive or currentRole is Admin, or HOD of same department
            const canAct = adminActive || currentRole === 'Admin' || (currentId && state.employees[currentId] && state.employees[currentId].role === 'HOD' && state.employees[currentId].department === state.employees[r.emp_id].department);
            if (canAct) {
              const ap = document.createElement('button'); ap.className = 'btn'; ap.textContent = 'Approve'; ap.onclick = () => { approve(state.leave_requests.indexOf(r)); };
              const rj = document.createElement('button'); rj.className = 'btn ghost'; rj.style.marginLeft = '8px'; rj.textContent = 'Reject'; rj.onclick = () => { reject(state.leave_requests.indexOf(r)); };
              actions.appendChild(ap); actions.appendChild(rj);
            }
          }
          elements.tblRequests.appendChild(tr);
        });
      }

      function renderHolidays() {
        if (!elements.tblHolidays) return;
        elements.tblHolidays.innerHTML = '';
        const list = Array.isArray(state.public_holidays) ? state.public_holidays : [];
        const cur = elements.currentUser ? elements.currentUser.value : '';
        const curRole = cur && state.employees[cur] ? state.employees[cur].role : '';
        list.forEach((h, i) => {
          const date = (typeof h === 'string') ? h : (h && h.date) || '';
          const label = (typeof h === 'string') ? '' : (h && h.label) || '';
          const tr = document.createElement('tr');
          const actionsHtml = (curRole === 'Admin') ? `<button class='btn ghost' data-hid='${i}'>Remove</button>` : '';
          tr.innerHTML = `<td>${date}</td><td>${label}</td><td>${actionsHtml}</td>`;
          elements.tblHolidays.appendChild(tr);
        });
      }

      // Dashboard: compute and render counts for Pending/Approved/Rejected
      function renderDashboard() {
        const dash = document.getElementById('navDashboard');
        const elPending = document.getElementById('dashPending');
        const elApproved = document.getElementById('dashApproved');
        const elRejected = document.getElementById('dashRejected');
        // Also get all duplicated elements for display
        const allDash = document.querySelectorAll('[id^="navDashboard"]');
        if (!dash || !elPending || !elApproved || !elRejected) return;
        const cur = elements.currentUser ? elements.currentUser.value : '';
        const role = cur && state.employees[cur] ? state.employees[cur].role : '';
        // determine which requests to count: Admin -> all, HOD -> same department, else -> none (hide)
        let list = [];
        if (role === 'Admin') {
          list = state.leave_requests || [];
          allDash.forEach(d => d.style.display = '');
        } else if (role === 'HOD') {
          const dept = state.employees[cur] ? state.employees[cur].department : null;
          list = (state.leave_requests || []).filter(r => state.employees[r.emp_id] && state.employees[r.emp_id].department === dept);
          allDash.forEach(d => d.style.display = '');
        } else {
          allDash.forEach(d => d.style.display = '');
        }
        // Reset dashboard results to 0 (MTD Actual / MTD Forecast / Variance) - only for main dashboard
        elPending.querySelector('strong').textContent = 0;
        elApproved.querySelector('strong').textContent = 0;
        elRejected.querySelector('strong').textContent = 0;
      }

      // addHoliday removed per request

      function updateAdminToggle() {
        if (!elements.adminToggleLabel) return;
        const cur = elements.currentUser ? elements.currentUser.value : '';
        const role = cur && state.employees[cur] ? state.employees[cur].role : '';
        const empCard = document.getElementById('employeeDirectoryCard');
        if (role === 'Admin') {
          elements.adminToggleLabel.style.display = 'flex';
        } else {
          elements.adminToggleLabel.style.display = 'none';
          if (elements.adminView) elements.adminView.checked = false;
        }
        // Show Employee Directory to all roles (Admin/HOD/Employee) so departments are accessible.
        if (empCard) {
          empCard.style.display = '';
        }
        // Ensure Departments dashboard is visible after login (not treated as a toggle section)
        try { const deptCard = document.getElementById('departmentsCard'); if (deptCard) deptCard.classList.remove('hidden'); } catch (e) { }
      }

      function updateNavAccess() {
        // hide Add Employee nav link unless signed-in user is Admin
        const addLink = document.querySelector('.nav-link[data-target="addEmployee"]');
        if (!addLink) return;
        const cur = elements.currentUser ? elements.currentUser.value : '';
        const role = cur && state.employees[cur] ? state.employees[cur].role : '';
        if (role === 'Admin') addLink.style.display = '';
        else addLink.style.display = 'none';
        // show Report link only to Admin or HOD
        const reportLink = document.querySelector('.nav-link[data-target="report"]');
        if (reportLink) {
          if (role === 'Admin' || role === 'HOD') reportLink.style.display = '';
          else reportLink.style.display = 'none';
        }
        // show/hide the Report card itself (restrict UI surface for Employees)
        const reportCard = document.getElementById('reportCard');
        if (reportCard) {
          if (role === 'Admin' || role === 'HOD') reportCard.style.display = '';
          else reportCard.style.display = 'none';
        }
      }

      function addEmployee() {
        // enforce that only Admin (signed-in) can add employees
        const currentId = elements.currentUser ? elements.currentUser.value : '';
        const currentRole = currentId && state.employees[currentId] ? state.employees[currentId].role : undefined;
        if (currentRole !== 'Admin') { alert('Only Admin users can add employees'); return; }
        const id = elements.empId.value.trim(); const name = elements.empName.value.trim(); const dept = elements.empDept.value.trim(); const role = elements.empRole ? elements.empRole.value : 'Employee'; const password = elements.empPassword ? elements.empPassword.value : '';
        if (!id || !name) { alert('Please provide ID and name'); return; }
        if (state.employees[id]) { alert('Employee exists'); return; }
        state.employees[id] = { name, department: dept || '—', role: role || 'Employee', password: password || undefined, annual_leave: 20, sick_leave: 10, leaves_used: 0, date_joined: (new Date()).toISOString().slice(0, 10) };
        save(); renderEmployees(); clearAddForm();
      }
      function clearAddForm() { elements.empId.value = ''; elements.empName.value = ''; elements.empDept.value = ''; if (elements.empRole) elements.empRole.value = 'Employee'; if (elements.empPassword) elements.empPassword.value = ''; }

      function editRole(id) {
        const currentId = elements.currentUser ? elements.currentUser.value : '';
        const currentRole = currentId && state.employees[currentId] ? state.employees[currentId].role : '';
        if (currentRole !== 'Admin') { alert('Only Admin users can change roles'); return; }
        const emp = state.employees[id]; if (!emp) { alert('Employee not found'); return; }
        const newRole = prompt('Set role for ' + id + ' (Employee, HOD, Admin):', emp.role || 'Employee');
        if (!newRole) return;
        const nr = newRole.trim(); const valid = ['Employee', 'HOD', 'Admin'];
        if (!valid.includes(nr)) { alert('Invalid role'); return; }
        emp.role = nr; save(); renderEmployees(); renderRequests(); updateAdminToggle(); alert('Role updated for ' + id);
      }

      // applyLeave removed per request

      // extractReport retained but drawing removed; now logs aggregated counts only
      function extractReport() {
        const curUser = elements.currentUser ? elements.currentUser.value : '';
        const curRole = curUser && state.employees[curUser] ? state.employees[curUser].role : 'Employee';
        if (curRole !== 'Admin' && curRole !== 'HOD') { alert('Access denied: reports are only available to HODs and Admins'); return; }
        if (!elements.reportStart || !elements.reportEnd) return;
        const s = elements.reportStart.value; const e = elements.reportEnd.value;
        if (!s || !e) { alert('Choose start and end dates'); return; }
        if (e < s) { alert('End date must be same or after start date'); return; }
        const counts = new Array(12).fill(0);
        const rangeStart = new Date(s); const rangeEnd = new Date(e);
        (state.leave_requests || []).forEach(r => {
          if (!r.start_date || !r.end_date) return;
          const rs = new Date(r.start_date); const re = new Date(r.end_date);
          const os = rs < rangeStart ? new Date(rangeStart) : new Date(rs);
          const oe = re > rangeEnd ? new Date(rangeEnd) : new Date(re);
          if (oe < os) return;
          for (let d = new Date(os); d <= oe; d.setDate(d.getDate() + 1)) {
            counts[d.getMonth()] += 1;
          }
        });
        console.log('Report counts by month (0=Jan):', counts);
        // report drawing intentionally removed
      }

      // clearReport removed per request

      // drawLineChart removed per request

      // Audit helper: records actions (approve/reject) into state.audit_log
      function addAudit(entry) {
        if (!state.audit_log) state.audit_log = [];
        const e = Object.assign({ timestamp: (new Date()).toISOString() }, entry || {});
        state.audit_log.push(e);
        save();
      }

      // KPI records storage: initialize container
      if (!state.kpi_records) state.kpi_records = [];
      // currently editing KPI record id (null when creating new)
      let editingKPIId = null;

      function addKPIRecord(dept, rec) {
        // if rec contains an id, update existing record
        if (rec && rec.id) {
          const idx = (state.kpi_records || []).findIndex(r => r.id === rec.id);
          if (idx !== -1) {
            // preserve created timestamp
            const existingCreated = state.kpi_records[idx].created;
            state.kpi_records[idx] = Object.assign({}, rec, { id: rec.id, dept, created: existingCreated });
            save();
            renderKPIRecords(dept, rec.subtype);
            addAudit({ action: 'KPI Updated', dept, record: state.kpi_records[idx] });
            return;
          }
        }
        const id = 'r_' + Date.now();
        const r = Object.assign({ id, dept, created: (new Date()).toISOString() }, rec || {});
        state.kpi_records.push(r);
        save();
        // ensure the department panel is visible and show the matching records table
        try { showDepartment(dept, false); } catch (e) { }
        renderKPIRecords(dept, r.subtype);
        try { if (dept === 'Crushing' && typeof updateCrushGradeFullBudget === 'function') updateCrushGradeFullBudget(); } catch (e) { }
        // unhide the specific records subpanel so the user sees the saved record immediately
        try {
          // grade -> dept-grade-records, ore -> dept-ore-records, toll -> dept-toll-records, otherwise dept-records
          const panelId = dept + '-' + (r.subtype === 'grade' ? 'grade-records' : (r.subtype === 'ore' ? 'ore-records' : (r.subtype === 'toll' ? 'toll-records' : 'records')));
          document.querySelectorAll('#dept-' + dept + ' .dept-subpanel').forEach(p => p.classList.add('hidden'));
          const panel = document.getElementById(panelId);
          if (panel) panel.classList.remove('hidden');
        } catch (e) { }
        addAudit({ action: 'KPI Saved', dept, record: r });
      }

      function deleteKPIRecord(id) {
        const idx = (state.kpi_records || []).findIndex(r => r.id === id);
        if (idx === -1) return;
        const dept = state.kpi_records[idx].dept;
        const subtype = state.kpi_records[idx].subtype;
        state.kpi_records.splice(idx, 1);
        save();
        renderKPIRecords(dept, subtype);
        addAudit({ action: 'KPI Deleted', id });
      }

      function editKPIRecord(id) {
        const rec = (state.kpi_records || []).find(r => r.id === id);
        if (!rec) return; // nothing to edit
        // open Crushing section and show appropriate panel
        showDepartment(rec.dept, false);
        // show subpanel for subtype (or fixed for generic records)
        const sub = rec.subtype || 'fixed';
        document.querySelectorAll('#dept-' + rec.dept + ' .dept-subpanel').forEach(p => p.classList.add('hidden'));
        const panel = document.getElementById(rec.dept + '-' + sub);
        if (panel) panel.classList.remove('hidden');
        // populate form fields depending on subtype
        if (sub === 'grade') {
          if (rec.dept === 'Geology') {
            document.getElementById('geoGrade_kpi').value = rec.kpi || '';
            document.getElementById('geoGrade_date').value = rec.date || '';
            document.getElementById('geoGrade_rig').value = rec.rig || '';
            document.getElementById('geoGrade_daily_actual').value = rec.daily_actual || '';
            document.getElementById('geoGrade_daily_forecast').value = rec.daily_forecast || '';
            document.getElementById('geoGrade_var1').value = rec.var1 || '';
            document.getElementById('geoGrade_mtd_actual').value = rec.mtd_actual || '';
            document.getElementById('geoGrade_mtd_forecast').value = rec.mtd_forecast || '';
            document.getElementById('geoGrade_var2').value = rec.var2 || '';
            document.getElementById('geoGrade_outlook').value = rec.outlook || '';
            document.getElementById('geoGrade_fullForecast').value = rec.fullForecast || '';
            document.getElementById('geoGrade_fullBudget').value = rec.fullBudget || '';
            document.getElementById('geoGrade_var3').value = rec.var3 || '';
            document.getElementById('geoGrade_month').value = rec.month || '';
            // update daily forecast after loading
            try { updateGeoGradeDailyForecast(); updateGeoGradeFullForecast(); updateGeoGradeFullBudget(); } catch (e) { }
          } else {
            document.getElementById('crushGrade_kpi').value = rec.kpi || '';
            document.getElementById('crushGrade_date').value = rec.date || '';
            document.getElementById('crushGrade_daily_t').value = rec.daily_t || '';
            document.getElementById('crushGrade_daily_actual').value = rec.daily_actual || '';
            document.getElementById('crushGrade_daily_forecast').value = rec.daily_forecast || '';
            document.getElementById('crushGrade_var1').value = rec.var1 || '';
            document.getElementById('crushGrade_mtd_actual').value = rec.mtd_actual || '';
            document.getElementById('crushGrade_mtd_forecast').value = rec.mtd_forecast || '';
            document.getElementById('crushGrade_var2').value = rec.var2 || '';
            document.getElementById('crushGrade_outlook').value = rec.outlook || '';
            document.getElementById('crushGrade_fullForecast').value = rec.fullForecast || '';
            document.getElementById('crushGrade_fullBudget').value = rec.fullBudget || '';
            document.getElementById('crushGrade_var3').value = rec.var3 || '';
            document.getElementById('crushGrade_month').value = rec.month || '';
          }
        } else if (sub === 'ore') {
          if (rec.dept === 'Geology') {
            document.getElementById('geoOre_kpi').value = rec.kpi || '';
            document.getElementById('geoOre_date').value = rec.date || '';
            document.getElementById('geoOre_rig').value = rec.rig || '';
            document.getElementById('geoOre_daily_actual').value = rec.daily_actual || '';
            document.getElementById('geoOre_daily_forecast').value = rec.daily_forecast || '';
            document.getElementById('geoOre_var1').value = rec.var1 || '';
            document.getElementById('geoOre_mtd_actual').value = rec.mtd_actual || '';
            document.getElementById('geoOre_mtd_forecast').value = rec.mtd_forecast || '';
            document.getElementById('geoOre_var2').value = rec.var2 || '';
            document.getElementById('geoOre_outlook').value = rec.outlook || '';
            document.getElementById('geoOre_fullForecast').value = rec.fullForecast || '';
            document.getElementById('geoOre_fullBudget').value = rec.fullBudget || '';
            document.getElementById('geoOre_var3').value = rec.var3 || '';
            document.getElementById('geoOre_month').value = rec.month || '';
            // update calculations after loading
            try { updateGeoOreDailyForecast(); updateGeoOreFullForecast(); updateGeoOreFullBudget(); updateGeoOreOutlook(); computeGeoOreMTDActual(); } catch (e) { }
          } else {
            document.getElementById('crushOre_kpi').value = rec.kpi || '';
            document.getElementById('crushOre_date').value = rec.date || '';
            document.getElementById('crushOre_daily_actual').value = rec.daily_actual ? parseFloat(rec.daily_actual).toLocaleString() : '';
            document.getElementById('crushOre_daily_forecast').value = rec.daily_forecast || '';
            document.getElementById('crushOre_var1').value = rec.var1 || '';
            document.getElementById('crushOre_mtd_actual').value = rec.mtd_actual ? parseFloat(rec.mtd_actual).toLocaleString() : '';
            document.getElementById('crushOre_mtd_forecast').value = rec.mtd_forecast ? parseFloat(rec.mtd_forecast).toLocaleString() : '';
            document.getElementById('crushOre_var2').value = rec.var2 || '';
            document.getElementById('crushOre_outlook').value = rec.outlook || '';
            document.getElementById('crushOre_fullForecast').value = rec.fullForecast || '';
            document.getElementById('crushOre_fullBudget').value = rec.fullBudget || '';
            document.getElementById('crushOre_var3').value = rec.var3 || '';
            document.getElementById('crushOre_month').value = rec.month || '';
          }
        } else if (sub === 'toll') {
          document.getElementById('geoToll_kpi').value = rec.kpi || '';
          document.getElementById('geoToll_date').value = rec.date || '';
          document.getElementById('geoToll_wetTonnes').value = rec.wetTonnes || '';
          document.getElementById('geoToll_daily_actual').value = rec.daily_actual || '';
          document.getElementById('geoToll_daily_forecast').value = rec.daily_forecast || '';
          document.getElementById('geoToll_var1').value = rec.var1 || '';
          document.getElementById('geoToll_mtd_actual').value = rec.mtd_actual || '';
          document.getElementById('geoToll_mtd_forecast').value = rec.mtd_forecast || '';
          document.getElementById('geoToll_var2').value = rec.var2 || '';
          document.getElementById('geoToll_outlook').value = rec.outlook || '';
          document.getElementById('geoToll_fullForecast').value = rec.fullForecast || '';
          document.getElementById('geoToll_fullBudget').value = rec.fullBudget || '';
          document.getElementById('geoToll_var3').value = rec.var3 || '';
          document.getElementById('geoToll_grade').value = rec.grade || '';
          document.getElementById('geoToll_gradeDay7').value = rec.gradeDay7 || '';
        } else if (sub === 'safety') {
          document.getElementById('ohsSafety_kpi').value = rec.kpi || '';
          document.getElementById('ohsSafety_date').value = rec.date || '';
          document.getElementById('ohsSafety_daily_actual').value = rec.daily_actual || '';
          document.getElementById('ohsSafety_daily_forecast').value = rec.daily_forecast === '0' ? '' : rec.daily_forecast || '';
          document.getElementById('ohsSafety_var1').value = rec.var1 || '';
          document.getElementById('ohsSafety_mtd_actual').value = rec.mtd_actual || '';
          document.getElementById('ohsSafety_mtd_forecast').value = rec.mtd_forecast || '';
          document.getElementById('ohsSafety_var2').value = rec.var2 || '';
          document.getElementById('ohsSafety_outlook').value = rec.outlook || '';
          document.getElementById('ohsSafety_fullForecast').value = rec.fullForecast || '';
          document.getElementById('ohsSafety_fullBudget').value = rec.fullBudget || '';
          document.getElementById('ohsSafety_var3').value = rec.var3 || '';
          document.getElementById('ohsSafety_month').value = rec.month || '';
          // update computed fields
          try { computeOHSSafetyMTDForecast(); computeOHSSafetyMTDActual(); } catch (e) { }
        } else if (sub === 'environmental') {
          document.getElementById('ohsEnvironmental_kpi').value = rec.kpi || '';
          document.getElementById('ohsEnvironmental_date').value = rec.date || '';
          document.getElementById('ohsEnvironmental_daily_actual').value = rec.daily_actual || '';
          document.getElementById('ohsEnvironmental_daily_forecast').value = rec.daily_forecast === '0' ? '' : rec.daily_forecast || '';
          document.getElementById('ohsEnvironmental_var1').value = rec.var1 || '';
          document.getElementById('ohsEnvironmental_mtd_actual').value = rec.mtd_actual || '';
          document.getElementById('ohsEnvironmental_mtd_forecast').value = rec.mtd_forecast || '';
          document.getElementById('ohsEnvironmental_var2').value = rec.var2 || '';
          document.getElementById('ohsEnvironmental_outlook').value = rec.outlook || '';
          document.getElementById('ohsEnvironmental_fullForecast').value = rec.fullForecast || '';
          document.getElementById('ohsEnvironmental_fullBudget').value = rec.fullBudget || '';
          document.getElementById('ohsEnvironmental_var3').value = rec.var3 || '';
          document.getElementById('ohsEnvironmental_month').value = rec.month || '';
          // update computed fields
          try { computeOHSEnvironmentalMTDActual(); } catch (e) { }
        } else if (sub === 'property') {
          document.getElementById('ohsProperty_kpi').value = rec.kpi || '';
          document.getElementById('ohsProperty_date').value = rec.date || '';
          document.getElementById('ohsProperty_daily_actual').value = rec.daily_actual || '';
          document.getElementById('ohsProperty_daily_forecast').value = rec.daily_forecast === '0' ? '' : rec.daily_forecast || '';
          document.getElementById('ohsProperty_var1').value = rec.var1 || '';
          document.getElementById('ohsProperty_mtd_actual').value = rec.mtd_actual || '';
          document.getElementById('ohsProperty_mtd_forecast').value = rec.mtd_forecast || '';
          document.getElementById('ohsProperty_var2').value = rec.var2 || '';
          document.getElementById('ohsProperty_outlook').value = rec.outlook || '';
          document.getElementById('ohsProperty_fullForecast').value = rec.fullForecast || '';
          document.getElementById('ohsProperty_fullBudget').value = rec.fullBudget || '';
          document.getElementById('ohsProperty_var3').value = rec.var3 || '';
          document.getElementById('ohsProperty_month').value = rec.month || '';
          // update computed fields
          try { computeOHSPropertyMTDActual(); } catch (e) { }
        } else {
          // fixed/generic record
          if (rec.dept === 'Geology') {
            document.getElementById('geoKPI').value = rec.kpi || '';
            document.getElementById('geoTargetMonth').value = rec.month || '';
            document.getElementById('geoNumDays').value = rec.days || '';
            document.getElementById('geoFullForecast').value = rec.fullForecast || '';
            document.getElementById('geoFullBudget').value = rec.fullBudget || '';
            document.getElementById('geoForecastPerRig').value = rec.forecastPerRig || '';
          } else if (rec.dept === 'OHS') {
            document.getElementById('ohsKPI').value = rec.kpi || '';
            document.getElementById('ohsTargetMonth').value = rec.month || '';
            document.getElementById('ohsNumDays').value = rec.days || '';
            document.getElementById('ohsFullForecast').value = rec.fullForecast || '';
            document.getElementById('ohsFullBudget').value = rec.fullBudget || '';
          } else {
            document.getElementById('crushKPI').value = rec.kpi || '';
            document.getElementById('crushTargetMonth').value = rec.month || '';
            document.getElementById('crushNumDays').value = rec.days || '';
            document.getElementById('crushFullForecast').value = rec.fullForecast || '';
            document.getElementById('crushFullBudget').value = rec.fullBudget || '';
          }
        }
        // set editing id so Save will update
        editingKPIId = id;
      }

      function renderKPIRecords(dept, subtype) {
        // subtype optional: when provided render only that subtype into its own table (e.g., grade or ore)
        let tableId;
        if (subtype === 'grade') tableId = 'tbl' + dept + 'GradeRecords';
        else if (subtype === 'ore') tableId = 'tbl' + dept + 'OreRecords';
        else if (subtype === 'toll') tableId = 'tbl' + dept + 'TollRecords';
        else if (subtype === 'ore-mined') tableId = 'tbl' + dept + 'OreMinedRecords';
        else if (subtype === 'grade-ore-mined') tableId = 'tbl' + dept + 'GradeOreMinedRecords';
        else if (subtype === 'total-material-moved') tableId = 'tbl' + dept + 'TotalMaterialMovedRecords';
        else if (subtype === 'blast-hole-drilling') tableId = 'tbl' + dept + 'BlastHoleDrillingRecords';
        else if (subtype === 'gold-contained') tableId = 'tbl' + dept + 'GoldContainedRecords';
        else if (subtype === 'gold-recovery') tableId = 'tbl' + dept + 'GoldRecoveryRecords';
        else if (subtype === 'plant-feed-grade') tableId = 'tbl' + dept + 'PlantFeedGradeRecords';
        else if (subtype === 'tonnes-treated') tableId = 'tbl' + dept + 'TonnesTreatedRecords';
        else if (subtype === 'safety') tableId = 'tbl' + dept + 'SafetyRecords';
        else if (subtype === 'environmental') tableId = 'tbl' + dept + 'EnvironmentalRecords';
        else if (subtype === 'property') tableId = 'tbl' + dept + 'PropertyRecords';
        else tableId = 'tbl' + dept + 'Records';
        const tbl = document.getElementById(tableId);
        if (!tbl) return;
        const tbody = tbl.querySelector('tbody'); tbody.innerHTML = '';
        const list = (state.kpi_records || []).filter(r => {
          if (r.dept !== dept) return false;
          if (typeof subtype === 'undefined') return !r.subtype; // only fixed inputs (no subtype)
          return r.subtype === subtype;
        });
        list.forEach(r => {
          const tr = document.createElement('tr');
          // format month (YYYY-MM -> 'Month YYYY')
          let formattedMonth = '';
          if (r.month && /^\d{4}-\d{2}$/.test(r.month)) {
            const parts = r.month.split('-'); const y = parts[0]; const m = Number(parts[1]) - 1;
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
            formattedMonth = (monthNames[m] || '') + (y ? ' ' + y : '');
          } else formattedMonth = r.month || '';
          // format created date as DD-MM-YYYY
          let createdDateStr = '';
          if (r.created) { const cd = new Date(r.created); if (!isNaN(cd)) { const dd = String(cd.getDate()).padStart(2, '0'); const mm = String(cd.getMonth() + 1).padStart(2, '0'); const yy = cd.getFullYear(); createdDateStr = dd + '-' + mm + '-' + yy; } }
          // for grade/or ore tables include subtype-specific columns
          if (subtype === 'grade') {
            // Grade records include an extra column: Rig for Geology, Daily Actual (t) for Crushing
            tr.innerHTML = `
              <td>${escapeHtml(r.kpi || '')}</td>
              <td>${escapeHtml(formatDisplayDate(r.date) || '')}</td>
              <td>${escapeHtml((dept === 'Geology' ? r.rig : r.daily_t) || '')}</td>
              <td>${escapeHtml(r.daily_actual || '')}</td>
              <td>${escapeHtml(r.daily_forecast || '')}</td>
              <td>${escapeHtml(r.var1 || '')}</td>
              <td>${escapeHtml(r.mtd_actual || '')}</td>
              <td>${escapeHtml(r.mtd_forecast || '')}</td>
              <td>${escapeHtml(r.var2 || '')}</td>
              <td>${escapeHtml(r.outlook || '')}</td>
              <td>${escapeHtml(r.fullForecast || '')}</td>
              <td>${escapeHtml(r.fullBudget || '')}</td>
              <td>${escapeHtml(r.var3 || '')}</td>
              <td>${escapeHtml(formattedMonth)}</td>
              <td style='display:flex; gap:8px'>
                <button class='btn' data-edit-rec-id='${r.id}' title='Edit'>
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 113 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>
                </button>
                <button class='btn ghost' data-rec-id='${r.id}' title='Delete'>
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/><path d="M10 11v6"/><path d="M14 11v6"/><path d="M9 6V4a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v2"/></svg>
                </button>
              </td>`;
          } else if (subtype === 'ore') {
            // Ore records include Rig column for Geology, but not for Crushing
            const rigCol = dept === 'Geology' ? `<td>${escapeHtml(r.rig || '')}</td>` : '';
            tr.innerHTML = `
              <td>${escapeHtml(r.kpi || '')}</td>
              <td>${escapeHtml(formatDisplayDate(r.date) || '')}</td>
              ${rigCol}
              <td>${escapeHtml(r.daily_actual || '')}</td>
              <td>${escapeHtml(r.daily_forecast || '')}</td>
              <td>${escapeHtml(r.var1 || '')}</td>
              <td>${escapeHtml(r.mtd_actual || '')}</td>
              <td>${escapeHtml(r.mtd_forecast || '')}</td>
              <td>${escapeHtml(r.var2 || '')}</td>
              <td>${escapeHtml(r.outlook || '')}</td>
              <td>${escapeHtml(r.fullForecast || '')}</td>
              <td>${escapeHtml(r.fullBudget || '')}</td>
              <td>${escapeHtml(r.var3 || '')}</td>
              <td>${escapeHtml(formattedMonth)}</td>
              <td style='display:flex; gap:8px'>
                <button class='btn' data-edit-rec-id='${r.id}' title='Edit'>
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 113 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>
                </button>
                <button class='btn ghost' data-rec-id='${r.id}' title='Delete'>
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/><path d="M10 11v6"/><path d="M14 11v6"/><path d="M9 6V4a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v2"/></svg>
                </button>
              </td>`;
          } else if (subtype === 'safety') {
            // Safety records, no rig column
            const rigCol = '';
            tr.innerHTML = `
              <td>${escapeHtml(r.kpi || '')}</td>
              <td>${escapeHtml(formatDisplayDate(r.date) || '')}</td>
              ${rigCol}
              <td>${escapeHtml(r.daily_actual || '')}</td>
              <td>${escapeHtml(r.daily_forecast || '0')}</td>
              <td>${escapeHtml(r.var1 || '')}</td>
              <td>${escapeHtml(r.mtd_actual || '')}</td>
              <td>${escapeHtml(r.mtd_forecast || '')}</td>
              <td>${escapeHtml(r.var2 || '')}</td>
              <td>${escapeHtml(r.outlook || '')}</td>
              <td>${escapeHtml(r.fullForecast || '')}</td>
              <td>${escapeHtml(r.fullBudget || '')}</td>
              <td>${escapeHtml(r.var3 || '')}</td>
              <td>${escapeHtml(formattedMonth)}</td>
              <td style='display:flex; gap:8px'>
                <button class='btn' data-edit-rec-id='${r.id}' title='Edit'>
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 113 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>
                </button>
                <button class='btn ghost' data-rec-id='${r.id}' title='Delete'>
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/><path d="M10 11v6"/><path d="M14 11v6"/><path d="M9 6V4a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v2"/></svg>
                </button>
              </td>`;
            tbody.appendChild(tr);
          } else if (subtype === 'environmental') {
            // Environmental records, no rig column
            const rigCol = '';
            tr.innerHTML = `
              <td>${escapeHtml(r.kpi || '')}</td>
              <td>${escapeHtml(formatDisplayDate(r.date) || '')}</td>
              ${rigCol}
              <td>${escapeHtml(r.daily_actual || '')}</td>
              <td>${escapeHtml(r.daily_forecast || '0')}</td>
              <td>${escapeHtml(r.var1 || '')}</td>
              <td>${escapeHtml(r.mtd_actual || '')}</td>
              <td>${escapeHtml(r.mtd_forecast || '')}</td>
              <td>${escapeHtml(r.var2 || '')}</td>
              <td>${escapeHtml(r.outlook || '')}</td>
              <td>${escapeHtml(r.fullForecast || '')}</td>
              <td>${escapeHtml(r.fullBudget || '')}</td>
              <td>${escapeHtml(r.var3 || '')}</td>
              <td>${escapeHtml(formattedMonth)}</td>
              <td style='display:flex; gap:8px'>
                <button class='btn' data-edit-rec-id='${r.id}' title='Edit'>
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 113 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>
                </button>
                <button class='btn ghost' data-rec-id='${r.id}' title='Delete'>
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/><path d="M10 11v6"/><path d="M14 11v6"/><path d="M9 6V4a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v2"/></svg>
                </button>
              </td>`;
            tbody.appendChild(tr);
          } else if (subtype === 'toll') {
            // Toll records
            tr.innerHTML = `
              <td>${escapeHtml(r.kpi || '')}</td>
              <td>${escapeHtml(formatDisplayDate(r.date) || '')}</td>
              <td>${escapeHtml(r.wetTonnes || '')}</td>
              <td>${escapeHtml(r.daily_actual || '')}</td>
              <td>${escapeHtml(r.daily_forecast || '')}</td>
              <td>${escapeHtml(r.var1 || '')}</td>
              <td>${escapeHtml(r.mtd_actual || '')}</td>
              <td>${escapeHtml(r.mtd_forecast || '')}</td>
              <td>${escapeHtml(r.var2 || '')}</td>
              <td>${escapeHtml(r.outlook || '')}</td>
              <td>${escapeHtml(r.fullForecast || '')}</td>
              <td>${escapeHtml(r.fullBudget || '')}</td>
              <td>${escapeHtml(r.var3 || '')}</td>
              <td>${escapeHtml(r.grade || '')}</td>
              <td>${escapeHtml(r.gradeDay7 || '')}</td>
              <td style='display:flex; gap:8px'>
                <button class='btn' data-edit-rec-id='${r.id}' title='Edit'>
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 113 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>
                </button>
                <button class='btn ghost' data-rec-id='${r.id}' title='Delete'>
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/><path d="M10 11v6"/><path d="M14 11v6"/><path d="M9 6V4a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v2"/></svg>
                </button>
              </td>`;
            tbody.appendChild(tr);
          } else if (subtype === 'ore-mined' || subtype === 'grade-ore-mined' || subtype === 'total-material-moved' || subtype === 'blast-hole-drilling' || subtype === 'gold-contained' || subtype === 'gold-recovery' || subtype === 'plant-feed-grade' || subtype === 'tonnes-treated') {
            // Mining records
            tr.innerHTML = `
              <td>${escapeHtml(r.kpi || '')}</td>
              <td>${escapeHtml(formatDisplayDate(r.date) || '')}</td>
              <td>${escapeHtml(r.daily_actual || '')}</td>
              <td>${escapeHtml(r.daily_forecast || '')}</td>
              <td>${escapeHtml(r.var1 || '')}</td>
              <td>${escapeHtml(r.mtd_actual || '')}</td>
              <td>${escapeHtml(r.mtd_forecast || '')}</td>
              <td>${escapeHtml(r.var2 || '')}</td>
              <td>${escapeHtml(r.outlook || '')}</td>
              <td>${escapeHtml(r.fullForecast || '')}</td>
              <td>${escapeHtml(r.fullBudget || '')}</td>
              <td>${escapeHtml(r.var3 || '')}</td>
              <td>${escapeHtml(formattedMonth)}</td>
              <td style='display:flex; gap:8px'>
                <button class='btn' data-edit-rec-id='${r.id}' title='Edit'>
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 113 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>
                </button>
                <button class='btn ghost' data-rec-id='${r.id}' title='Delete'>
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/><path d="M10 11v6"/><path d="M14 11v6"/><path d="M9 6V4a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v2"/></svg>
                </button>
              </td>`;
            tbody.appendChild(tr);
          } else if (subtype === 'property') {
            // Property records, no rig column
            const rigCol = '';
            tr.innerHTML = `
              <td>${escapeHtml(r.kpi || '')}</td>
              <td>${escapeHtml(formatDisplayDate(r.date) || '')}</td>
              ${rigCol}
              <td>${escapeHtml(r.daily_actual || '')}</td>
              <td>${escapeHtml(r.daily_forecast || '0')}</td>
              <td>${escapeHtml(r.var1 || '')}</td>
              <td>${escapeHtml(r.mtd_actual || '')}</td>
              <td>${escapeHtml(r.mtd_forecast || '')}</td>
              <td>${escapeHtml(r.var2 || '')}</td>
              <td>${escapeHtml(r.outlook || '')}</td>
              <td>${escapeHtml(r.fullForecast || '')}</td>
              <td>${escapeHtml(r.fullBudget || '')}</td>
              <td>${escapeHtml(r.var3 || '')}</td>
              <td>${escapeHtml(formattedMonth)}</td>
              <td style='display:flex; gap:8px'>
                <button class='btn' data-edit-rec-id='${r.id}' title='Edit'>
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 113 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>
                </button>
                <button class='btn ghost' data-rec-id='${r.id}' title='Delete'>
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/><path d="M10 11v6"/><path d="M14 11v6"/><path d="M9 6V4a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v2"/></svg>
                </button>
              </td>`;
            tbody.appendChild(tr);
          } else if (dept === 'Geology' && !subtype) {
            tr.innerHTML = `<td>${escapeHtml(r.kpi || '')}</td><td>${escapeHtml(formattedMonth)}</td><td>${escapeHtml(r.days || '')}</td><td>${escapeHtml(r.fullForecast || '')}</td><td>${escapeHtml(r.fullBudget || '')}</td><td>${escapeHtml(r.forecastPerRig || '')}</td><td style='display:flex; gap:8px'><button class='btn' data-edit-rec-id='${r.id}' title='Edit'><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 113 3L7 19l-4 1 1-4L16.5 3.5z"/></svg></button><button class='btn ghost' data-rec-id='${r.id}' title='Delete'><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/><path d="M10 11v6"/><path d="M14 11v6"/><path d="M9 6V4a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v2"/></svg></button></td>`;
          } else {
            // For Crushing and OHS fixed inputs use icon-only buttons (keep same data attributes for existing handlers)
            if (dept === 'Crushing' || dept === 'OHS') {
              tr.innerHTML = `<td>${escapeHtml(r.kpi || '')}</td><td>${escapeHtml(formattedMonth)}</td><td>${escapeHtml(r.days || '')}</td><td>${escapeHtml(r.fullForecast || '')}</td><td>${escapeHtml(r.fullBudget || '')}</td><td>${escapeHtml(createdDateStr)}</td><td style='display:flex;gap:8px;align-items:center'>
                  <button class='btn' data-edit-rec-id='${r.id}' title='Edit'>
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 113 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>
                  </button>
                  <button class='btn ghost' data-rec-id='${r.id}' title='Delete' style='margin-left:8px'>
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/><path d="M10 11v6"/><path d="M14 11v6"/><path d="M9 6V4a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v2"/></svg>
                  </button>
                </td>`;
            } else {
              tr.innerHTML = `<td>${escapeHtml(r.kpi || '')}</td><td>${escapeHtml(formattedMonth)}</td><td>${escapeHtml(r.days || '')}</td><td>${escapeHtml(r.fullForecast || '')}</td><td>${escapeHtml(r.fullBudget || '')}</td><td>${escapeHtml(createdDateStr)}</td><td><button class='btn' data-edit-rec-id='${r.id}'>Edit</button><button class='btn ghost' data-rec-id='${r.id}' style='margin-left:8px'>Delete</button></td>`;
            }
          }
          tbody.appendChild(tr);
        });
        // attach delete handlers (event delegation)
        tbody.querySelectorAll('button[data-rec-id]').forEach(b => b.addEventListener('click', () => { const id = b.getAttribute('data-rec-id'); if (confirm('Delete record?')) deleteKPIRecord(id); }));
        // attach edit handlers
        tbody.querySelectorAll('button[data-edit-rec-id]').forEach(b => b.addEventListener('click', () => { const id = b.getAttribute('data-edit-rec-id'); editKPIRecord(id); }));
        // For Geology, update statuses with sums for current month
        if (dept === 'Geology') {
          const now = new Date();
          const currentMonth = now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0');
          const sumActual = list.reduce((acc, r) => {
            if (!r.date) return acc;
            const rDate = new Date(r.date);
            if (isNaN(rDate)) return acc;
            const rMonth = rDate.getFullYear() + '-' + String(rDate.getMonth() + 1).padStart(2, '0');
            if (rMonth === currentMonth) {
              return acc + (parseFloat(String(r.daily_actual).replace(/,/g, '')) || 0);
            }
            return acc;
          }, 0);
          const sumForecast = list.reduce((acc, r) => {
            if (!r.date) return acc;
            const rDate = new Date(r.date);
            if (isNaN(rDate)) return acc;
            const rMonth = rDate.getFullYear() + '-' + String(rDate.getMonth() + 1).padStart(2, '0');
            if (rMonth === currentMonth) {
              return acc + (parseFloat(String(r.daily_forecast).replace(/,/g, '')) || 0);
            }
            return acc;
          }, 0);
          const elActual = document.getElementById('dashPendingGeology');
          if (elActual) elActual.querySelector('strong').textContent = sumActual.toLocaleString();
          const elForecast = document.getElementById('dashApprovedGeology');
          if (elForecast) elForecast.querySelector('strong').textContent = sumForecast.toLocaleString();
          const variance = sumActual - sumForecast;
          const elVariance = document.getElementById('dashRejectedGeology');
          if (elVariance) elVariance.querySelector('strong').textContent = variance.toLocaleString();
        }
        // For OHS, update statuses with sums for current month
        if (dept === 'OHS') {
          const now = new Date();
          const currentMonth = now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0');
          const sumActual = list.reduce((acc, r) => {
            if (!r.date) return acc;
            const rDate = new Date(r.date);
            if (isNaN(rDate)) return acc;
            const rMonth = rDate.getFullYear() + '-' + String(rDate.getMonth() + 1).padStart(2, '0');
            if (rMonth === currentMonth) {
              return acc + (parseFloat(String(r.daily_actual).replace(/,/g, '')) || 0);
            }
            return acc;
          }, 0);
          const sumForecast = list.reduce((acc, r) => {
            if (!r.date) return acc;
            const rDate = new Date(r.date);
            if (isNaN(rDate)) return acc;
            const rMonth = rDate.getFullYear() + '-' + String(rDate.getMonth() + 1).padStart(2, '0');
            if (rMonth === currentMonth) {
              return acc + (parseFloat(String(r.daily_forecast).replace(/,/g, '')) || 0);
            }
            return acc;
          }, 0);
          const elActual = document.getElementById('dashPendingOHS');
          if (elActual) elActual.querySelector('strong').textContent = sumActual.toLocaleString();
          const elForecast = document.getElementById('dashApprovedOHS');
          if (elForecast) elForecast.querySelector('strong').textContent = sumForecast.toLocaleString();
          const variance = sumActual - sumForecast;
          const elVariance = document.getElementById('dashRejectedOHS');
          if (elVariance) elVariance.querySelector('strong').textContent = variance.toLocaleString();
        }
        // For Crushing, update MTD Actual status with sum of Daily Actual for current month
        if (dept === 'Crushing') {
          const now = new Date();
          const currentMonth = now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0');
          const sumActual = list.reduce((acc, r) => {
            if (!r.date) return acc;
            const rDate = new Date(r.date);
            if (isNaN(rDate)) return acc;
            const rMonth = rDate.getFullYear() + '-' + String(rDate.getMonth() + 1).padStart(2, '0');
            if (rMonth === currentMonth) {
              return acc + (parseFloat(String(r.daily_actual).replace(/,/g, '')) || 0);
            }
            return acc;
          }, 0);
          const sumForecast = list.reduce((acc, r) => {
            if (!r.date) return acc;
            const rDate = new Date(r.date);
            if (isNaN(rDate)) return acc;
            const rMonth = rDate.getFullYear() + '-' + String(rDate.getMonth() + 1).padStart(2, '0');
            if (rMonth === currentMonth) {
              return acc + (parseFloat(String(r.daily_forecast).replace(/,/g, '')) || 0);
            }
            return acc;
          }, 0);
          const elActual = document.getElementById('dashPendingCrushing');
          if (elActual) elActual.querySelector('strong').textContent = sumActual.toLocaleString();
          const elForecast = document.getElementById('dashApprovedCrushing');
          if (elForecast) elForecast.querySelector('strong').textContent = sumForecast.toLocaleString();
          const variance = sumActual - sumForecast;
          const elVariance = document.getElementById('dashRejectedCrushing');
          if (elVariance) elVariance.querySelector('strong').textContent = variance.toLocaleString();
        }
      }

      // small helper to avoid XSS when inserting plain strings
      function escapeHtml(s) { if (!s && s !== 0) return ''; return String(s).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;'); }

      // format a date string into DD-MMM-YYYY (e.g. 01-Jan-2026) for display
      function formatDisplayDate(s) {
        if (!s && s !== 0) return '';
        const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        // try native parse first
        const d = new Date(s);
        if (!isNaN(d)) {
          const dd = String(d.getDate()).padStart(2, '0');
          const mon = months[d.getMonth()] || '';
          const yyyy = d.getFullYear();
          return dd + '-' + mon + '-' + yyyy;
        }
        // try YYYY-MM-DD
        const m1 = String(s).match(/^(\d{4})-(\d{2})-(\d{2})$/);
        if (m1) { const yyyy = m1[1]; const mm = Number(m1[2]) - 1; const dd = String(m1[3]).padStart(2, '0'); return dd + '-' + (months[mm] || '') + '-' + yyyy; }
        // try DD/MM/YYYY
        const m2 = String(s).match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
        if (m2) { const dd = String(m2[1]).padStart(2, '0'); const mm = Number(m2[2]) - 1; const yyyy = m2[3]; return dd + '-' + (months[mm] || '') + '-' + yyyy; }
        // fallback: return original string
        return String(s);
      }
      function openLogin() { if (!elements.loginModal) return; elements.loginModal.classList.remove('hidden'); elements.loginUser.value = ''; elements.loginPass.value = ''; elements.loginUser.focus(); elements.btnLogout.style.display = (elements.currentUser && elements.currentUser.value) ? 'inline-flex' : 'none'; }
      function closeLogin() { if (!elements.loginModal) return; elements.loginModal.classList.add('hidden'); }
      function openReset() { if (!elements.resetModal) return; elements.resetModal.classList.remove('hidden'); elements.resetUser.value = ''; elements.resetName.value = ''; elements.resetPass.value = ''; elements.resetPass2.value = ''; elements.resetUser.focus(); }
      function closeReset() { if (!elements.resetModal) return; elements.resetModal.classList.add('hidden'); }
      function doReset() { const id = elements.resetUser.value.trim(); const name = (elements.resetName.value || '').trim(); const p1 = elements.resetPass.value; const p2 = elements.resetPass2.value; if (!id) { alert('Enter employee ID'); return; } const emp = state.employees[id]; if (!emp) { alert('User not found'); return; } if (!name || name.toLowerCase() !== (emp.name || '').toLowerCase()) { alert('Name does not match our records'); return; } if (!p1) { alert('Enter a new password'); return; } if (p1 !== p2) { alert('Passwords do not match'); return; } emp.password = p1; save(); closeReset(); alert('Password updated. You can now sign in.'); }
      function doLogin() {
        const u = elements.loginUser.value.trim(); const p = elements.loginPass.value; if (!u) { alert('Enter username'); return; }
        // bootstrap: if admin user is missing, allow a built-in admin login (admin/admin or admin/password)
        if ((!state.employees || !state.employees['admin']) && u === 'admin' && (p === 'admin' || p === 'password')) {
          state.employees = state.employees || {};
          state.employees['admin'] = { name: 'Administrator', department: 'Admin', role: 'Admin', password: p, annual_leave: 20, sick_leave: 10, leaves_used: 0, date_joined: (new Date()).toISOString().slice(0, 10) };
          save();
          alert('Bootstrap admin created. Signing you in...');
        }
        const emp = state.employees && state.employees[u];
        if (!emp) { alert('User not found. If you are an administrator try username "admin" and password "admin".'); return; }
        if (emp.password && emp.password !== p) { alert('Invalid password. Please retry or use Forgot? to reset.'); return; } // success
        // set currentUser selector value and trigger onchange; lock selector to prevent changes
        if (elements.currentUser) { elements.currentUser.value = u; elements.currentUser.disabled = true; elements.currentUser.dispatchEvent(new Event('change')); }
        // refresh employee list and navigation so Admin sees Add Employee immediately
        try { renderEmployees(); updateAdminToggle(); updateNavAccess(); } catch (e) { console.warn('refresh after login failed', e); }
        // update header buttons
        if (elements.btnLogout) elements.btnLogout.style.display = 'inline-flex';
        if (elements.btnLoginToggle) elements.btnLoginToggle.style.display = 'none';
        // reveal main UI
        const wrap = document.querySelector('.wrap'); if (wrap) wrap.style.display = 'block';
        closeLogin(); alert('Signed in as ' + u);
      }
      function doLogout() {
        if (elements.currentUser) { elements.currentUser.value = ''; elements.currentUser.disabled = false; elements.currentUser.dispatchEvent(new Event('change')); }
        // update header buttons
        if (elements.btnLogout) elements.btnLogout.style.display = 'none';
        if (elements.btnLoginToggle) elements.btnLoginToggle.style.display = 'inline-flex';
        updateAdminToggle(); renderRequests();
        // hide main UI and show login modal again
        const wrap = document.querySelector('.wrap'); if (wrap) wrap.style.display = 'none';
        openLogin();
        alert('Signed out');
      }

      // approve removed per request
      function reject(index) {
        const r = state.leave_requests[index]; if (!r || r.status !== 'Pending') return;
        const currentId = elements.currentUser ? elements.currentUser.value : '';
        const currentRole = currentId && state.employees[currentId] ? state.employees[currentId].role : '';
        const currentDept = currentId && state.employees[currentId] ? state.employees[currentId].department : '';
        const targetDept = r && r.emp_id && state.employees[r.emp_id] ? state.employees[r.emp_id].department : '';
        const allowedReject = (currentRole === 'Admin') || (currentRole === 'HOD' && currentDept === targetDept);
        if (!allowedReject) { alert('Only Admins or the employee\'s HOD can reject this leave'); return; }
        r.status = 'Rejected';
        // record audit
        addAudit({ action: 'Rejected', actor: currentId, actorRole: currentRole, targetEmp: r.emp_id, request: { start_date: r.start_date, end_date: r.end_date, days: r.days, leave_type: r.leave_type } });
        renderRequests();
      }

      // Buttons
      if (elements.btnAddEmp) elements.btnAddEmp.onclick = addEmployee;
      if (elements.btnExtractReport) elements.btnExtractReport.onclick = extractReport;
      // wire auto-days/date helpers
      if (elements.leaveDays) { elements.leaveDays.addEventListener('input', () => { try { updateEndDateFromDays(); } catch (e) { } }); }
      if (elements.startDate) { elements.startDate.addEventListener('change', () => { try { if (elements.leaveDays && elements.leaveDays.value) updateEndDateFromDays(); else if (elements.endDate && elements.endDate.value) updateDaysFromEndDate(); } catch (e) { } }); }
      if (elements.endDate) { elements.endDate.addEventListener('change', () => { try { updateDaysFromEndDate(); } catch (e) { } }); }
      // btnAddHoliday binding removed
      if (elements.btnLoginToggle) elements.btnLoginToggle.onclick = openLogin;
      if (elements.btnLoginCancel) elements.btnLoginCancel.onclick = closeLogin;
      if (elements.btnLoginSubmit) elements.btnLoginSubmit.onclick = doLogin;
      console.log('Login handlers wired:', !!elements.btnLoginSubmit, !!elements.btnLoginCancel, !!elements.btnForgot);

      // expose login function to global scope so inline handlers or debugger can call it
      try { window.doLogin = doLogin; } catch (e) { }
      if (elements.btnForgot) elements.btnForgot.onclick = () => { closeLogin(); openReset(); };
      try { window.openLogin = openLogin; window.closeLogin = closeLogin; window.openReset = openReset; window.doLogout = doLogout; window.doReset = doReset; } catch (e) { }
      if (elements.btnHeaderForgot) elements.btnHeaderForgot.onclick = () => { openReset(); };
      if (elements.btnResetCancel) elements.btnResetCancel.onclick = closeReset;
      if (elements.btnResetSubmit) elements.btnResetSubmit.onclick = doReset;
      if (elements.btnLogout) elements.btnLogout.onclick = doLogout;

      // Remove / Edit employee (event delegation)
      elements.tblEmployees.parentElement.addEventListener('click', (ev) => {
        const editBtn = ev.target.closest('button[data-edit-id]');
        if (editBtn) { const id = editBtn.getAttribute('data-edit-id'); editRole(id); return; }
        const btn = ev.target.closest('button[data-id]'); if (!btn) return; const id = btn.getAttribute('data-id');
        const currentId = elements.currentUser ? elements.currentUser.value : '';
        const currentRole = currentId && state.employees[currentId] ? state.employees[currentId].role : '';
        if (currentRole !== 'Admin') { alert('Only Admin users can remove employees'); return; }
        if (!confirm('Remove employee ' + id + '?')) return; delete state.employees[id]; // also remove requests
        state.leave_requests = state.leave_requests.filter(r => r.emp_id !== id);
        save(); renderEmployees(); renderRequests();
      });

      // Remove holiday (event delegation)
      if (elements.tblHolidays && elements.tblHolidays.parentElement) {
        elements.tblHolidays.parentElement.addEventListener('click', (ev) => {
          const btn = ev.target.closest('button[data-hid]'); if (!btn) return; const hid = Number(btn.getAttribute('data-hid'));
          if (!confirm('Remove holiday?')) return; state.public_holidays.splice(hid, 1); save(); renderHolidays(); renderRequests();
        });
      }

      // Export/import
      if (elements.btnExport) elements.btnExport.onclick = () => {
        const blob = new Blob([JSON.stringify(state, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'leave_demo_data.json'; a.click(); URL.revokeObjectURL(url);
      }
      if (elements.btnImport) elements.btnImport.onclick = () => elements.fileInput.click();
      elements.fileInput.onchange = (ev) => {
        const f = ev.target.files[0]; if (!f) return; const r = new FileReader(); r.onload = () => { try { const parsed = JSON.parse(r.result); if (parsed.employees && parsed.leave_requests) { state = parsed; save(); renderEmployees(); renderRequests(); alert('Imported'); } else alert('Invalid file'); } catch (e) { alert('Invalid json'); } }; r.readAsText(f);
      }

      // ensure public_holidays exists after import/load
      if (!Array.isArray(state.public_holidays)) state.public_holidays = [];
      // ensure audit_log exists after import/load
      if (!Array.isArray(state.audit_log)) state.audit_log = [];

      // initial load
      load();
      if (!Array.isArray(state.public_holidays)) state.public_holidays = [];
      if (!Array.isArray(state.kpi_records)) state.kpi_records = [];
      renderEmployees(); renderRequests(); renderHolidays();
      // ensure admin/hod toggles and visibility are correct on load
      try { updateAdminToggle(); } catch (e) { }
      if (elements.currentUser) elements.currentUser.onchange = () => { updateAdminToggle(); renderRequests(); try { renderDashboard(); } catch (e) { } };
      if (elements.adminView) elements.adminView.onchange = () => renderRequests();
      // keep login modal logout button state in sync
      if (elements.currentUser && elements.btnLogout) { elements.btnLogout.style.display = (elements.currentUser.value ? 'inline-flex' : 'none'); }
      // hide main UI until user authenticates and show login modal
      const wrapEl = document.querySelector('.wrap'); if (wrapEl) wrapEl.style.display = 'none';
      openLogin();
      // ensure dashboard is rendered when appropriate
      try { renderDashboard(); } catch (e) { }

      // Sections (lazy show/load)
      function showSection(id) {
        const secs = document.querySelectorAll('.section');
        secs.forEach(s => s.classList.add('hidden'));
        const target = document.getElementById(id);
        if (!target) return;
        // prevent non-Admins (including HOD) from viewing Add Employee
        if (id === 'addEmployee') {
          const cur = elements.currentUser ? elements.currentUser.value : '';
          const role = cur && state.employees[cur] ? state.employees[cur].role : 'Employee';
          if (role !== 'Admin') return; // silently keep hidden
        }
        // restrict Report to Admins and HODs
        if (id === 'report') {
          const cur = elements.currentUser ? elements.currentUser.value : '';
          const role = cur && state.employees[cur] ? state.employees[cur].role : 'Employee';
          if (role !== 'Admin' && role !== 'HOD') return; // silently keep hidden
        }
        // reveal
        target.classList.remove('hidden');
        // call renderers when relevant to ensure up-to-date data
        if (id === 'addEmployee') {
          // nothing special to render here
        }
        if (id === 'applyLeave') {
          renderEmployees(); // repopulate employee select
        }
        if (id === 'holidays') {
          renderHolidays();
        }
        // focus first input if present
        const first = target.querySelector('input,select,button'); if (first) first.focus();
      }

      // wire navigation links
      document.querySelectorAll('.nav-link').forEach(a => {
        a.addEventListener('click', (e) => {
          e.preventDefault(); const t = a.getAttribute('data-target');
          // prevent non-admins from opening Add Employee
          if (t === 'addEmployee') {
            const cur = elements.currentUser ? elements.currentUser.value : '';
            const role = cur && state.employees[cur] ? state.employees[cur].role : 'Employee';
            if (role !== 'Admin') { alert('Only Admins can access Add Employee'); return; }
          }
          showSection(t);
        });
      });

      // Department buttons: open department KPI forms with role-based access
      document.querySelectorAll('.dept-btn').forEach(b => {
        b.addEventListener('click', (e) => {
          const dept = b.getAttribute('data-dept'); if (!dept) return; showDepartment(dept, true);
        });
      });

      function showDepartment(dept, collapse) {
        const cur = elements.currentUser ? elements.currentUser.value : '';
        const role = cur && state.employees[cur] ? state.employees[cur].role : 'Employee';
        // Admin can access any department; others only their own
        if (role !== 'Admin') {
          const empDept = cur && state.employees[cur] ? state.employees[cur].department : null;
          if (empDept !== dept) { alert('Access denied: you can only access your own department'); return; }
        }
        // hide other department sections
        document.querySelectorAll('.section').forEach(s => { if (s.id && s.id.startsWith('dept-')) s.classList.add('hidden'); });
        const target = document.getElementById('dept-' + dept);
        if (!target) { alert('Department form not found: ' + dept); return; }
        target.classList.remove('hidden');
        // collapse the departments dashboard only when requested
        if (collapse) { try { const deptCard = document.getElementById('departmentsCard'); if (deptCard) deptCard.classList.add('hidden'); } catch (e) { } }
        // keep all subpanels hidden by default; user must click submenu to reveal Records/Grade/Ore panels
        try { document.querySelectorAll('#dept-' + dept + ' .dept-subpanel').forEach(p => p.classList.add('hidden')); } catch (e) { }
        // Reset breadcrumb navigation - hide breadcrumb and show submenu nav
        try {
          const breadcrumbEl = document.getElementById('breadcrumb-' + dept);
          const submenuNavEl = document.getElementById('submenu-nav-' + dept);
          const deptTitleEl = document.querySelector('#dept-' + dept + ' h3');
          if (breadcrumbEl) breadcrumbEl.classList.add('hidden');
          if (submenuNavEl) submenuNavEl.style.display = 'flex';
          if (deptTitleEl) deptTitleEl.style.display = 'block';
          // Show h4 headers in subpanels
          document.querySelectorAll('#dept-' + dept + ' .dept-subpanel h4').forEach(h4 => h4.style.display = 'block');
        } catch (e) { }
        const first = target.querySelector('input,select,button'); if (first) first.focus();
      }

      // subpanel toggles for department subsections (Fixed/Grade/Ore)
      document.addEventListener('click', (ev) => {
        const btn = ev.target.closest('.dept-sub-btn'); if (!btn) return; ev.preventDefault();
        const dept = btn.getAttribute('data-dept'); const sub = btn.getAttribute('data-sub');
        // ensure the dept section is visible (do not collapse departments dashboard when opening subpanels)
        // clear any editing state when opening a subpanel (creating new records)
        editingKPIId = null;
        showDepartment(dept, false);
        // hide all subpanels for this dept and show the chosen one
        document.querySelectorAll('#dept-' + dept + ' .dept-subpanel').forEach(p => p.classList.add('hidden'));
        // resolve panel id with fallbacks: direct, records suffix, form suffix
        const candidates = [dept + '-' + sub, dept + '-' + sub + '-records', dept + '-' + sub + '-form'];
        let panel = null;
        for (let i = 0; i < candidates.length; i++) {
          panel = document.getElementById(candidates[i]); if (panel) break;
        }
        if (panel) panel.classList.remove('hidden');

        // Update breadcrumb navigation
        const breadcrumbEl = document.getElementById('breadcrumb-' + dept);
        const breadcrumbTextEl = document.getElementById('breadcrumbText' + dept);
        const submenuNavEl = document.getElementById('submenu-nav-' + dept);
        const backBtnEl = document.getElementById('btnBack' + dept);
        const deptTitleEl = document.querySelector('#dept-' + dept + ' h3');

        if (breadcrumbEl && breadcrumbTextEl && submenuNavEl && backBtnEl && deptTitleEl) {
          // Hide submenu navigation and department title
          submenuNavEl.style.display = 'none';
          deptTitleEl.style.display = 'none';
          // Hide h4 headers in subpanels
          document.querySelectorAll('#dept-' + dept + ' .dept-subpanel h4').forEach(h4 => h4.style.display = 'none');
          // Show breadcrumb
          breadcrumbEl.classList.remove('hidden');

          // Set breadcrumb text based on department and sub
          let breadcrumbText = dept + ' — KPI';
          let subName = '';

          if (dept === 'Geology') {
            if (sub === 'fixed-records') subName = 'Fixed Inputs';
            else if (sub === 'fixed') subName = 'Fixed Inputs > Add New';
            else if (sub === 'grade-records') subName = 'Exploration Drilling';
            else if (sub === 'grade-form') subName = 'Exploration Drilling > Add New';
            else if (sub === 'ore-records') subName = 'Grade Control Drilling';
            else if (sub === 'ore-form') subName = 'Grade Control Drilling > Add New';
            else if (sub === 'toll') subName = 'Toll';
            else if (sub === 'toll-form') subName = 'Toll > Add New';
          } else if (dept === 'Mining') {
            if (sub === 'fixed-records') subName = 'Fixed Inputs';
            else if (sub === 'fixed') subName = 'Fixed Inputs > Add New';
            else if (sub === 'ore-mined') subName = 'Ore Mined';
            else if (sub === 'ore-mined-form') subName = 'Ore Mined > Add New';
            else if (sub === 'grade-ore-mined') subName = 'Grade - Ore Mined';
            else if (sub === 'grade-ore-mined-form') subName = 'Grade - Ore Mined > Add New';
            else if (sub === 'total-material-moved') subName = 'Total Material Moved';
            else if (sub === 'total-material-moved-form') subName = 'Total Material Moved > Add New';
            else if (sub === 'blast-hole-drilling') subName = 'Blast Hole Drilling';
            else if (sub === 'blast-hole-drilling-form') subName = 'Blast Hole Drilling > Add New';
          } else if (dept === 'Milling_CIL') {
            if (sub === 'fixed-records') subName = 'Fixed Inputs';
            else if (sub === 'fixed') subName = 'Fixed Inputs > Add New';
            else if (sub === 'gold-contained') subName = 'Gold Contained';
            else if (sub === 'gold-contained-form') subName = 'Gold Contained > Add New';
            else if (sub === 'gold-recovery') subName = 'Gold Recovery';
            else if (sub === 'gold-recovery-form') subName = 'Gold Recovery > Add New';
            else if (sub === 'plant-feed-grade') subName = 'Plant Feed Grade';
            else if (sub === 'plant-feed-grade-form') subName = 'Plant Feed Grade > Add New';
            else if (sub === 'tonnes-treated') subName = 'Tonnes Treated';
            else if (sub === 'tonnes-treated-form') subName = 'Tonnes Treated > Add New';
          } else if (dept === 'Crushing') {
            if (sub === 'records') subName = 'Fixed Inputs';
            else if (sub === 'grade-records') subName = 'Grade - Ore Crushed';
            else if (sub === 'grade-form') subName = 'Grade - Ore Crushed > Add New';
            else if (sub === 'ore-records') subName = 'Ore Crushed';
            else if (sub === 'ore-form') subName = 'Ore Crushed > Add New';
          } else if (dept === 'OHS') {
            if (sub === 'fixed') subName = 'Fixed Inputs';
            else if (sub === 'fixed-form') subName = 'Fixed Inputs > Add New';
            else if (sub === 'safety') subName = 'Safety Incidents';
            else if (sub === 'safety-form') subName = 'Safety Incidents > Add New';
            else if (sub === 'environmental') subName = 'Environmental Incidents';
            else if (sub === 'environmental-form') subName = 'Environmental Incidents > Add New';
            else if (sub === 'property') subName = 'Property Damage';
            else if (sub === 'property-form') subName = 'Property Damage > Add New';
          }

          if (subName) breadcrumbText += ' > ' + subName;
          breadcrumbTextEl.textContent = breadcrumbText;

          // Add back button functionality
          backBtnEl.onclick = () => {
            // Hide breadcrumb
            breadcrumbEl.classList.add('hidden');
            // Show submenu navigation and department title
            submenuNavEl.style.display = 'flex';
            deptTitleEl.style.display = 'block';
            // Show h4 headers in subpanels
            document.querySelectorAll('#dept-' + dept + ' .dept-subpanel h4').forEach(h4 => h4.style.display = 'block');
            // Hide all subpanels
            document.querySelectorAll('#dept-' + dept + ' .dept-subpanel').forEach(p => p.classList.add('hidden'));
          };
        }

        // if opening the Crushing fixed/grade/ore panel for a new record, set defaults
        try {
          if (dept === 'Crushing' && !editingKPIId) {
            if (sub === 'fixed') {
              const now = new Date(); const yyyy = now.getFullYear(); const mm = String(now.getMonth() + 1).padStart(2, '0'); const val = yyyy + '-' + mm;
              const el = document.getElementById('crushTargetMonth'); if (el) el.value = val;
            }
            if (sub === 'grade') {
              const el = document.getElementById('crushGrade_kpi'); if (el) el.value = 'Grade - Ore Crushed';
            }
            if (sub === 'ore') {
              const el = document.getElementById('crushOre_kpi'); if (el) el.value = 'Ore Crushed';
            }
          }
          if (dept === 'Geology' && !editingKPIId) {
            if (sub === 'grade-form') {
              const el = document.getElementById('geoGrade_kpi'); if (el) el.value = 'Exploration Drilling';
            }
            if (sub === 'ore-form') {
              const el = document.getElementById('geoOre_kpi'); if (el) el.value = 'Grade Control Drilling';
            }
            if (sub === 'toll-form') {
              const el = document.getElementById('geoToll_kpi'); if (el) el.value = 'Toll';
            }
          }
          if (dept === 'OHS' && !editingKPIId) {
            if (sub === 'safety-form') {
              const fields = ['ohsSafety_kpi', 'ohsSafety_date', 'ohsSafety_daily_actual', 'ohsSafety_daily_forecast', 'ohsSafety_var1', 'ohsSafety_mtd_actual', 'ohsSafety_mtd_forecast', 'ohsSafety_var2', 'ohsSafety_outlook', 'ohsSafety_fullForecast', 'ohsSafety_fullBudget', 'ohsSafety_var3', 'ohsSafety_month'];
              fields.forEach(id => { const el = document.getElementById(id); if (el) el.value = ''; });
              const k = document.getElementById('ohsSafety_kpi'); if (k) k.value = 'Safety Incidents';
            }
          }
        } catch (e) { }
        // map submenu identifier to the subtype expected by renderKPIRecords
        try {
          let renderSub = sub;
          if (renderSub && renderSub.endsWith('-records')) renderSub = renderSub.replace(/-records$/, '');
          if (renderSub === 'records' || renderSub === 'fixed') renderSub = undefined;
          if (typeof renderKPIRecords === 'function') renderKPIRecords(dept, renderSub);
          // update Toll computed placeholders when opening Toll subpanel
          try { if (typeof updateGeoTollDailyActual === 'function') updateGeoTollDailyActual(); } catch (e) { }
          try { if (typeof updateGeoTollDailyForecast === 'function') updateGeoTollDailyForecast(); } catch (e) { }
          try { if (typeof updateGeoTollMTDActual === 'function') updateGeoTollMTDActual(); } catch (e) { }
          try { if (typeof updateGeoTollMTDForecast === 'function') updateGeoTollMTDForecast(); } catch (e) { }
          try { if (typeof computeGeoTollVarPlaceholder === 'function') computeGeoTollVarPlaceholder(); } catch (e) { }
          try { if (typeof updateGeoTollVar === 'function') updateGeoTollVar(); } catch (e) { }
        } catch (e) { }
      });

      // small Geo form helpers
      const btnGeoClear = document.getElementById('btnGeoClear');
      if (btnGeoClear) btnGeoClear.addEventListener('click', () => {
        ['geoKPI', 'geoTargetMonth', 'geoNumDays', 'geoFullForecast', 'geoFullBudget', 'geoForecastPerRig'].forEach(id => { const el = document.getElementById(id); if (el) el.value = ''; });
        const now = new Date(); const yyyy = now.getFullYear(); const mm = String(now.getMonth() + 1).padStart(2, '0'); const val = yyyy + '-' + mm;
        const m = document.getElementById('geoTargetMonth'); if (m) m.value = val;
      });
      const btnGeoSave = document.getElementById('btnGeoSave');
      if (btnGeoSave) btnGeoSave.addEventListener('click', () => {
        // gather fields and persist into state.kpi_records under dept 'Geology'
        const kpi = (document.getElementById('geoKPI') || {}).value || '';
        const month = (document.getElementById('geoTargetMonth') || {}).value || '';
        const days = (document.getElementById('geoNumDays') || {}).value || '';
        const fullForecast = (document.getElementById('geoFullForecast') || {}).value || '';
        const fullBudget = (document.getElementById('geoFullBudget') || {}).value || '';
        const forecastPerRig = (document.getElementById('geoForecastPerRig') || {}).value || '';
        if (!kpi) { alert('Choose KPI'); return; }
        const rec = { kpi, month, days, fullForecast, fullBudget, forecastPerRig };
        addKPIRecord('Geology', rec);
        // clear fields after successful save
        ['geoKPI', 'geoTargetMonth', 'geoNumDays', 'geoFullForecast', 'geoFullBudget', 'geoForecastPerRig'].forEach(id => { const el = document.getElementById(id); if (el) el.value = ''; });
        alert('Record saved');
      });

      // Mining fixed form helpers
      const btnMiningClear = document.getElementById('btnMiningClear');
      if (btnMiningClear) btnMiningClear.addEventListener('click', () => {
        // clear fields but keep Target Month set to current month
        ['miningKPI', 'miningNumDays', 'miningFullForecast', 'miningFullBudget'].forEach(id => { const el = document.getElementById(id); if (el) el.value = ''; });
        const now = new Date(); const yyyy = now.getFullYear(); const mm = String(now.getMonth() + 1).padStart(2, '0'); const val = yyyy + '-' + mm;
        const m = document.getElementById('miningTargetMonth'); if (m) m.value = val;
      });
      const btnMiningSave = document.getElementById('btnMiningSave');
      if (btnMiningSave) btnMiningSave.addEventListener('click', () => {
        // gather fields and persist into state.kpi_records under dept 'Mining'
        const kpi = (document.getElementById('miningKPI') || {}).value || '';
        const month = (document.getElementById('miningTargetMonth') || {}).value || '';
        const days = (document.getElementById('miningNumDays') || {}).value || '';
        const fullForecast = (document.getElementById('miningFullForecast') || {}).value || '';
        const fullBudget = (document.getElementById('miningFullBudget') || {}).value || '';
        if (!kpi) { alert('Choose KPI'); return; }
        const rec = { kpi, month, days, fullForecast, fullBudget };
        addKPIRecord('Mining', rec);
        // clear fields after successful save
        ['miningKPI', 'miningTargetMonth', 'miningNumDays', 'miningFullForecast', 'miningFullBudget'].forEach(id => { const el = document.getElementById(id); if (el) el.value = ''; });
        alert('Record saved');
      });

      // Crushing form helpers (mirror Geology)
      const btnCrushClear = document.getElementById('btnCrushClear');
      if (btnCrushClear) btnCrushClear.addEventListener('click', () => {
        // clear fields but keep Target Month set to current month
        ['crushKPI', 'crushNumDays', 'crushFullForecast', 'crushFullBudget'].forEach(id => { const el = document.getElementById(id); if (el) el.value = ''; });
        const now = new Date(); const yyyy = now.getFullYear(); const mm = String(now.getMonth() + 1).padStart(2, '0'); const val = yyyy + '-' + mm;
        const m = document.getElementById('crushTargetMonth'); if (m) m.value = val;
      });
      const btnCrushSave = document.getElementById('btnCrushSave');
      if (btnCrushSave) btnCrushSave.addEventListener('click', () => {
        // gather fields and persist into state.kpi_records under dept 'Crushing'
        const kpi = (document.getElementById('crushKPI') || {}).value || '';
        const month = (document.getElementById('crushTargetMonth') || {}).value || '';
        const days = (document.getElementById('crushNumDays') || {}).value || '';
        const fullForecast = (document.getElementById('crushFullForecast') || {}).value || '';
        const fullBudget = (document.getElementById('crushFullBudget') || {}).value || '';
        if (!kpi) { alert('Choose KPI'); return; }
        const rec = { kpi, month, days, fullForecast, fullBudget };
        if (editingKPIId) {
          const existing = (state.kpi_records || []).find(r => r.id === editingKPIId);
          if (existing && !existing.subtype) rec.id = editingKPIId;
        }
        addKPIRecord('Crushing', rec);
        // clear fields after successful save and reset editing state
        ['crushKPI', 'crushTargetMonth', 'crushNumDays', 'crushFullForecast', 'crushFullBudget'].forEach(id => { const el = document.getElementById(id); if (el) el.value = ''; });
        editingKPIId = null;
        alert('Record saved');
      });

      // Crushing grade form save/clear (vertical inputs)
      const btnCrushingGradeClear = document.getElementById('btnCrushingGradeClear');
      if (btnCrushingGradeClear) btnCrushingGradeClear.addEventListener('click', () => {
        ['crushGrade_date', 'crushGrade_daily_t', 'crushGrade_daily_actual', 'crushGrade_daily_forecast', 'crushGrade_var1', 'crushGrade_mtd_actual', 'crushGrade_mtd_forecast', 'crushGrade_var2', 'crushGrade_outlook', 'crushGrade_fullForecast', 'crushGrade_fullBudget', 'crushGrade_var3', 'crushGrade_month'].forEach(id => { const el = document.getElementById(id); if (el) el.value = ''; });
        const k = document.getElementById('crushGrade_kpi'); if (k) k.value = 'Grade - Ore Crushed';
      });
      const btnCrushingGradeSave = document.getElementById('btnCrushingGradeSave');
      if (btnCrushingGradeSave) btnCrushingGradeSave.addEventListener('click', () => {
        // preserve Fixed Inputs values so saving a Grade record won't overwrite them
        const fixedKPIEl = document.getElementById('crushKPI');
        const fixedMonthEl = document.getElementById('crushTargetMonth');
        const fixedFullForecastEl = document.getElementById('crushFullForecast');
        const fixedFullBudgetEl = document.getElementById('crushFullBudget');
        const prevFixed = {
          crushKPI: fixedKPIEl ? fixedKPIEl.value : null,
          crushTargetMonth: fixedMonthEl ? fixedMonthEl.value : null,
          crushFullForecast: fixedFullForecastEl ? fixedFullForecastEl.value : null,
          crushFullBudget: fixedFullBudgetEl ? fixedFullBudgetEl.value : null
        };

        const kpi = (document.getElementById('crushGrade_kpi') || {}).value || '';
        const date = (document.getElementById('crushGrade_date') || {}).value || '';
        const daily_t = (document.getElementById('crushGrade_daily_t') || {}).value || '';
        const daily_actual = (document.getElementById('crushGrade_daily_actual') || {}).value || '';
        const daily_forecast = (document.getElementById('crushGrade_daily_forecast') || {}).value || '';
        const var1 = (document.getElementById('crushGrade_var1') || {}).value || '';
        const outlook = (document.getElementById('crushGrade_outlook') || {}).value || '';
        const mtd_actual = outlook;
        const mtd_forecast = (document.getElementById('crushGrade_mtd_forecast') || {}).value || '';
        const var2 = (document.getElementById('crushGrade_var2') || {}).value || '';
        const fullForecast = (document.getElementById('crushGrade_fullForecast') || {}).value || '';
        const fullBudget = (document.getElementById('crushGrade_fullBudget') || {}).value || '';
        const var3 = (document.getElementById('crushGrade_var3') || {}).value || '';
        const month = (document.getElementById('crushGrade_month') || {}).value || '';
        if (!kpi) { alert('Enter KPI'); return; }
        const rec = { subtype: 'grade', kpi, date, daily_t, daily_actual, daily_forecast, var1, mtd_actual, mtd_forecast, var2, outlook, fullForecast, fullBudget, var3, month };
        if (editingKPIId) {
          const existing = (state.kpi_records || []).find(r => r.id === editingKPIId);
          if (existing && existing.subtype === 'grade') rec.id = editingKPIId;
        }
        addKPIRecord('Crushing', rec);

        // restore fixed inputs to their previous values (if present)
        try { if (fixedKPIEl && prevFixed.crushKPI !== null) fixedKPIEl.value = prevFixed.crushKPI; } catch (e) { }
        try { if (fixedMonthEl && prevFixed.crushTargetMonth !== null) fixedMonthEl.value = prevFixed.crushTargetMonth; } catch (e) { }
        try { if (fixedFullForecastEl && prevFixed.crushFullForecast !== null) fixedFullForecastEl.value = prevFixed.crushFullForecast; } catch (e) { }
        try { if (fixedFullBudgetEl && prevFixed.crushFullBudget !== null) fixedFullBudgetEl.value = prevFixed.crushFullBudget; } catch (e) { }

        // clear grade fields
        ['crushGrade_kpi', 'crushGrade_date', 'crushGrade_daily_t', 'crushGrade_daily_actual', 'crushGrade_daily_forecast', 'crushGrade_var1', 'crushGrade_mtd_actual', 'crushGrade_mtd_forecast', 'crushGrade_var2', 'crushGrade_outlook', 'crushGrade_fullForecast', 'crushGrade_fullBudget', 'crushGrade_var3', 'crushGrade_month'].forEach(id => { const el = document.getElementById(id); if (el) el.value = ''; });
        editingKPIId = null;
        alert('Grade record saved');
      });

      // Crushing ore form save/clear (vertical inputs)
      const btnCrushingOreClear = document.getElementById('btnCrushingOreClear');
      if (btnCrushingOreClear) btnCrushingOreClear.addEventListener('click', () => {
        ['crushOre_date', 'crushOre_daily_actual', 'crushOre_daily_forecast', 'crushOre_var1', 'crushOre_mtd_actual', 'crushOre_mtd_forecast', 'crushOre_var2', 'crushOre_outlook', 'crushOre_fullForecast', 'crushOre_fullBudget', 'crushOre_var3', 'crushOre_month'].forEach(id => { const el = document.getElementById(id); if (el) el.value = ''; });
        const k = document.getElementById('crushOre_kpi'); if (k) k.value = 'Ore Crushed';
      });
      const btnCrushingOreSave = document.getElementById('btnCrushingOreSave');
      if (btnCrushingOreSave) btnCrushingOreSave.addEventListener('click', () => {
        // preserve Fixed Inputs values so saving an Ore record won't overwrite them
        const fixedKPIEl = document.getElementById('crushKPI');
        const fixedMonthEl = document.getElementById('crushTargetMonth');
        const fixedFullForecastEl = document.getElementById('crushFullForecast');
        const fixedFullBudgetEl = document.getElementById('crushFullBudget');
        const prevFixed = {
          crushKPI: fixedKPIEl ? fixedKPIEl.value : null,
          crushTargetMonth: fixedMonthEl ? fixedMonthEl.value : null,
          crushFullForecast: fixedFullForecastEl ? fixedFullForecastEl.value : null,
          crushFullBudget: fixedFullBudgetEl ? fixedFullBudgetEl.value : null
        };

        const kpi = (document.getElementById('crushOre_kpi') || {}).value || '';
        const date = (document.getElementById('crushOre_date') || {}).value || '';
        const daily_actual = (document.getElementById('crushOre_daily_actual') || {}).value || '';
        const daily_forecast = (document.getElementById('crushOre_daily_forecast') || {}).value || '';
        const var1 = (document.getElementById('crushOre_var1') || {}).value || '';
        const mtd_actual = (document.getElementById('crushOre_mtd_actual') || {}).value || '';
        const mtd_forecast = (document.getElementById('crushOre_mtd_forecast') || {}).value || '';
        const var2 = (document.getElementById('crushOre_var2') || {}).value || '';
        const outlook = (document.getElementById('crushOre_outlook') || {}).value || '';
        const fullForecast = (document.getElementById('crushOre_fullForecast') || {}).value || '';
        const fullBudget = (document.getElementById('crushOre_fullBudget') || {}).value || '';
        const var3 = (document.getElementById('crushOre_var3') || {}).value || '';
        // compute month from date
        let monthValue = '';
        if (date) {
          const d = new Date(date);
          if (!isNaN(d)) monthValue = String(d.getMonth() + 1);
        }
        if (!kpi) { alert('Enter KPI'); return; }
        const rec = { subtype: 'ore', kpi, date, daily_actual, daily_forecast, var1, mtd_actual, mtd_forecast, var2, outlook, fullForecast, fullBudget, var3, month: monthValue };
        if (editingKPIId) {
          const existing = (state.kpi_records || []).find(r => r.id === editingKPIId);
          if (existing && existing.subtype === 'ore') rec.id = editingKPIId;
        }
        addKPIRecord('Crushing', rec);

        // restore fixed inputs to their previous values (if present)
        try { if (fixedKPIEl && prevFixed.crushKPI !== null) fixedKPIEl.value = prevFixed.crushKPI; } catch (e) { }
        try { if (fixedMonthEl && prevFixed.crushTargetMonth !== null) fixedMonthEl.value = prevFixed.crushTargetMonth; } catch (e) { }
        try { if (fixedFullForecastEl && prevFixed.crushFullForecast !== null) fixedFullForecastEl.value = prevFixed.crushFullForecast; } catch (e) { }
        try { if (fixedFullBudgetEl && prevFixed.crushFullBudget !== null) fixedFullBudgetEl.value = prevFixed.crushFullBudget; } catch (e) { }

        ['crushOre_kpi', 'crushOre_date', 'crushOre_daily_actual', 'crushOre_daily_forecast', 'crushOre_var1', 'crushOre_mtd_actual', 'crushOre_mtd_forecast', 'crushOre_var2', 'crushOre_outlook', 'crushOre_fullForecast', 'crushOre_fullBudget', 'crushOre_var3', 'crushOre_month'].forEach(id => { const el = document.getElementById(id); if (el) el.value = ''; });
        editingKPIId = null;
        alert('Ore record saved');
      });

      // compute Daily Forecast for Geology Grade form: Forecast Per Rig * Rig
      function updateGeoGradeDailyForecast() {
        try {
          const kpiEl = document.getElementById('geoGrade_kpi');
          const dateEl = document.getElementById('geoGrade_date');
          const rigEl = document.getElementById('geoGrade_rig');
          const outEl = document.getElementById('geoGrade_daily_forecast');
          if (!kpiEl || !dateEl || !rigEl || !outEl) return;
          const kpi = (kpiEl.value || '').trim();
          const date = (dateEl.value || '').trim();
          const rig = (rigEl.value || '').trim();
          if (!kpi || !date || !rig) { outEl.value = ''; return; }
          const d = new Date(date);
          if (isNaN(d)) { outEl.value = ''; return; }
          const month = d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0');
          // find fixed Geology record with matching KPI and month
          const fixed = (state.kpi_records || []).find(r => {
            if (r.dept !== 'Geology') return false;
            if (r.subtype) return false; // only fixed inputs
            const rKPI = (r.kpi || '').toString().trim();
            const rMonth = (r.month || '').toString().trim();
            return rKPI === kpi && rMonth === month;
          });
          if (fixed && (fixed.forecastPerRig !== undefined && fixed.forecastPerRig !== null)) {
            const fpr = parseFloat(String(fixed.forecastPerRig).replace(/,/g, ''));
            const r = parseFloat(rig);
            if (Number.isFinite(fpr) && Number.isFinite(r)) {
              const val = fpr * r;
              outEl.value = val.toLocaleString();
            } else {
              outEl.value = '';
            }
          } else {
            outEl.value = '';
          }
          // update var after forecast change
          computeGeoGradeVar();
        } catch (e) { console.warn('updateGeoGradeDailyForecast error', e); }
      }

      // compute Daily Forecast for Geology Ore form: Forecast Per Rig * Rig, matching KPI and month
      function updateGeoOreDailyForecast() {
        try {
          const kpiEl = document.getElementById('geoOre_kpi');
          const dateEl = document.getElementById('geoOre_date');
          const rigEl = document.getElementById('geoOre_rig');
          const outEl = document.getElementById('geoOre_daily_forecast');
          if (!kpiEl || !dateEl || !rigEl || !outEl) return;
          const kpi = (kpiEl.value || '').trim();
          const date = (dateEl.value || '').trim();
          const rig = (rigEl.value || '').trim();
          if (!kpi || !date || !rig) { outEl.value = ''; return; }
          const d = new Date(date);
          if (isNaN(d)) { outEl.value = ''; return; }
          const month = d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0');
          // find fixed Geology record with matching KPI and month
          const fixed = (state.kpi_records || []).find(r => {
            if (r.dept !== 'Geology') return false;
            if (r.subtype) return false; // only fixed inputs
            const rKPI = (r.kpi || '').toString().trim();
            const rMonth = (r.month || '').toString().trim();
            return rKPI === kpi && rMonth === month;
          });
          if (fixed && (fixed.forecastPerRig !== undefined && fixed.forecastPerRig !== null)) {
            const fpr = parseFloat(String(fixed.forecastPerRig).replace(/,/g, ''));
            const r = parseFloat(rig);
            if (Number.isFinite(fpr) && Number.isFinite(r)) {
              const val = fpr * r;
              outEl.value = val.toLocaleString();
            } else {
              outEl.value = '';
            }
          } else {
            outEl.value = '';
          }
          // update var after forecast change
          computeGeoOreVar();
        } catch (e) { console.warn('updateGeoOreDailyForecast error', e); }
      }

      // compute Var for Geology Ore: ((Daily Actual - Daily Forecast) / Daily Forecast) * 100
      function computeGeoOreVar() {
        try {
          const actualEl = document.getElementById('geoOre_daily_actual');
          const forecastEl = document.getElementById('geoOre_daily_forecast');
          const varEl = document.getElementById('geoOre_var1');
          if (!actualEl || !forecastEl || !varEl) return;
          const aRaw = (actualEl.value || '').replace(/,/g, '').trim();
          const fRaw = (forecastEl.value || '').replace(/,/g, '').trim();
          const a = parseFloat(aRaw);
          const f = parseFloat(fRaw);
          if (Number.isFinite(f) && f !== 0 && Number.isFinite(a)) {
            const v = (a - f) / f;
            varEl.value = Math.round(v * 100) + '%';
          } else {
            varEl.value = '';
          }
        } catch (e) { console.warn('computeGeoOreVar error', e); }
      }

      // compute MTD Actual for Geology Ore: last record's MTD Actual + current Daily Actual, matching KPI and month
      function computeGeoOreMTDActual() {
        try {
          const kpiEl = document.getElementById('geoOre_kpi');
          const dateEl = document.getElementById('geoOre_date');
          const dailyActualEl = document.getElementById('geoOre_daily_actual');
          const mtdEl = document.getElementById('geoOre_mtd_actual');
          if (!kpiEl || !dateEl || !dailyActualEl || !mtdEl) return;
          const kpi = (kpiEl.value || '').trim();
          const date = (dateEl.value || '').trim();
          const dailyActualRaw = (dailyActualEl.value || '').replace(/,/g, '').trim();
          const dailyActual = parseFloat(dailyActualRaw) || 0;
          if (!kpi || !date || !dailyActualRaw) {
            mtdEl.value = dailyActual.toLocaleString();
            return;
          }
          const d = new Date(date);
          if (isNaN(d)) { mtdEl.value = ''; return; }
          const month = d.getMonth() + 1; // 1 for Jan, etc.
          // find the last (most recent) record with matching KPI and month, excluding editing record
          const records = (state.kpi_records || []).filter(r => {
            if (r.dept !== 'Geology' || r.subtype !== 'ore') return false;
            const rKPI = (r.kpi || '').toString().trim();
            const rMonth = r.month ? parseInt(r.month) : null;
            return rKPI === kpi && rMonth === month && r.id !== editingKPIId;
          }).sort((a, b) => new Date(b.date) - new Date(a.date)); // sort by date descending
          const lastRecord = records[0]; // most recent
          let mtdValue = 0;
          if (lastRecord && lastRecord.mtd_actual) {
            const lastMTD = parseFloat(String(lastRecord.mtd_actual).replace(/,/g, ''));
            if (Number.isFinite(lastMTD)) {
              mtdValue = lastMTD;
            }
          }
          // add current daily actual
          const current = parseFloat(dailyActualRaw);
          if (Number.isFinite(current)) mtdValue += current;
          // set the value with formatting
          mtdEl.value = mtdValue.toLocaleString();
        } catch (e) { console.warn('computeGeoOreMTDActual error', e); }
      }

      // compute MTD Var for Geology Ore: ((MTD Actual - MTD Forecast) / MTD Forecast) * 100
      function computeGeoOreMTDVar() {
        try {
          const mtdActualEl = document.getElementById('geoOre_mtd_actual');
          const mtdForecastEl = document.getElementById('geoOre_mtd_forecast');
          const varEl = document.getElementById('geoOre_var2');
          if (!mtdActualEl || !mtdForecastEl || !varEl) return;
          const aRaw = (mtdActualEl.value || '').replace(/,/g, '').trim();
          const fRaw = (mtdForecastEl.value || '').replace(/,/g, '').trim();
          const a = parseFloat(aRaw);
          const f = parseFloat(fRaw);
          if (Number.isFinite(f) && f !== 0 && Number.isFinite(a)) {
            const v = (a - f) / f;
            varEl.value = Math.round(v * 100) + '%';
          } else {
            varEl.value = '';
          }
        } catch (e) { console.warn('computeGeoOreMTDVar error', e); }
      }

      // compute MTD Forecast for Geology Ore: last record's MTD Forecast + current Daily Forecast
      function computeGeoOreMTDForecast() {
        try {
          const dateEl = document.getElementById('geoOre_date');
          const dailyForecastEl = document.getElementById('geoOre_daily_forecast');
          const mtdForecastEl = document.getElementById('geoOre_mtd_forecast');
          if (!dateEl || !dailyForecastEl || !mtdForecastEl) return;
          const date = (dateEl.value || '').trim();
          if (!date) { mtdForecastEl.value = ''; return; }
          const d = new Date(date);
          if (isNaN(d)) { mtdForecastEl.value = ''; return; }
          const month = d.getMonth() + 1; // 1 for Jan, etc.
          // find the last (most recent) record for the same month
          const records = (state.kpi_records || []).filter(r =>
            r.dept === 'Geology' && r.subtype === 'ore' && (r.month ? parseInt(r.month) : null) === month && r.id !== editingKPIId
          ).sort((a, b) => new Date(b.date) - new Date(a.date));
          const lastRecord = records[0];
          let mtdForecast = 0;
          if (lastRecord && lastRecord.mtd_forecast) {
            const lastMTD = parseFloat(String(lastRecord.mtd_forecast).replace(/,/g, ''));
            if (Number.isFinite(lastMTD)) {
              mtdForecast = lastMTD;
            }
          }
          // add current daily forecast
          const current = parseFloat(String(dailyForecastEl.value || '').replace(/,/g, ''));
          if (Number.isFinite(current)) mtdForecast += current;
          // set the value with formatting
          mtdForecastEl.value = mtdForecast.toLocaleString();
          // compute MTD variance after updating MTD Forecast
          computeGeoOreMTDVar();
        } catch (e) { console.warn('computeGeoOreMTDForecast error', e); }
      }

      // compute Full Var for Geology Ore: ((Outlook - Full Forecast) / Full Forecast) * 100
      function computeGeoOreFullVar() {
        try {
          const outlookEl = document.getElementById('geoOre_outlook');
          const fullForecastEl = document.getElementById('geoOre_fullForecast');
          const varEl = document.getElementById('geoOre_var3');
          if (!outlookEl || !fullForecastEl || !varEl) return;
          const oRaw = (outlookEl.value || '').replace(/,/g, '').trim();
          const fRaw = (fullForecastEl.value || '').replace(/,/g, '').trim();
          const o = parseFloat(oRaw);
          const f = parseFloat(fRaw);
          if (Number.isFinite(f) && f !== 0 && Number.isFinite(o)) {
            const v = (o - f) / f;
            varEl.value = Math.round(v * 100) + '%';
          } else {
            varEl.value = '';
          }
        } catch (e) { console.warn('computeGeoOreFullVar error', e); }
      }

      // update Full Forecast for Geology Ore: get from Fixed Inputs matching KPI and month
      function updateGeoOreFullForecast() {
        try {
          const kpiEl = document.getElementById('geoOre_kpi');
          const dateEl = document.getElementById('geoOre_date');
          const outEl = document.getElementById('geoOre_fullForecast');
          if (!kpiEl || !dateEl || !outEl) return;
          const kpi = (kpiEl.value || '').trim();
          const date = (dateEl.value || '').trim();
          if (!kpi || !date) { outEl.value = ''; return; }
          const d = new Date(date);
          if (isNaN(d)) { outEl.value = ''; return; }
          const month = d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0');
          // find fixed Geology record with matching KPI and month
          const fixed = (state.kpi_records || []).find(r => {
            if (r.dept !== 'Geology') return false;
            if (r.subtype) return false; // only fixed inputs
            const rKPI = (r.kpi || '').toString().trim();
            const rMonth = (r.month || '').toString().trim();
            return rKPI === kpi && rMonth === month;
          });
          if (fixed && (fixed.fullForecast !== undefined && fixed.fullForecast !== null)) {
            outEl.value = fixed.fullForecast;
          } else {
            outEl.value = '';
          }
        } catch (e) { console.warn('updateGeoOreFullForecast error', e); }
      }

      // update Full Budget for Geology Ore: get from Fixed Inputs matching KPI and month
      function updateGeoOreFullBudget() {
        try {
          const kpiEl = document.getElementById('geoOre_kpi');
          const dateEl = document.getElementById('geoOre_date');
          const outEl = document.getElementById('geoOre_fullBudget');
          if (!kpiEl || !dateEl || !outEl) return;
          const kpi = (kpiEl.value || '').trim();
          const date = (dateEl.value || '').trim();
          if (!kpi || !date) { outEl.value = ''; return; }
          const d = new Date(date);
          if (isNaN(d)) { outEl.value = ''; return; }
          const month = d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0');
          // find fixed Geology record with matching KPI and month
          const fixed = (state.kpi_records || []).find(r => {
            if (r.dept !== 'Geology') return false;
            if (r.subtype) return false; // only fixed inputs
            const rKPI = (r.kpi || '').toString().trim();
            const rMonth = (r.month || '').toString().trim();
            return rKPI === kpi && rMonth === month;
          });
          if (fixed && (fixed.fullBudget !== undefined && fixed.fullBudget !== null)) {
            outEl.value = fixed.fullBudget;
          } else {
            outEl.value = '';
          }
        } catch (e) { console.warn('updateGeoOreFullBudget error', e); }
      }

      // update Outlook for Geology Ore
      function updateGeoOreOutlook() {
        try {
          const dateEl = document.getElementById('geoOre_date');
          const actualEl = document.getElementById('geoOre_daily_actual');
          const forecastEl = document.getElementById('geoOre_daily_forecast');
          const fullForecastEl = document.getElementById('geoOre_fullForecast');
          const outlookEl = document.getElementById('geoOre_outlook');
          const kpiEl = document.getElementById('geoOre_kpi');
          if (!dateEl || !actualEl || !forecastEl || !fullForecastEl || !outlookEl || !kpiEl) return;
          const date = (dateEl.value || '').trim();
          const actual = (actualEl.value || '').replace(/,/g, '').trim();
          const forecast = (forecastEl.value || '').replace(/,/g, '').trim();
          const fullForecast = (fullForecastEl.value || '').replace(/,/g, '').trim();
          const kpi = (kpiEl.value || '').trim();
          if (!date || !actual || !forecast || !fullForecast) { outlookEl.value = ''; return; }
          const d = new Date(date);
          if (isNaN(d)) { outlookEl.value = ''; return; }
          const a = parseFloat(actual);
          const f = parseFloat(forecast);
          const ff = parseFloat(fullForecast);
          if (!Number.isFinite(a) || !Number.isFinite(f) || !Number.isFinite(ff)) { outlookEl.value = ''; return; }
          const diff = a - f;
          let outlook = 0;
          if (d.getDate() === 1) {
            // first day of month: (Daily Actual - Daily Forecast) + Full Forecast
            outlook = diff + ff;
          } else {
            // find the last (most recent) record for the same month
            const month = String(d.getMonth() + 1);
            const records = (state.kpi_records || []).filter(r =>
              r.dept === 'Geology' && r.subtype === 'ore' && r.month === month && r.kpi === kpi && r.id !== editingKPIId
            ).sort((a, b) => new Date(b.date) - new Date(a.date)); // sort by date descending
            const lastRecord = records[0]; // most recent
            if (lastRecord && lastRecord.outlook) {
              const lastOutlook = parseFloat(String(lastRecord.outlook).replace(/,/g, ''));
              if (Number.isFinite(lastOutlook)) {
                outlook = lastOutlook + diff;
              } else {
                outlook = diff; // fallback
              }
            } else {
              outlook = diff; // no previous record
            }
          }
          outlookEl.value = outlook.toLocaleString();
        } catch (e) { console.warn('updateGeoOreOutlook error', e); }
      }

      // compute Var for Geology Grade: ((Daily Actual - Daily Forecast) / Daily Forecast) * 100
      function computeGeoGradeVar() {
        try {
          const actualEl = document.getElementById('geoGrade_daily_actual');
          const forecastEl = document.getElementById('geoGrade_daily_forecast');
          const varEl = document.getElementById('geoGrade_var1');
          if (!actualEl || !forecastEl || !varEl) return;
          const aRaw = (actualEl.value || '').replace(/,/g, '').trim();
          const fRaw = (forecastEl.value || '').replace(/,/g, '').trim();
          const a = parseFloat(aRaw);
          const f = parseFloat(fRaw);
          if (Number.isFinite(f) && f !== 0 && Number.isFinite(a)) {
            const v = (a - f) / f;
            varEl.value = Math.round(v * 100) + '%';
          } else {
            varEl.value = '';
          }
        } catch (e) { console.warn('computeGeoGradeVar error', e); }
      }

      // compute MTD Actual for Geology Grade: sum of Daily Actual from records with matching month + current Daily Actual
      function computeGeoGradeMTDActual() {
        try {
          const dateEl = document.getElementById('geoGrade_date');
          const dailyActualEl = document.getElementById('geoGrade_daily_actual');
          const mtdEl = document.getElementById('geoGrade_mtd_actual');
          if (!dateEl || !dailyActualEl || !mtdEl) return;
          const date = (dateEl.value || '').trim();
          const current = parseFloat(String(dailyActualEl.value || '').replace(/,/g, '')) || 0;
          if (!date) {
            mtdEl.value = current.toLocaleString();
            return;
          }
          const d = new Date(date);
          if (isNaN(d)) { mtdEl.value = ''; return; }
          const month = String(d.getMonth() + 1); // 1 for Jan, etc.
          // sum daily_actual from saved records with matching month and dept/subtype, excluding the editing record
          let sum = 0;
          (state.kpi_records || []).forEach(r => {
            if (r.dept === 'Geology' && r.subtype === 'grade' && r.month === month && r.daily_actual && r.id !== editingKPIId) {
              const val = parseFloat(String(r.daily_actual).replace(/,/g, ''));
              if (Number.isFinite(val)) sum += val;
            }
          });
          // add current daily actual
          const cur = parseFloat(String(dailyActualEl.value || '').replace(/,/g, ''));
          if (Number.isFinite(cur)) sum += cur;
          // set the value with formatting
          mtdEl.value = sum.toLocaleString();
          // ensure MTD Forecast is updated, then compute MTD variance
          computeGeoGradeMTDForecast();
          computeGeoGradeMTDVar();
        } catch (e) { console.warn('computeGeoGradeMTDActual error', e); }
      }

      // compute MTD Forecast for Geology Grade: sum of MTD Forecast from records with matching month + current Daily Forecast
      function computeGeoGradeMTDForecast() {
        try {
          const dateEl = document.getElementById('geoGrade_date');
          const dailyForecastEl = document.getElementById('geoGrade_daily_forecast');
          const mtdForecastEl = document.getElementById('geoGrade_mtd_forecast');
          if (!dateEl || !dailyForecastEl || !mtdForecastEl) return;
          const date = (dateEl.value || '').trim();
          if (!date) { mtdForecastEl.value = ''; return; }
          const d = new Date(date);
          if (isNaN(d)) { mtdForecastEl.value = ''; return; }
          const month = String(d.getMonth() + 1); // 1 for Jan, etc.
          // find the last (most recent) record for the same month
          const records = (state.kpi_records || []).filter(r =>
            r.dept === 'Geology' && r.subtype === 'grade' && r.month === month && r.id !== editingKPIId
          ).sort((a, b) => new Date(b.date) - new Date(a.date)); // sort by date descending
          const lastRecord = records[0]; // most recent
          let mtdForecast = 0;
          if (lastRecord && lastRecord.mtd_forecast) {
            const lastMTD = parseFloat(String(lastRecord.mtd_forecast).replace(/,/g, ''));
            if (Number.isFinite(lastMTD)) {
              mtdForecast = lastMTD;
            }
          }
          // add current daily forecast
          const current = parseFloat(String(dailyForecastEl.value || '').replace(/,/g, ''));
          if (Number.isFinite(current)) mtdForecast += current;
          // set the value with formatting
          mtdForecastEl.value = mtdForecast.toLocaleString();
          // compute MTD variance after updating MTD Forecast
          computeGeoGradeMTDVar();
        } catch (e) { console.warn('computeGeoGradeMTDForecast error', e); }
      }

      // compute MTD Var for Geology Grade: ((MTD Actual - MTD Forecast) / MTD Forecast) * 100
      function computeGeoGradeMTDVar() {
        try {
          const mtdActualEl = document.getElementById('geoGrade_mtd_actual');
          const mtdForecastEl = document.getElementById('geoGrade_mtd_forecast');
          const varEl = document.getElementById('geoGrade_var2');
          if (!mtdActualEl || !mtdForecastEl || !varEl) return;
          const aRaw = (mtdActualEl.value || '').replace(/,/g, '').trim();
          const fRaw = (mtdForecastEl.value || '').replace(/,/g, '').trim();
          const a = parseFloat(aRaw);
          const f = parseFloat(fRaw);
          if (Number.isFinite(f) && f !== 0 && Number.isFinite(a)) {
            const v = (a - f) / f;
            varEl.value = Math.round(v * 100) + '%';
          } else {
            varEl.value = '';
          }
        } catch (e) { console.warn('computeGeoGradeMTDVar error', e); }
      }

      // update Full Forecast for Geology Grade: get from Fixed Inputs matching month
      function updateGeoGradeFullForecast() {
        try {
          const dateEl = document.getElementById('geoGrade_date');
          const outEl = document.getElementById('geoGrade_fullForecast');
          if (!dateEl || !outEl) return;
          const date = (dateEl.value || '').trim();
          if (!date) { outEl.value = ''; return; }
          const d = new Date(date);
          if (isNaN(d)) { outEl.value = ''; return; }
          const month = d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0');
          // find fixed Geology record with matching month
          const fixed = (state.kpi_records || []).find(r => {
            if (r.dept !== 'Geology') return false;
            if (r.subtype) return false; // only fixed inputs
            const rMonth = (r.month || '').toString().trim();
            return rMonth === month;
          });
          if (fixed && (fixed.fullForecast !== undefined && fixed.fullForecast !== null)) {
            outEl.value = fixed.fullForecast;
          } else {
            outEl.value = '';
          }
        } catch (e) { console.warn('updateGeoGradeFullForecast error', e); }
      }

      // update Full Budget for Geology Grade: get from Fixed Inputs matching month
      function updateGeoGradeFullBudget() {
        try {
          const dateEl = document.getElementById('geoGrade_date');
          const outEl = document.getElementById('geoGrade_fullBudget');
          if (!dateEl || !outEl) return;
          const date = (dateEl.value || '').trim();
          if (!date) { outEl.value = ''; return; }
          const d = new Date(date);
          if (isNaN(d)) { outEl.value = ''; return; }
          const month = d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0');
          // find fixed Geology record with matching month
          const fixed = (state.kpi_records || []).find(r => {
            if (r.dept !== 'Geology') return false;
            if (r.subtype) return false; // only fixed inputs
            const rMonth = (r.month || '').toString().trim();
            return rMonth === month;
          });
          if (fixed && (fixed.fullBudget !== undefined && fixed.fullBudget !== null)) {
            outEl.value = fixed.fullBudget;
          } else {
            outEl.value = '';
          }
        } catch (e) { console.warn('updateGeoGradeFullBudget error', e); }
      }

      // update Outlook for Geology Grade
      function updateGeoGradeOutlook() {
        try {
          const dateEl = document.getElementById('geoGrade_date');
          const actualEl = document.getElementById('geoGrade_daily_actual');
          const forecastEl = document.getElementById('geoGrade_daily_forecast');
          const fullForecastEl = document.getElementById('geoGrade_fullForecast');
          const outlookEl = document.getElementById('geoGrade_outlook');
          if (!dateEl || !actualEl || !forecastEl || !fullForecastEl || !outlookEl) return;
          const date = (dateEl.value || '').trim();
          const actual = (actualEl.value || '').replace(/,/g, '').trim();
          const forecast = (forecastEl.value || '').replace(/,/g, '').trim();
          const fullForecast = (fullForecastEl.value || '').replace(/,/g, '').trim();
          if (!date || !actual || !forecast || !fullForecast) { outlookEl.value = ''; return; }
          const d = new Date(date);
          if (isNaN(d)) { outlookEl.value = ''; return; }
          const a = parseFloat(actual);
          const f = parseFloat(forecast);
          const ff = parseFloat(fullForecast);
          if (!Number.isFinite(a) || !Number.isFinite(f) || !Number.isFinite(ff)) { outlookEl.value = ''; return; }
          const diff = a - f;
          let outlook = 0;
          if (d.getDate() === 1) {
            // first day of month: (Daily Actual - Daily Forecast) + Full Forecast
            outlook = diff + ff;
          } else {
            // find the last (most recent) record for the same month
            const month = String(d.getMonth() + 1);
            const records = (state.kpi_records || []).filter(r =>
              r.dept === 'Geology' && r.subtype === 'grade' && r.month === month && r.id !== editingKPIId
            ).sort((a, b) => new Date(b.date) - new Date(a.date)); // sort by date descending
            const lastRecord = records[0]; // most recent
            if (lastRecord && lastRecord.outlook) {
              const lastOutlook = parseFloat(String(lastRecord.outlook).replace(/,/g, ''));
              if (Number.isFinite(lastOutlook)) {
                outlook = lastOutlook + diff;
              } else {
                outlook = diff; // fallback
              }
            } else {
              outlook = diff; // no previous record
            }
          }
          outlookEl.value = outlook.toLocaleString();
          // compute Full Var after updating Outlook
          computeGeoGradeFullVar();
        } catch (e) { console.warn('updateGeoGradeOutlook error', e); }
      }

      // compute Full Var for Geology Grade: ((Outlook - Full Forecast) / Full Forecast) * 100
      function computeGeoGradeFullVar() {
        try {
          const outlookEl = document.getElementById('geoGrade_outlook');
          const fullForecastEl = document.getElementById('geoGrade_fullForecast');
          const varEl = document.getElementById('geoGrade_var3');
          if (!outlookEl || !fullForecastEl || !varEl) return;
          const oRaw = (outlookEl.value || '').replace(/,/g, '').trim();
          const fRaw = (fullForecastEl.value || '').replace(/,/g, '').trim();
          const o = parseFloat(oRaw);
          const f = parseFloat(fRaw);
          if (Number.isFinite(f) && f !== 0 && Number.isFinite(o)) {
            const v = (o - f) / f;
            varEl.value = Math.round(v * 100) + '%';
          } else {
            varEl.value = '';
          }
        } catch (e) { console.warn('computeGeoGradeFullVar error', e); }
      }

      // update Month for Geology Grade: based on date
      function updateGeoGradeMonth() {
        try {
          const dateEl = document.getElementById('geoGrade_date');
          const monthEl = document.getElementById('geoGrade_month');
          if (!dateEl || !monthEl) return;
          const date = (dateEl.value || '').trim();
          if (!date) { monthEl.value = ''; return; }
          const d = new Date(date);
          if (isNaN(d)) { monthEl.value = ''; return; }
          monthEl.value = d.getMonth() + 1; // 1 for Jan, 2 for Feb, etc.
        } catch (e) { console.warn('updateGeoGradeMonth error', e); }
      }

      // Geology grade form save/clear (vertical inputs)
      const btnGeologyGradeClear = document.getElementById('btnGeologyGradeClear');
      if (btnGeologyGradeClear) btnGeologyGradeClear.addEventListener('click', () => {
        ['geoGrade_kpi', 'geoGrade_date', 'geoGrade_rig', 'geoGrade_daily_actual', 'geoGrade_daily_forecast', 'geoGrade_var1', 'geoGrade_mtd_actual', 'geoGrade_mtd_forecast', 'geoGrade_var2', 'geoGrade_outlook', 'geoGrade_fullForecast', 'geoGrade_fullBudget', 'geoGrade_var3', 'geoGrade_month'].forEach(id => { const el = document.getElementById(id); if (el) el.value = ''; });
        const k = document.getElementById('geoGrade_kpi'); if (k) k.value = 'Exploration Drilling';
      });
      const btnGeologyGradeSave = document.getElementById('btnGeologyGradeSave');
      if (btnGeologyGradeSave) btnGeologyGradeSave.addEventListener('click', () => {
        const kpi = (document.getElementById('geoGrade_kpi') || {}).value || '';
        const date = (document.getElementById('geoGrade_date') || {}).value || '';
        const rig = (document.getElementById('geoGrade_rig') || {}).value || '';
        const daily_actual = (document.getElementById('geoGrade_daily_actual') || {}).value || '';
        const daily_forecast = (document.getElementById('geoGrade_daily_forecast') || {}).value || '';
        const var1 = (document.getElementById('geoGrade_var1') || {}).value || '';
        const mtd_actual = (document.getElementById('geoGrade_mtd_actual') || {}).value || '';
        const mtd_forecast = (document.getElementById('geoGrade_mtd_forecast') || {}).value || '';
        const var2 = (document.getElementById('geoGrade_var2') || {}).value || '';
        const outlook = (document.getElementById('geoGrade_outlook') || {}).value || '';
        const fullForecast = (document.getElementById('geoGrade_fullForecast') || {}).value || '';
        const fullBudget = (document.getElementById('geoGrade_fullBudget') || {}).value || '';
        const var3 = (document.getElementById('geoGrade_var3') || {}).value || '';
        const month = (document.getElementById('geoGrade_month') || {}).value || '';
        if (!kpi) { alert('Enter KPI'); return; }
        const rec = { subtype: 'grade', kpi, date, rig, daily_actual, daily_forecast, var1, mtd_actual, mtd_forecast, var2, outlook, fullForecast, fullBudget, var3, month };
        if (editingKPIId) {
          const existing = (state.kpi_records || []).find(r => r.id === editingKPIId);
          if (existing && existing.subtype === 'grade') rec.id = editingKPIId;
        }
        addKPIRecord('Geology', rec);
        ['geoGrade_kpi', 'geoGrade_date', 'geoGrade_rig', 'geoGrade_daily_actual', 'geoGrade_daily_forecast', 'geoGrade_var1', 'geoGrade_mtd_actual', 'geoGrade_mtd_forecast', 'geoGrade_var2', 'geoGrade_outlook', 'geoGrade_fullForecast', 'geoGrade_fullBudget', 'geoGrade_var3', 'geoGrade_month'].forEach(id => { const el = document.getElementById(id); if (el) el.value = ''; });
        editingKPIId = null;
        alert('Grade record saved');
      });

      // Geology ore form save/clear (vertical inputs)
      const btnGeologyOreClear = document.getElementById('btnGeologyOreClear');
      if (btnGeologyOreClear) btnGeologyOreClear.addEventListener('click', () => {
        ['geoOre_kpi', 'geoOre_date', 'geoOre_rig', 'geoOre_daily_actual', 'geoOre_daily_forecast', 'geoOre_var1', 'geoOre_mtd_actual', 'geoOre_mtd_forecast', 'geoOre_var2', 'geoOre_outlook', 'geoOre_fullForecast', 'geoOre_fullBudget', 'geoOre_var3', 'geoOre_month'].forEach(id => { const el = document.getElementById(id); if (el) el.value = ''; });
        const k = document.getElementById('geoOre_kpi'); if (k) k.value = 'Grade Control Drilling';
      });
      const btnGeologyOreSave = document.getElementById('btnGeologyOreSave');
      if (btnGeologyOreSave) btnGeologyOreSave.addEventListener('click', () => {
        const kpi = (document.getElementById('geoOre_kpi') || {}).value || '';
        const date = (document.getElementById('geoOre_date') || {}).value || '';
        const rig = (document.getElementById('geoOre_rig') || {}).value || '';
        const daily_actual = (document.getElementById('geoOre_daily_actual') || {}).value || '';
        const daily_forecast = (document.getElementById('geoOre_daily_forecast') || {}).value || '';
        const var1 = (document.getElementById('geoOre_var1') || {}).value || '';
        const mtd_actual = (document.getElementById('geoOre_mtd_actual') || {}).value || '';
        const mtd_forecast = (document.getElementById('geoOre_mtd_forecast') || {}).value || '';
        const var2 = (document.getElementById('geoOre_var2') || {}).value || '';
        const outlook = (document.getElementById('geoOre_outlook') || {}).value || '';
        const fullForecast = (document.getElementById('geoOre_fullForecast') || {}).value || '';
        const fullBudget = (document.getElementById('geoOre_fullBudget') || {}).value || '';
        const var3 = (document.getElementById('geoOre_var3') || {}).value || '';
        const month = (document.getElementById('geoOre_month') || {}).value || '';
        if (!kpi) { alert('Enter KPI'); return; }
        const rec = { subtype: 'ore', kpi, date, rig, daily_actual, daily_forecast, var1, mtd_actual, mtd_forecast, var2, outlook, fullForecast, fullBudget, var3, month };
        if (editingKPIId) {
          const existing = (state.kpi_records || []).find(r => r.id === editingKPIId);
          if (existing && existing.subtype === 'ore') rec.id = editingKPIId;
        }
        addKPIRecord('Geology', rec);
        ['geoOre_kpi', 'geoOre_date', 'geoOre_daily_actual', 'geoOre_daily_forecast', 'geoOre_var1', 'geoOre_mtd_actual', 'geoOre_mtd_forecast', 'geoOre_var2', 'geoOre_outlook', 'geoOre_fullForecast', 'geoOre_fullBudget', 'geoOre_var3', 'geoOre_month'].forEach(id => { const el = document.getElementById(id); if (el) el.value = ''; });
        editingKPIId = null;
        alert('Ore record saved');
      });

      // Geology toll form save/clear (vertical inputs)
      const btnGeologyTollClear = document.getElementById('btnGeologyTollClear');
      if (btnGeologyTollClear) btnGeologyTollClear.addEventListener('click', () => {
        const toClear = ['geoToll_date', 'geoToll_wetTonnes', 'geoToll_daily_actual', 'geoToll_daily_forecast', 'geoToll_var1', 'geoToll_mtd_actual', 'geoToll_mtd_forecast', 'geoToll_var2', 'geoToll_outlook', 'geoToll_fullForecast', 'geoToll_fullBudget', 'geoToll_var3', 'geoToll_grade', 'geoToll_gradeDay7'];
        toClear.forEach(id => { const el = document.getElementById(id); if (el) el.value = ''; });
        // KPI should retain default label
        const k = document.getElementById('geoToll_kpi'); if (k) k.value = 'Toll';
      });
      const btnGeologyTollSave = document.getElementById('btnGeologyTollSave');
      if (btnGeologyTollSave) btnGeologyTollSave.addEventListener('click', () => {
        const kpi = (document.getElementById('geoToll_kpi') || {}).value || '';
        const date = (document.getElementById('geoToll_date') || {}).value || '';
        const wetTonnes = (document.getElementById('geoToll_wetTonnes') || {}).value || '';
        const daily_actual = (document.getElementById('geoToll_daily_actual') || {}).value || (document.getElementById('geoToll_daily_actual') || {}).placeholder || '';
        const daily_forecast = (document.getElementById('geoToll_daily_forecast') || {}).value || (document.getElementById('geoToll_daily_forecast') || {}).placeholder || '';
        const var1 = (document.getElementById('geoToll_var1') || {}).value || (document.getElementById('geoToll_var1') || {}).placeholder || '';
        const mtd_actual = (document.getElementById('geoToll_mtd_actual') || {}).value || (document.getElementById('geoToll_mtd_actual') || {}).placeholder || '';
        const mtd_forecast = (document.getElementById('geoToll_mtd_forecast') || {}).value || (document.getElementById('geoToll_mtd_forecast') || {}).placeholder || '';
        const var2 = (document.getElementById('geoToll_var2') || {}).value || (document.getElementById('geoToll_var2') || {}).placeholder || '';
        const outlook = (document.getElementById('geoToll_outlook') || {}).value || (document.getElementById('geoToll_outlook') || {}).placeholder || '';
        const fullForecast = (document.getElementById('geoToll_fullForecast') || {}).value || (document.getElementById('geoToll_fullForecast') || {}).placeholder || '';
        const fullBudget = (document.getElementById('geoToll_fullBudget') || {}).value || (document.getElementById('geoToll_fullBudget') || {}).placeholder || '';
        const var3 = (document.getElementById('geoToll_var3') || {}).value || (document.getElementById('geoToll_var3') || {}).placeholder || '';
        const grade = (document.getElementById('geoToll_grade') || {}).value || '';
        const gradeDay7 = (document.getElementById('geoToll_gradeDay7') || {}).value || (document.getElementById('geoToll_gradeDay7') || {}).placeholder || '';
        if (!kpi) { alert('Enter KPI'); return; }
        const rec = { subtype: 'toll', kpi, date, wetTonnes, daily_actual, daily_forecast, var1, mtd_actual, mtd_forecast, var2, outlook, fullForecast, fullBudget, var3, grade, gradeDay7 };
        if (editingKPIId) {
          const existing = (state.kpi_records || []).find(r => r.id === editingKPIId);
          if (existing && existing.subtype === 'toll') rec.id = editingKPIId;
        }
        addKPIRecord('Geology', rec);
        const cleared = ['geoToll_date', 'geoToll_wetTonnes', 'geoToll_daily_actual', 'geoToll_daily_forecast', 'geoToll_var1', 'geoToll_mtd_actual', 'geoToll_mtd_forecast', 'geoToll_var2', 'geoToll_outlook', 'geoToll_fullForecast', 'geoToll_fullBudget', 'geoToll_var3', 'geoToll_grade', 'geoToll_gradeDay7'];
        cleared.forEach(id => { const el = document.getElementById(id); if (el) el.value = ''; });
        // preserve default KPI label
        const k = document.getElementById('geoToll_kpi'); if (k) k.value = 'Toll';
        editingKPIId = null;
        alert('Toll record saved');
      });

      // Mining ore-mined form save/clear
      const btnMiningOreMinedClear = document.getElementById('btnMiningOreMinedClear');
      if (btnMiningOreMinedClear) btnMiningOreMinedClear.addEventListener('click', () => {
        ['miningOreMined_kpi', 'miningOreMined_date', 'miningOreMined_daily_actual', 'miningOreMined_daily_forecast', 'miningOreMined_var1', 'miningOreMined_mtd_actual', 'miningOreMined_mtd_forecast', 'miningOreMined_var2', 'miningOreMined_outlook', 'miningOreMined_fullForecast', 'miningOreMined_fullBudget', 'miningOreMined_var3', 'miningOreMined_month'].forEach(id => { const el = document.getElementById(id); if (el) el.value = ''; });
        const k = document.getElementById('miningOreMined_kpi'); if (k) k.value = 'Ore Mined';
      });
      const btnMiningOreMinedSave = document.getElementById('btnMiningOreMinedSave');
      if (btnMiningOreMinedSave) btnMiningOreMinedSave.addEventListener('click', () => {
        const kpi = (document.getElementById('miningOreMined_kpi') || {}).value || '';
        const date = (document.getElementById('miningOreMined_date') || {}).value || '';
        const daily_actual = (document.getElementById('miningOreMined_daily_actual') || {}).value || (document.getElementById('miningOreMined_daily_actual') || {}).placeholder || '';
        const daily_forecast = (document.getElementById('miningOreMined_daily_forecast') || {}).value || (document.getElementById('miningOreMined_daily_forecast') || {}).placeholder || '';
        const var1 = (document.getElementById('miningOreMined_var1') || {}).value || (document.getElementById('miningOreMined_var1') || {}).placeholder || '';
        const mtd_actual = (document.getElementById('miningOreMined_mtd_actual') || {}).value || (document.getElementById('miningOreMined_mtd_actual') || {}).placeholder || '';
        const mtd_forecast = (document.getElementById('miningOreMined_mtd_forecast') || {}).value || (document.getElementById('miningOreMined_mtd_forecast') || {}).placeholder || '';
        const var2 = (document.getElementById('miningOreMined_var2') || {}).value || (document.getElementById('miningOreMined_var2') || {}).placeholder || '';
        const outlook = (document.getElementById('miningOreMined_outlook') || {}).value || (document.getElementById('miningOreMined_outlook') || {}).placeholder || '';
        const fullForecast = (document.getElementById('miningOreMined_fullForecast') || {}).value || (document.getElementById('miningOreMined_fullForecast') || {}).placeholder || '';
        const fullBudget = (document.getElementById('miningOreMined_fullBudget') || {}).value || (document.getElementById('miningOreMined_fullBudget') || {}).placeholder || '';
        const var3 = (document.getElementById('miningOreMined_var3') || {}).value || (document.getElementById('miningOreMined_var3') || {}).placeholder || '';
        const month = (document.getElementById('miningOreMined_month') || {}).value || (document.getElementById('miningOreMined_month') || {}).placeholder || '';
        if (!kpi) { alert('Enter KPI'); return; }
        const rec = { subtype: 'ore-mined', kpi, date, daily_actual, daily_forecast, var1, mtd_actual, mtd_forecast, var2, outlook, fullForecast, fullBudget, var3, month };
        if (editingKPIId) {
          const existing = (state.kpi_records || []).find(r => r.id === editingKPIId);
          if (existing && existing.subtype === 'ore-mined') rec.id = editingKPIId;
        }
        addKPIRecord('Mining', rec);
        ['miningOreMined_kpi', 'miningOreMined_date', 'miningOreMined_daily_actual', 'miningOreMined_daily_forecast', 'miningOreMined_var1', 'miningOreMined_mtd_actual', 'miningOreMined_mtd_forecast', 'miningOreMined_var2', 'miningOreMined_outlook', 'miningOreMined_fullForecast', 'miningOreMined_fullBudget', 'miningOreMined_var3', 'miningOreMined_month'].forEach(id => { const el = document.getElementById(id); if (el) el.value = ''; });
        editingKPIId = null;
        alert('Ore Mined record saved');
      });

      // Event listener for miningOreMined_date to populate Full Forecast and Full Budget from Fixed Inputs, and calculate Daily Forecast
      const miningOreMinedDate = document.getElementById('miningOreMined_date');
      if (miningOreMinedDate) miningOreMinedDate.addEventListener('change', () => {
        const dateVal = miningOreMinedDate.value;
        if (!dateVal) return;
        const month = dateVal.substring(0, 7); // YYYY-MM
        const year = parseInt(dateVal.substring(0, 4));
        const mon = parseInt(dateVal.substring(5, 7));
        const daysInMonth = new Date(year, mon, 0).getDate();
        const fixedRecord = (state.kpi_records || []).find(r => r.dept === 'Mining' && r.kpi === 'Ore Mined' && r.month === month);
        if (fixedRecord) {
          const ff = document.getElementById('miningOreMined_fullForecast');
          if (ff) ff.value = fixedRecord.fullForecast || '';
          const fb = document.getElementById('miningOreMined_fullBudget');
          if (fb) fb.value = fixedRecord.fullBudget || '';
          // Calculate Daily Forecast from Full Forecast divided by days in month
          if (ff && ff.value) {
            const fullForecastVal = parseFloat(ff.value.replace(/,/g, ''));
            if (!isNaN(fullForecastVal)) {
              const dailyForecastVal = fullForecastVal / daysInMonth;
              const df = document.getElementById('miningOreMined_daily_forecast');
              if (df) df.value = Math.round(dailyForecastVal);
            }
          }
        }
      });

      // Function to format number with commas
      function formatNumber(num) {
        return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
      }

      // Event listener for miningOreMined_daily_actual to calculate variance and format
      const miningOreMinedDailyActual = document.getElementById('miningOreMined_daily_actual');
      if (miningOreMinedDailyActual) {
        miningOreMinedDailyActual.addEventListener('input', () => {
          const daVal = parseFloat(miningOreMinedDailyActual.value.replace(/,/g, ''));
          const dfEl = document.getElementById('miningOreMined_daily_forecast');
          const dfVal = dfEl ? parseFloat(dfEl.value.replace(/,/g, '')) : NaN;
          if (!isNaN(daVal) && !isNaN(dfVal) && dfVal !== 0) {
            const variance = ((daVal - dfVal) / dfVal) * 100;
            const varEl = document.getElementById('miningOreMined_var1');
            if (varEl) varEl.value = Math.round(variance) + '%';
          }
        });
        miningOreMinedDailyActual.addEventListener('blur', () => {
          const val = parseFloat(miningOreMinedDailyActual.value.replace(/,/g, ''));
          if (!isNaN(val) && val >= 1000) {
            miningOreMinedDailyActual.value = formatNumber(val);
          }
        });
      }

      // Event listener for miningOreMined_daily_forecast to format
      const miningOreMinedDailyForecast = document.getElementById('miningOreMined_daily_forecast');
      if (miningOreMinedDailyForecast) {
        miningOreMinedDailyForecast.addEventListener('blur', () => {
          const val = parseFloat(miningOreMinedDailyForecast.value.replace(/,/g, ''));
          if (!isNaN(val) && val >= 1000) {
            miningOreMinedDailyForecast.value = formatNumber(val);
          }
        });
      }

      // Mining grade-ore-mined form save/clear
      const btnMiningGradeOreMinedClear = document.getElementById('btnMiningGradeOreMinedClear');
      if (btnMiningGradeOreMinedClear) btnMiningGradeOreMinedClear.addEventListener('click', () => {
        ['miningGradeOreMined_kpi', 'miningGradeOreMined_date', 'miningGradeOreMined_daily_actual', 'miningGradeOreMined_daily_forecast', 'miningGradeOreMined_var1', 'miningGradeOreMined_mtd_actual', 'miningGradeOreMined_mtd_forecast', 'miningGradeOreMined_var2', 'miningGradeOreMined_outlook', 'miningGradeOreMined_fullForecast', 'miningGradeOreMined_fullBudget', 'miningGradeOreMined_var3', 'miningGradeOreMined_month'].forEach(id => { const el = document.getElementById(id); if (el) el.value = ''; });
        const k = document.getElementById('miningGradeOreMined_kpi'); if (k) k.value = 'Grade - Ore Mined';
      });
      const btnMiningGradeOreMinedSave = document.getElementById('btnMiningGradeOreMinedSave');
      if (btnMiningGradeOreMinedSave) btnMiningGradeOreMinedSave.addEventListener('click', () => {
        const kpi = (document.getElementById('miningGradeOreMined_kpi') || {}).value || '';
        const date = (document.getElementById('miningGradeOreMined_date') || {}).value || '';
        const daily_actual = (document.getElementById('miningGradeOreMined_daily_actual') || {}).value || (document.getElementById('miningGradeOreMined_daily_actual') || {}).placeholder || '';
        const daily_forecast = (document.getElementById('miningGradeOreMined_daily_forecast') || {}).value || (document.getElementById('miningGradeOreMined_daily_forecast') || {}).placeholder || '';
        const var1 = (document.getElementById('miningGradeOreMined_var1') || {}).value || (document.getElementById('miningGradeOreMined_var1') || {}).placeholder || '';
        const mtd_actual = (document.getElementById('miningGradeOreMined_mtd_actual') || {}).value || (document.getElementById('miningGradeOreMined_mtd_actual') || {}).placeholder || '';
        const mtd_forecast = (document.getElementById('miningGradeOreMined_mtd_forecast') || {}).value || (document.getElementById('miningGradeOreMined_mtd_forecast') || {}).placeholder || '';
        const var2 = (document.getElementById('miningGradeOreMined_var2') || {}).value || (document.getElementById('miningGradeOreMined_var2') || {}).placeholder || '';
        const outlook = (document.getElementById('miningGradeOreMined_outlook') || {}).value || (document.getElementById('miningGradeOreMined_outlook') || {}).placeholder || '';
        const fullForecast = (document.getElementById('miningGradeOreMined_fullForecast') || {}).value || (document.getElementById('miningGradeOreMined_fullForecast') || {}).placeholder || '';
        const fullBudget = (document.getElementById('miningGradeOreMined_fullBudget') || {}).value || (document.getElementById('miningGradeOreMined_fullBudget') || {}).placeholder || '';
        const var3 = (document.getElementById('miningGradeOreMined_var3') || {}).value || (document.getElementById('miningGradeOreMined_var3') || {}).placeholder || '';
        const month = (document.getElementById('miningGradeOreMined_month') || {}).value || (document.getElementById('miningGradeOreMined_month') || {}).placeholder || '';
        if (!kpi) { alert('Enter KPI'); return; }
        const rec = { subtype: 'grade-ore-mined', kpi, date, daily_actual, daily_forecast, var1, mtd_actual, mtd_forecast, var2, outlook, fullForecast, fullBudget, var3, month };
        if (editingKPIId) {
          const existing = (state.kpi_records || []).find(r => r.id === editingKPIId);
          if (existing && existing.subtype === 'grade-ore-mined') rec.id = editingKPIId;
        }
        addKPIRecord('Mining', rec);
        ['miningGradeOreMined_kpi', 'miningGradeOreMined_date', 'miningGradeOreMined_daily_actual', 'miningGradeOreMined_daily_forecast', 'miningGradeOreMined_var1', 'miningGradeOreMined_mtd_actual', 'miningGradeOreMined_mtd_forecast', 'miningGradeOreMined_var2', 'miningGradeOreMined_outlook', 'miningGradeOreMined_fullForecast', 'miningGradeOreMined_fullBudget', 'miningGradeOreMined_var3', 'miningGradeOreMined_month'].forEach(id => { const el = document.getElementById(id); if (el) el.value = ''; });
        editingKPIId = null;
        alert('Grade - Ore Mined record saved');
      });

      // Event listener for miningGradeOreMined_date to populate Full Forecast and Full Budget from Fixed Inputs, and calculate Daily Forecast
      const miningGradeOreMinedDate = document.getElementById('miningGradeOreMined_date');
      if (miningGradeOreMinedDate) miningGradeOreMinedDate.addEventListener('change', () => {
        const dateVal = miningGradeOreMinedDate.value;
        if (!dateVal) return;
        const month = dateVal.substring(0, 7); // YYYY-MM
        const year = parseInt(dateVal.substring(0, 4));
        const mon = parseInt(dateVal.substring(5, 7));
        const daysInMonth = new Date(year, mon, 0).getDate();
        const fixedRecord = (state.kpi_records || []).find(r => r.dept === 'Mining' && r.kpi === 'Grade - Ore Mined' && r.month === month);
        if (fixedRecord) {
          const ff = document.getElementById('miningGradeOreMined_fullForecast');
          if (ff) ff.value = fixedRecord.fullForecast || '';
          const fb = document.getElementById('miningGradeOreMined_fullBudget');
          if (fb) fb.value = fixedRecord.fullBudget || '';
          // Calculate Daily Forecast from Full Forecast divided by days in month
          if (ff && ff.value) {
            const fullForecastVal = parseFloat(ff.value.replace(/,/g, ''));
            if (!isNaN(fullForecastVal)) {
              const dailyForecastVal = fullForecastVal / daysInMonth;
              const df = document.getElementById('miningGradeOreMined_daily_forecast');
              if (df) df.value = Math.round(dailyForecastVal);
            }
          }
        }
      });

      // Event listener for miningGradeOreMined_daily_actual to calculate variance and format
      const miningGradeOreMinedDailyActual = document.getElementById('miningGradeOreMined_daily_actual');
      if (miningGradeOreMinedDailyActual) {
        miningGradeOreMinedDailyActual.addEventListener('input', () => {
          const daVal = parseFloat(miningGradeOreMinedDailyActual.value.replace(/,/g, ''));
          const dfEl = document.getElementById('miningGradeOreMined_daily_forecast');
          const dfVal = dfEl ? parseFloat(dfEl.value.replace(/,/g, '')) : NaN;
          if (!isNaN(daVal) && !isNaN(dfVal) && dfVal !== 0) {
            const variance = ((daVal - dfVal) / dfVal) * 100;
            const varEl = document.getElementById('miningGradeOreMined_var1');
            if (varEl) varEl.value = Math.round(variance) + '%';
          }
        });
        miningGradeOreMinedDailyActual.addEventListener('blur', () => {
          const val = parseFloat(miningGradeOreMinedDailyActual.value.replace(/,/g, ''));
          if (!isNaN(val) && val >= 1000) {
            miningGradeOreMinedDailyActual.value = formatNumber(val);
          }
        });
      }

      // Event listener for miningGradeOreMined_daily_forecast to format
      const miningGradeOreMinedDailyForecast = document.getElementById('miningGradeOreMined_daily_forecast');
      if (miningGradeOreMinedDailyForecast) {
        miningGradeOreMinedDailyForecast.addEventListener('blur', () => {
          const val = parseFloat(miningGradeOreMinedDailyForecast.value.replace(/,/g, ''));
          if (!isNaN(val) && val >= 1000) {
            miningGradeOreMinedDailyForecast.value = formatNumber(val);
          }
        });
      }

      // Mining total-material-moved form save/clear
      const btnMiningTotalMaterialMovedClear = document.getElementById('btnMiningTotalMaterialMovedClear');
      if (btnMiningTotalMaterialMovedClear) btnMiningTotalMaterialMovedClear.addEventListener('click', () => {
        ['miningTotalMaterialMoved_kpi', 'miningTotalMaterialMoved_date', 'miningTotalMaterialMoved_daily_actual', 'miningTotalMaterialMoved_daily_forecast', 'miningTotalMaterialMoved_var1', 'miningTotalMaterialMoved_mtd_actual', 'miningTotalMaterialMoved_mtd_forecast', 'miningTotalMaterialMoved_var2', 'miningTotalMaterialMoved_outlook', 'miningTotalMaterialMoved_fullForecast', 'miningTotalMaterialMoved_fullBudget', 'miningTotalMaterialMoved_var3', 'miningTotalMaterialMoved_month'].forEach(id => { const el = document.getElementById(id); if (el) el.value = ''; });
        const k = document.getElementById('miningTotalMaterialMoved_kpi'); if (k) k.value = 'Total Material Moved';
      });
      const btnMiningTotalMaterialMovedSave = document.getElementById('btnMiningTotalMaterialMovedSave');
      if (btnMiningTotalMaterialMovedSave) btnMiningTotalMaterialMovedSave.addEventListener('click', () => {
        const kpi = (document.getElementById('miningTotalMaterialMoved_kpi') || {}).value || '';
        const date = (document.getElementById('miningTotalMaterialMoved_date') || {}).value || '';
        const daily_actual = (document.getElementById('miningTotalMaterialMoved_daily_actual') || {}).value || (document.getElementById('miningTotalMaterialMoved_daily_actual') || {}).placeholder || '';
        const daily_forecast = (document.getElementById('miningTotalMaterialMoved_daily_forecast') || {}).value || (document.getElementById('miningTotalMaterialMoved_daily_forecast') || {}).placeholder || '';
        const var1 = (document.getElementById('miningTotalMaterialMoved_var1') || {}).value || (document.getElementById('miningTotalMaterialMoved_var1') || {}).placeholder || '';
        const mtd_actual = (document.getElementById('miningTotalMaterialMoved_mtd_actual') || {}).value || (document.getElementById('miningTotalMaterialMoved_mtd_actual') || {}).placeholder || '';
        const mtd_forecast = (document.getElementById('miningTotalMaterialMoved_mtd_forecast') || {}).value || (document.getElementById('miningTotalMaterialMoved_mtd_forecast') || {}).placeholder || '';
        const var2 = (document.getElementById('miningTotalMaterialMoved_var2') || {}).value || (document.getElementById('miningTotalMaterialMoved_var2') || {}).placeholder || '';
        const outlook = (document.getElementById('miningTotalMaterialMoved_outlook') || {}).value || (document.getElementById('miningTotalMaterialMoved_outlook') || {}).placeholder || '';
        const fullForecast = (document.getElementById('miningTotalMaterialMoved_fullForecast') || {}).value || (document.getElementById('miningTotalMaterialMoved_fullForecast') || {}).placeholder || '';
        const fullBudget = (document.getElementById('miningTotalMaterialMoved_fullBudget') || {}).value || (document.getElementById('miningTotalMaterialMoved_fullBudget') || {}).placeholder || '';
        const var3 = (document.getElementById('miningTotalMaterialMoved_var3') || {}).value || (document.getElementById('miningTotalMaterialMoved_var3') || {}).placeholder || '';
        const month = (document.getElementById('miningTotalMaterialMoved_month') || {}).value || (document.getElementById('miningTotalMaterialMoved_month') || {}).placeholder || '';
        if (!kpi) { alert('Enter KPI'); return; }
        const rec = { subtype: 'total-material-moved', kpi, date, daily_actual, daily_forecast, var1, mtd_actual, mtd_forecast, var2, outlook, fullForecast, fullBudget, var3, month };
        if (editingKPIId) {
          const existing = (state.kpi_records || []).find(r => r.id === editingKPIId);
          if (existing && existing.subtype === 'total-material-moved') rec.id = editingKPIId;
        }
        addKPIRecord('Mining', rec);
        ['miningTotalMaterialMoved_kpi', 'miningTotalMaterialMoved_date', 'miningTotalMaterialMoved_daily_actual', 'miningTotalMaterialMoved_daily_forecast', 'miningTotalMaterialMoved_var1', 'miningTotalMaterialMoved_mtd_actual', 'miningTotalMaterialMoved_mtd_forecast', 'miningTotalMaterialMoved_var2', 'miningTotalMaterialMoved_outlook', 'miningTotalMaterialMoved_fullForecast', 'miningTotalMaterialMoved_fullBudget', 'miningTotalMaterialMoved_var3', 'miningTotalMaterialMoved_month'].forEach(id => { const el = document.getElementById(id); if (el) el.value = ''; });
        editingKPIId = null;
        alert('Total Material Moved record saved');
      });

      // Mining blast-hole-drilling form save/clear
      const btnMiningBlastHoleDrillingClear = document.getElementById('btnMiningBlastHoleDrillingClear');
      if (btnMiningBlastHoleDrillingClear) btnMiningBlastHoleDrillingClear.addEventListener('click', () => {
        ['miningBlastHoleDrilling_kpi', 'miningBlastHoleDrilling_date', 'miningBlastHoleDrilling_daily_actual', 'miningBlastHoleDrilling_daily_forecast', 'miningBlastHoleDrilling_var1', 'miningBlastHoleDrilling_mtd_actual', 'miningBlastHoleDrilling_mtd_forecast', 'miningBlastHoleDrilling_var2', 'miningBlastHoleDrilling_outlook', 'miningBlastHoleDrilling_fullForecast', 'miningBlastHoleDrilling_fullBudget', 'miningBlastHoleDrilling_var3', 'miningBlastHoleDrilling_month'].forEach(id => { const el = document.getElementById(id); if (el) el.value = ''; });
        const k = document.getElementById('miningBlastHoleDrilling_kpi'); if (k) k.value = 'Blast Hole Drilling';
      });
      const btnMiningBlastHoleDrillingSave = document.getElementById('btnMiningBlastHoleDrillingSave');
      if (btnMiningBlastHoleDrillingSave) btnMiningBlastHoleDrillingSave.addEventListener('click', () => {
        const kpi = (document.getElementById('miningBlastHoleDrilling_kpi') || {}).value || '';
        const date = (document.getElementById('miningBlastHoleDrilling_date') || {}).value || '';
        const daily_actual = (document.getElementById('miningBlastHoleDrilling_daily_actual') || {}).value || (document.getElementById('miningBlastHoleDrilling_daily_actual') || {}).placeholder || '';
        const daily_forecast = (document.getElementById('miningBlastHoleDrilling_daily_forecast') || {}).value || (document.getElementById('miningBlastHoleDrilling_daily_forecast') || {}).placeholder || '';
        const var1 = (document.getElementById('miningBlastHoleDrilling_var1') || {}).value || (document.getElementById('miningBlastHoleDrilling_var1') || {}).placeholder || '';
        const mtd_actual = (document.getElementById('miningBlastHoleDrilling_mtd_actual') || {}).value || (document.getElementById('miningBlastHoleDrilling_mtd_actual') || {}).placeholder || '';
        const mtd_forecast = (document.getElementById('miningBlastHoleDrilling_mtd_forecast') || {}).value || (document.getElementById('miningBlastHoleDrilling_mtd_forecast') || {}).placeholder || '';
        const var2 = (document.getElementById('miningBlastHoleDrilling_var2') || {}).value || (document.getElementById('miningBlastHoleDrilling_var2') || {}).placeholder || '';
        const outlook = (document.getElementById('miningBlastHoleDrilling_outlook') || {}).value || (document.getElementById('miningBlastHoleDrilling_outlook') || {}).placeholder || '';
        const fullForecast = (document.getElementById('miningBlastHoleDrilling_fullForecast') || {}).value || (document.getElementById('miningBlastHoleDrilling_fullForecast') || {}).placeholder || '';
        const fullBudget = (document.getElementById('miningBlastHoleDrilling_fullBudget') || {}).value || (document.getElementById('miningBlastHoleDrilling_fullBudget') || {}).placeholder || '';
        const var3 = (document.getElementById('miningBlastHoleDrilling_var3') || {}).value || (document.getElementById('miningBlastHoleDrilling_var3') || {}).placeholder || '';
        const month = (document.getElementById('miningBlastHoleDrilling_month') || {}).value || (document.getElementById('miningBlastHoleDrilling_month') || {}).placeholder || '';
        if (!kpi) { alert('Enter KPI'); return; }
        const rec = { subtype: 'blast-hole-drilling', kpi, date, daily_actual, daily_forecast, var1, mtd_actual, mtd_forecast, var2, outlook, fullForecast, fullBudget, var3, month };
        if (editingKPIId) {
          const existing = (state.kpi_records || []).find(r => r.id === editingKPIId);
          if (existing && existing.subtype === 'blast-hole-drilling') rec.id = editingKPIId;
        }
        addKPIRecord('Mining', rec);
        ['miningBlastHoleDrilling_kpi', 'miningBlastHoleDrilling_date', 'miningBlastHoleDrilling_daily_actual', 'miningBlastHoleDrilling_daily_forecast', 'miningBlastHoleDrilling_var1', 'miningBlastHoleDrilling_mtd_actual', 'miningBlastHoleDrilling_mtd_forecast', 'miningBlastHoleDrilling_var2', 'miningBlastHoleDrilling_outlook', 'miningBlastHoleDrilling_fullForecast', 'miningBlastHoleDrilling_fullBudget', 'miningBlastHoleDrilling_var3', 'miningBlastHoleDrilling_month'].forEach(id => { const el = document.getElementById(id); if (el) el.value = ''; });
        editingKPIId = null;
        alert('Blast Hole Drilling record saved');
      });

      // Milling_CIL fixed form save/clear
      const btnMilling_CILSave = document.getElementById('btnMilling_CILSave');
      if (btnMilling_CILSave) btnMilling_CILSave.addEventListener('click', () => {
        const kpi = (document.getElementById('millingCILKPI') || {}).value || '';
        const month = (document.getElementById('millingCILTargetMonth') || {}).value || '';
        const numDays = (document.getElementById('millingCILNumDays') || {}).value || '';
        const fullForecast = (document.getElementById('millingCILFullForecast') || {}).value || '';
        const fullBudget = (document.getElementById('millingCILFullBudget') || {}).value || '';
        if (!kpi || !month) { alert('Enter KPI and Target Month'); return; }
        const rec = { kpi, month, numDays, fullForecast, fullBudget };
        if (editingKPIId) {
          const existing = (state.kpi_records || []).find(r => r.id === editingKPIId);
          if (existing && !existing.subtype) rec.id = editingKPIId; // only for fixed records
        }
        addKPIRecord('Milling_CIL', rec);
        ['millingCILKPI', 'millingCILTargetMonth', 'millingCILNumDays', 'millingCILFullForecast', 'millingCILFullBudget'].forEach(id => { const el = document.getElementById(id); if (el) el.value = ''; });
        editingKPIId = null;
        alert('Milling_CIL fixed record saved');
      });
      const btnMilling_CILClear = document.getElementById('btnMilling_CILClear');
      if (btnMilling_CILClear) btnMilling_CILClear.addEventListener('click', () => {
        ['millingCILKPI', 'millingCILTargetMonth', 'millingCILNumDays', 'millingCILFullForecast', 'millingCILFullBudget'].forEach(id => { const el = document.getElementById(id); if (el) el.value = ''; });
        const k = document.getElementById('millingCILKPI'); if (k) k.value = 'Gold Contained';
      });

      // Milling_CIL gold-contained form save/clear
      const btnMilling_CILGoldContainedSave = document.getElementById('btnMilling_CILGoldContainedSave');
      if (btnMilling_CILGoldContainedSave) btnMilling_CILGoldContainedSave.addEventListener('click', () => {
        const kpi = (document.getElementById('millingCILGoldContained_kpi') || {}).value || '';
        const date = (document.getElementById('millingCILGoldContained_date') || {}).value || '';
        const daily_actual = (document.getElementById('millingCILGoldContained_daily_actual') || {}).value || (document.getElementById('millingCILGoldContained_daily_actual') || {}).placeholder || '';
        const daily_forecast = (document.getElementById('millingCILGoldContained_daily_forecast') || {}).value || (document.getElementById('millingCILGoldContained_daily_forecast') || {}).placeholder || '';
        const var1 = (document.getElementById('millingCILGoldContained_var1') || {}).value || (document.getElementById('millingCILGoldContained_var1') || {}).placeholder || '';
        const mtd_actual = (document.getElementById('millingCILGoldContained_mtd_actual') || {}).value || (document.getElementById('millingCILGoldContained_mtd_actual') || {}).placeholder || '';
        const mtd_forecast = (document.getElementById('millingCILGoldContained_mtd_forecast') || {}).value || (document.getElementById('millingCILGoldContained_mtd_forecast') || {}).placeholder || '';
        const var2 = (document.getElementById('millingCILGoldContained_var2') || {}).value || (document.getElementById('millingCILGoldContained_var2') || {}).placeholder || '';
        const outlook = (document.getElementById('millingCILGoldContained_outlook') || {}).value || (document.getElementById('millingCILGoldContained_outlook') || {}).placeholder || '';
        const fullForecast = (document.getElementById('millingCILGoldContained_fullForecast') || {}).value || (document.getElementById('millingCILGoldContained_fullForecast') || {}).placeholder || '';
        const fullBudget = (document.getElementById('millingCILGoldContained_fullBudget') || {}).value || (document.getElementById('millingCILGoldContained_fullBudget') || {}).placeholder || '';
        const var3 = (document.getElementById('millingCILGoldContained_var3') || {}).value || (document.getElementById('millingCILGoldContained_var3') || {}).placeholder || '';
        const month = (document.getElementById('millingCILGoldContained_month') || {}).value || (document.getElementById('millingCILGoldContained_month') || {}).placeholder || '';
        if (!kpi) { alert('Enter KPI'); return; }
        const rec = { subtype: 'gold-contained', kpi, date, daily_actual, daily_forecast, var1, mtd_actual, mtd_forecast, var2, outlook, fullForecast, fullBudget, var3, month };
        if (editingKPIId) {
          const existing = (state.kpi_records || []).find(r => r.id === editingKPIId);
          if (existing && existing.subtype === 'gold-contained') rec.id = editingKPIId;
        }
        addKPIRecord('Milling_CIL', rec);
        ['millingCILGoldContained_kpi', 'millingCILGoldContained_date', 'millingCILGoldContained_daily_actual', 'millingCILGoldContained_daily_forecast', 'millingCILGoldContained_var1', 'millingCILGoldContained_mtd_actual', 'millingCILGoldContained_mtd_forecast', 'millingCILGoldContained_var2', 'millingCILGoldContained_outlook', 'millingCILGoldContained_fullForecast', 'millingCILGoldContained_fullBudget', 'millingCILGoldContained_var3', 'millingCILGoldContained_month'].forEach(id => { const el = document.getElementById(id); if (el) el.value = ''; });
        editingKPIId = null;
        alert('Gold Contained record saved');
      });
      const btnMilling_CILGoldContainedClear = document.getElementById('btnMilling_CILGoldContainedClear');
      if (btnMilling_CILGoldContainedClear) btnMilling_CILGoldContainedClear.addEventListener('click', () => {
        ['millingCILGoldContained_kpi', 'millingCILGoldContained_date', 'millingCILGoldContained_daily_actual', 'millingCILGoldContained_daily_forecast', 'millingCILGoldContained_var1', 'millingCILGoldContained_mtd_actual', 'millingCILGoldContained_mtd_forecast', 'millingCILGoldContained_var2', 'millingCILGoldContained_outlook', 'millingCILGoldContained_fullForecast', 'millingCILGoldContained_fullBudget', 'millingCILGoldContained_var3', 'millingCILGoldContained_month'].forEach(id => { const el = document.getElementById(id); if (el) el.value = ''; });
        const k = document.getElementById('millingCILGoldContained_kpi'); if (k) k.value = 'Gold Contained';
      });

      // Milling_CIL gold-recovery form save/clear
      const btnMilling_CILGoldRecoverySave = document.getElementById('btnMilling_CILGoldRecoverySave');
      if (btnMilling_CILGoldRecoverySave) btnMilling_CILGoldRecoverySave.addEventListener('click', () => {
        const kpi = (document.getElementById('millingCILGoldRecovery_kpi') || {}).value || '';
        const date = (document.getElementById('millingCILGoldRecovery_date') || {}).value || '';
        const daily_actual = (document.getElementById('millingCILGoldRecovery_daily_actual') || {}).value || (document.getElementById('millingCILGoldRecovery_daily_actual') || {}).placeholder || '';
        const daily_forecast = (document.getElementById('millingCILGoldRecovery_daily_forecast') || {}).value || (document.getElementById('millingCILGoldRecovery_daily_forecast') || {}).placeholder || '';
        const var1 = (document.getElementById('millingCILGoldRecovery_var1') || {}).value || (document.getElementById('millingCILGoldRecovery_var1') || {}).placeholder || '';
        const mtd_actual = (document.getElementById('millingCILGoldRecovery_mtd_actual') || {}).value || (document.getElementById('millingCILGoldRecovery_mtd_actual') || {}).placeholder || '';
        const mtd_forecast = (document.getElementById('millingCILGoldRecovery_mtd_forecast') || {}).value || (document.getElementById('millingCILGoldRecovery_mtd_forecast') || {}).placeholder || '';
        const var2 = (document.getElementById('millingCILGoldRecovery_var2') || {}).value || (document.getElementById('millingCILGoldRecovery_var2') || {}).placeholder || '';
        const outlook = (document.getElementById('millingCILGoldRecovery_outlook') || {}).value || (document.getElementById('millingCILGoldRecovery_outlook') || {}).placeholder || '';
        const fullForecast = (document.getElementById('millingCILGoldRecovery_fullForecast') || {}).value || (document.getElementById('millingCILGoldRecovery_fullForecast') || {}).placeholder || '';
        const fullBudget = (document.getElementById('millingCILGoldRecovery_fullBudget') || {}).value || (document.getElementById('millingCILGoldRecovery_fullBudget') || {}).placeholder || '';
        const var3 = (document.getElementById('millingCILGoldRecovery_var3') || {}).value || (document.getElementById('millingCILGoldRecovery_var3') || {}).placeholder || '';
        const month = (document.getElementById('millingCILGoldRecovery_month') || {}).value || (document.getElementById('millingCILGoldRecovery_month') || {}).placeholder || '';
        if (!kpi) { alert('Enter KPI'); return; }
        const rec = { subtype: 'gold-recovery', kpi, date, daily_actual, daily_forecast, var1, mtd_actual, mtd_forecast, var2, outlook, fullForecast, fullBudget, var3, month };
        if (editingKPIId) {
          const existing = (state.kpi_records || []).find(r => r.id === editingKPIId);
          if (existing && existing.subtype === 'gold-recovery') rec.id = editingKPIId;
        }
        addKPIRecord('Milling_CIL', rec);
        ['millingCILGoldRecovery_kpi', 'millingCILGoldRecovery_date', 'millingCILGoldRecovery_daily_actual', 'millingCILGoldRecovery_daily_forecast', 'millingCILGoldRecovery_var1', 'millingCILGoldRecovery_mtd_actual', 'millingCILGoldRecovery_mtd_forecast', 'millingCILGoldRecovery_var2', 'millingCILGoldRecovery_outlook', 'millingCILGoldRecovery_fullForecast', 'millingCILGoldRecovery_fullBudget', 'millingCILGoldRecovery_var3', 'millingCILGoldRecovery_month'].forEach(id => { const el = document.getElementById(id); if (el) el.value = ''; });
        editingKPIId = null;
        alert('Gold Recovery record saved');
      });
      const btnMilling_CILGoldRecoveryClear = document.getElementById('btnMilling_CILGoldRecoveryClear');
      if (btnMilling_CILGoldRecoveryClear) btnMilling_CILGoldRecoveryClear.addEventListener('click', () => {
        ['millingCILGoldRecovery_kpi', 'millingCILGoldRecovery_date', 'millingCILGoldRecovery_daily_actual', 'millingCILGoldRecovery_daily_forecast', 'millingCILGoldRecovery_var1', 'millingCILGoldRecovery_mtd_actual', 'millingCILGoldRecovery_mtd_forecast', 'millingCILGoldRecovery_var2', 'millingCILGoldRecovery_outlook', 'millingCILGoldRecovery_fullForecast', 'millingCILGoldRecovery_fullBudget', 'millingCILGoldRecovery_var3', 'millingCILGoldRecovery_month'].forEach(id => { const el = document.getElementById(id); if (el) el.value = ''; });
        const k = document.getElementById('millingCILGoldRecovery_kpi'); if (k) k.value = 'Gold Recovery';
      });

      // Milling_CIL plant-feed-grade form save/clear
      const btnMilling_CILPlantFeedGradeSave = document.getElementById('btnMilling_CILPlantFeedGradeSave');
      if (btnMilling_CILPlantFeedGradeSave) btnMilling_CILPlantFeedGradeSave.addEventListener('click', () => {
        const kpi = (document.getElementById('millingCILPlantFeedGrade_kpi') || {}).value || '';
        const date = (document.getElementById('millingCILPlantFeedGrade_date') || {}).value || '';
        const daily_actual = (document.getElementById('millingCILPlantFeedGrade_daily_actual') || {}).value || (document.getElementById('millingCILPlantFeedGrade_daily_actual') || {}).placeholder || '';
        const daily_forecast = (document.getElementById('millingCILPlantFeedGrade_daily_forecast') || {}).value || (document.getElementById('millingCILPlantFeedGrade_daily_forecast') || {}).placeholder || '';
        const var1 = (document.getElementById('millingCILPlantFeedGrade_var1') || {}).value || (document.getElementById('millingCILPlantFeedGrade_var1') || {}).placeholder || '';
        const mtd_actual = (document.getElementById('millingCILPlantFeedGrade_mtd_actual') || {}).value || (document.getElementById('millingCILPlantFeedGrade_mtd_actual') || {}).placeholder || '';
        const mtd_forecast = (document.getElementById('millingCILPlantFeedGrade_mtd_forecast') || {}).value || (document.getElementById('millingCILPlantFeedGrade_mtd_forecast') || {}).placeholder || '';
        const var2 = (document.getElementById('millingCILPlantFeedGrade_var2') || {}).value || (document.getElementById('millingCILPlantFeedGrade_var2') || {}).placeholder || '';
        const outlook = (document.getElementById('millingCILPlantFeedGrade_outlook') || {}).value || (document.getElementById('millingCILPlantFeedGrade_outlook') || {}).placeholder || '';
        const fullForecast = (document.getElementById('millingCILPlantFeedGrade_fullForecast') || {}).value || (document.getElementById('millingCILPlantFeedGrade_fullForecast') || {}).placeholder || '';
        const fullBudget = (document.getElementById('millingCILPlantFeedGrade_fullBudget') || {}).value || (document.getElementById('millingCILPlantFeedGrade_fullBudget') || {}).placeholder || '';
        const var3 = (document.getElementById('millingCILPlantFeedGrade_var3') || {}).value || (document.getElementById('millingCILPlantFeedGrade_var3') || {}).placeholder || '';
        const month = (document.getElementById('millingCILPlantFeedGrade_month') || {}).value || (document.getElementById('millingCILPlantFeedGrade_month') || {}).placeholder || '';
        if (!kpi) { alert('Enter KPI'); return; }
        const rec = { subtype: 'plant-feed-grade', kpi, date, daily_actual, daily_forecast, var1, mtd_actual, mtd_forecast, var2, outlook, fullForecast, fullBudget, var3, month };
        if (editingKPIId) {
          const existing = (state.kpi_records || []).find(r => r.id === editingKPIId);
          if (existing && existing.subtype === 'plant-feed-grade') rec.id = editingKPIId;
        }
        addKPIRecord('Milling_CIL', rec);
        ['millingCILPlantFeedGrade_kpi', 'millingCILPlantFeedGrade_date', 'millingCILPlantFeedGrade_daily_actual', 'millingCILPlantFeedGrade_daily_forecast', 'millingCILPlantFeedGrade_var1', 'millingCILPlantFeedGrade_mtd_actual', 'millingCILPlantFeedGrade_mtd_forecast', 'millingCILPlantFeedGrade_var2', 'millingCILPlantFeedGrade_outlook', 'millingCILPlantFeedGrade_fullForecast', 'millingCILPlantFeedGrade_fullBudget', 'millingCILPlantFeedGrade_var3', 'millingCILPlantFeedGrade_month'].forEach(id => { const el = document.getElementById(id); if (el) el.value = ''; });
        editingKPIId = null;
        alert('Plant Feed Grade record saved');
      });
      const btnMilling_CILPlantFeedGradeClear = document.getElementById('btnMilling_CILPlantFeedGradeClear');
      if (btnMilling_CILPlantFeedGradeClear) btnMilling_CILPlantFeedGradeClear.addEventListener('click', () => {
        ['millingCILPlantFeedGrade_kpi', 'millingCILPlantFeedGrade_date', 'millingCILPlantFeedGrade_daily_actual', 'millingCILPlantFeedGrade_daily_forecast', 'millingCILPlantFeedGrade_var1', 'millingCILPlantFeedGrade_mtd_actual', 'millingCILPlantFeedGrade_mtd_forecast', 'millingCILPlantFeedGrade_var2', 'millingCILPlantFeedGrade_outlook', 'millingCILPlantFeedGrade_fullForecast', 'millingCILPlantFeedGrade_fullBudget', 'millingCILPlantFeedGrade_var3', 'millingCILPlantFeedGrade_month'].forEach(id => { const el = document.getElementById(id); if (el) el.value = ''; });
        const k = document.getElementById('millingCILPlantFeedGrade_kpi'); if (k) k.value = 'Plant Feed Grade';
      });

      // Milling_CIL tonnes-treated form save/clear
      const btnMilling_CILTonnesTreatedSave = document.getElementById('btnMilling_CILTonnesTreatedSave');
      if (btnMilling_CILTonnesTreatedSave) btnMilling_CILTonnesTreatedSave.addEventListener('click', () => {
        const kpi = (document.getElementById('millingCILTonnesTreated_kpi') || {}).value || '';
        const date = (document.getElementById('millingCILTonnesTreated_date') || {}).value || '';
        const daily_actual = (document.getElementById('millingCILTonnesTreated_daily_actual') || {}).value || (document.getElementById('millingCILTonnesTreated_daily_actual') || {}).placeholder || '';
        const daily_forecast = (document.getElementById('millingCILTonnesTreated_daily_forecast') || {}).value || (document.getElementById('millingCILTonnesTreated_daily_forecast') || {}).placeholder || '';
        const var1 = (document.getElementById('millingCILTonnesTreated_var1') || {}).value || (document.getElementById('millingCILTonnesTreated_var1') || {}).placeholder || '';
        const mtd_actual = (document.getElementById('millingCILTonnesTreated_mtd_actual') || {}).value || (document.getElementById('millingCILTonnesTreated_mtd_actual') || {}).placeholder || '';
        const mtd_forecast = (document.getElementById('millingCILTonnesTreated_mtd_forecast') || {}).value || (document.getElementById('millingCILTonnesTreated_mtd_forecast') || {}).placeholder || '';
        const var2 = (document.getElementById('millingCILTonnesTreated_var2') || {}).value || (document.getElementById('millingCILTonnesTreated_var2') || {}).placeholder || '';
        const outlook = (document.getElementById('millingCILTonnesTreated_outlook') || {}).value || (document.getElementById('millingCILTonnesTreated_outlook') || {}).placeholder || '';
        const fullForecast = (document.getElementById('millingCILTonnesTreated_fullForecast') || {}).value || (document.getElementById('millingCILTonnesTreated_fullForecast') || {}).placeholder || '';
        const fullBudget = (document.getElementById('millingCILTonnesTreated_fullBudget') || {}).value || (document.getElementById('millingCILTonnesTreated_fullBudget') || {}).placeholder || '';
        const var3 = (document.getElementById('millingCILTonnesTreated_var3') || {}).value || (document.getElementById('millingCILTonnesTreated_var3') || {}).placeholder || '';
        const month = (document.getElementById('millingCILTonnesTreated_month') || {}).value || (document.getElementById('millingCILTonnesTreated_month') || {}).placeholder || '';
        if (!kpi) { alert('Enter KPI'); return; }
        const rec = { subtype: 'tonnes-treated', kpi, date, daily_actual, daily_forecast, var1, mtd_actual, mtd_forecast, var2, outlook, fullForecast, fullBudget, var3, month };
        if (editingKPIId) {
          const existing = (state.kpi_records || []).find(r => r.id === editingKPIId);
          if (existing && existing.subtype === 'tonnes-treated') rec.id = editingKPIId;
        }
        addKPIRecord('Milling_CIL', rec);
        ['millingCILTonnesTreated_kpi', 'millingCILTonnesTreated_date', 'millingCILTonnesTreated_daily_actual', 'millingCILTonnesTreated_daily_forecast', 'millingCILTonnesTreated_var1', 'millingCILTonnesTreated_mtd_actual', 'millingCILTonnesTreated_mtd_forecast', 'millingCILTonnesTreated_var2', 'millingCILTonnesTreated_outlook', 'millingCILTonnesTreated_fullForecast', 'millingCILTonnesTreated_fullBudget', 'millingCILTonnesTreated_var3', 'millingCILTonnesTreated_month'].forEach(id => { const el = document.getElementById(id); if (el) el.value = ''; });
        editingKPIId = null;
        alert('Tonnes Treated record saved');
      });
      const btnMilling_CILTonnesTreatedClear = document.getElementById('btnMilling_CILTonnesTreatedClear');
      if (btnMilling_CILTonnesTreatedClear) btnMilling_CILTonnesTreatedClear.addEventListener('click', () => {
        ['millingCILTonnesTreated_kpi', 'millingCILTonnesTreated_date', 'millingCILTonnesTreated_daily_actual', 'millingCILTonnesTreated_daily_forecast', 'millingCILTonnesTreated_var1', 'millingCILTonnesTreated_mtd_actual', 'millingCILTonnesTreated_mtd_forecast', 'millingCILTonnesTreated_var2', 'millingCILTonnesTreated_outlook', 'millingCILTonnesTreated_fullForecast', 'millingCILTonnesTreated_fullBudget', 'millingCILTonnesTreated_var3', 'millingCILTonnesTreated_month'].forEach(id => { const el = document.getElementById(id); if (el) el.value = ''; });
        const k = document.getElementById('millingCILTonnesTreated_kpi'); if (k) k.value = 'Tonnes Treated';
      });

      // wire the daily forecast computation for Geology Grade form
      (function wireGeoGradeDailyForecast() {
        const kpiEl = document.getElementById('geoGrade_kpi');
        const dateEl = document.getElementById('geoGrade_date');
        const rigEl = document.getElementById('geoGrade_rig');
        if (kpiEl) kpiEl.addEventListener('input', () => { updateGeoGradeDailyForecast(); updateGeoGradeFullForecast(); updateGeoGradeFullBudget(); });
        if (dateEl) dateEl.addEventListener('input', () => { updateGeoGradeDailyForecast(); updateGeoGradeFullForecast(); updateGeoGradeFullBudget(); });
        if (rigEl) rigEl.addEventListener('input', updateGeoGradeDailyForecast);
      })();

      // wire the daily forecast computation for Geology Ore form
      (function wireGeoOreDailyForecast() {
        const kpiEl = document.getElementById('geoOre_kpi');
        const dateEl = document.getElementById('geoOre_date');
        const rigEl = document.getElementById('geoOre_rig');
        if (kpiEl) kpiEl.addEventListener('input', () => { updateGeoOreDailyForecast(); updateGeoOreFullForecast(); updateGeoOreFullBudget(); });
        if (dateEl) dateEl.addEventListener('input', () => { updateGeoOreDailyForecast(); updateGeoOreFullForecast(); updateGeoOreFullBudget(); });
        if (rigEl) rigEl.addEventListener('input', updateGeoOreDailyForecast);
      })();

      // wire the var computation for Geology Ore form
      (function wireGeoOreVar() {
        const dailyActualEl = document.getElementById('geoOre_daily_actual');
        if (dailyActualEl) dailyActualEl.addEventListener('input', computeGeoOreVar);
      })();

      // wire the MTD Actual computation for Geology Ore form
      (function wireGeoOreMTDActual() {
        const kpiEl = document.getElementById('geoOre_kpi');
        const dateEl = document.getElementById('geoOre_date');
        const dailyActualEl = document.getElementById('geoOre_daily_actual');
        if (kpiEl) kpiEl.addEventListener('input', computeGeoOreMTDActual);
        if (dateEl) dateEl.addEventListener('input', computeGeoOreMTDActual);
        if (dailyActualEl) dailyActualEl.addEventListener('input', computeGeoOreMTDActual);
      })();

      // wire the Outlook computation for Geology Ore form
      (function wireGeoOreOutlook() {
        const dateEl = document.getElementById('geoOre_date');
        const actualEl = document.getElementById('geoOre_daily_actual');
        const forecastEl = document.getElementById('geoOre_daily_forecast');
        const fullForecastEl = document.getElementById('geoOre_fullForecast');
        const kpiEl = document.getElementById('geoOre_kpi');
        if (dateEl) dateEl.addEventListener('input', updateGeoOreOutlook);
        if (actualEl) actualEl.addEventListener('input', updateGeoOreOutlook);
        if (forecastEl) forecastEl.addEventListener('input', updateGeoOreOutlook);
        if (fullForecastEl) fullForecastEl.addEventListener('input', updateGeoOreOutlook);
        if (kpiEl) kpiEl.addEventListener('input', updateGeoOreOutlook);
      })();

      // set default month picker values to current month/year
      // compute and auto-fill Daily Forecast for Crushing Grade form
      function updateCrushGradeDailyForecast() {
        try {
          const kpiEl = document.getElementById('crushGrade_kpi');
          const dateEl = document.getElementById('crushGrade_date');
          const outEl = document.getElementById('crushGrade_daily_forecast');
          if (!kpiEl || !dateEl || !outEl) return;
          const kpi = (kpiEl.value || '').trim();
          const normalizeKPI = s => String(s || '').replace(/\s+/g, ' ').trim().toLowerCase();
          const kpiNorm = normalizeKPI(kpi);
          const date = (dateEl.value || '').trim();
          if (!kpi || !date) { outEl.value = ''; return; }
          const d = new Date(date);
          if (isNaN(d)) { outEl.value = ''; return; }
          const month = d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0');
          const fixed = (state.kpi_records || []).find(r => {
            if (r.dept !== 'Crushing') return false;
            if (r.subtype) return false;
            if (normalizeKPI(r.kpi) !== kpiNorm) return false;
            const rMonth = (r.month && String(r.month).trim()) || '';
            return rMonth === month;
          });
          if (fixed && (fixed.fullForecast !== undefined && fixed.fullForecast !== null)) {
            outEl.value = fixed.fullForecast;
          } else {
            outEl.value = '';
          }
        } catch (e) { console.warn('updateCrushGradeDailyForecast error', e); }
      }

      // compute Daily Actual placeholder for Geology Toll form: 85% of Wet Tonnes
      function updateGeoTollDailyActual() {
        try {
          const wetEl = document.getElementById('geoToll_wetTonnes');
          const dailyEl = document.getElementById('geoToll_daily_actual');
          if (!wetEl || !dailyEl) return;
          const raw = String(wetEl.value || '').replace(/,/g, '').trim();
          const wt = parseFloat(raw);
          if (Number.isFinite(wt)) {
            const val = wt * 0.85;
            // format with up to 2 decimal places when needed
            const formatted = (Math.round(val) === val) ? val.toLocaleString() : val.toLocaleString(undefined, { maximumFractionDigits: 2 });
            dailyEl.placeholder = formatted;
          } else {
            dailyEl.placeholder = '';
          }
        } catch (e) { console.warn('updateGeoTollDailyActual error', e); }
      }

      // helper: get number of days in a month
      function daysInMonth(year, month) {
        return new Date(year, month + 1, 0).getDate();
      }

      // compute Daily Forecast placeholder for Geology Toll form
      function updateGeoTollDailyForecast() {
        console.log('updateGeoTollDailyForecast called');
        try {
          const dateEl = document.getElementById('geoToll_date');
          const forecastEl = document.getElementById('geoToll_daily_forecast');
          if (!dateEl || !forecastEl) { console.log('elements not found'); return; }
          const dateVal = dateEl.value;
          console.log('dateVal:', dateVal);
          if (!dateVal) { forecastEl.placeholder = ''; console.log('no dateVal'); return; }
          const d = new Date(dateVal);
          if (isNaN(d)) { forecastEl.placeholder = ''; console.log('invalid date'); return; }
          const year = d.getFullYear();
          const month = d.getMonth(); // 0-based
          const monthStr = year + '-' + String(month + 1).padStart(2, '0');
          console.log('monthStr:', monthStr);
          // find matching Fixed Inputs record: dept=Geology, no subtype, kpi=Toll, month matches
          const fixed = (state.kpi_records || []).find(r =>
            r.dept === 'Geology' && !r.subtype && r.kpi === 'Toll' && r.month === monthStr
          );
          console.log('fixed record:', fixed);
          if (fixed && fixed.fullForecast) {
            const ffRaw = String(fixed.fullForecast).replace(/,/g, '').trim();
            const ff = parseFloat(ffRaw);
            console.log('ff:', ff);
            if (Number.isFinite(ff)) {
              const days = daysInMonth(year, month);
              console.log('days:', days);
              const daily = ff / days;
              const rounded = Math.round(daily);
              console.log('rounded:', rounded);
              forecastEl.placeholder = rounded.toLocaleString();
              console.log('set placeholder to:', forecastEl.placeholder);
            } else {
              forecastEl.placeholder = '';
              console.log('ff not finite');
            }
          } else {
            forecastEl.placeholder = '';
            console.log('no fixed record or fullForecast');
          }
        } catch (e) { console.warn('updateGeoTollDailyForecast error', e); }
      }

      // compute Var for Geology Toll form: ((Daily Actual - Daily Forecast) / Daily Forecast) * 100
      function updateGeoTollVar() {
        try {
          const actualEl = document.getElementById('geoToll_daily_actual');
          const forecastEl = document.getElementById('geoToll_daily_forecast');
          const varEl = document.getElementById('geoToll_var1');
          if (!actualEl || !forecastEl || !varEl) return;
          const aRaw = (actualEl.placeholder || '').replace(/,/g, '').trim();
          const fRaw = (forecastEl.placeholder || '').replace(/,/g, '').trim();
          const a = parseFloat(aRaw);
          const f = parseFloat(fRaw);
          if (Number.isFinite(f) && f !== 0 && Number.isFinite(a)) {
            const v = (a - f) / f;
            varEl.placeholder = Math.round(v * 100) + '%';
          } else {
            varEl.placeholder = '';
          }
        } catch (e) { console.warn('updateGeoTollVar error', e); }
      }

      // compute Var placeholder for Geology Toll form: ((MTD Actual - MTD Forecast) / MTD Forecast) * 100
      function computeGeoTollVarPlaceholder() {
        console.log('computeGeoTollVarPlaceholder called');
        try {
          const mtdActualEl = document.getElementById('geoToll_mtd_actual');
          const mtdForecastEl = document.getElementById('geoToll_mtd_forecast');
          const varEl = document.getElementById('geoToll_var2');
          if (!mtdActualEl || !mtdForecastEl || !varEl) { console.log('elements not found'); return; }
          const aRaw = (mtdActualEl.placeholder || '').replace(/,/g, '').trim();
          const fRaw = (mtdForecastEl.placeholder || '').replace(/,/g, '').trim();
          console.log('aRaw:', aRaw, 'fRaw:', fRaw);
          const a = parseFloat(aRaw);
          const f = parseFloat(fRaw);
          console.log('a:', a, 'f:', f);
          if (Number.isFinite(f) && f !== 0 && Number.isFinite(a)) {
            const v = ((a - f) / f) * 100;
            varEl.placeholder = Math.round(v) + '%';
            console.log('set var placeholder to:', varEl.placeholder);
          } else {
            varEl.placeholder = '';
            console.log('cleared var placeholder');
          }
        } catch (e) { console.warn('computeGeoTollVarPlaceholder error', e); }
      }

      // compute MTD Actual placeholder for Geology Toll form
      function updateGeoTollMTDActual() {
        try {
          const dateEl = document.getElementById('geoToll_date');
          const dailyActualEl = document.getElementById('geoToll_daily_actual');
          const mtdEl = document.getElementById('geoToll_mtd_actual');
          if (!dateEl || !dailyActualEl || !mtdEl) return;
          const dateVal = dateEl.value;
          if (!dateVal) { mtdEl.placeholder = ''; return; }
          const d = new Date(dateVal);
          if (isNaN(d)) { mtdEl.placeholder = ''; return; }
          const year = d.getFullYear();
          const month = d.getMonth(); // 0-based
          // find the last Toll record for this month (by date descending)
          const tollRecords = (state.kpi_records || []).filter(r =>
            r.dept === 'Geology' && r.subtype === 'toll' && r.date
          ).map(r => ({ ...r, parsedDate: new Date(r.date) }))
            .filter(r => !isNaN(r.parsedDate) && r.parsedDate.getFullYear() === year && r.parsedDate.getMonth() === month)
            .sort((a, b) => b.parsedDate - a.parsedDate); // most recent first
          const lastRecord = tollRecords[0];
          let lastMTD = 0;
          if (lastRecord && lastRecord.mtd_actual) {
            const mtdRaw = String(lastRecord.mtd_actual).replace(/,/g, '').trim();
            lastMTD = parseFloat(mtdRaw) || 0;
          }
          // add current daily actual
          const dailyRaw = (dailyActualEl.placeholder || '').replace(/,/g, '').trim();
          const daily = parseFloat(dailyRaw) || 0;
          const total = lastMTD + daily;
          mtdEl.placeholder = total.toLocaleString();
        } catch (e) { console.warn('updateGeoTollMTDActual error', e); }
      }

      // compute MTD Forecast placeholder for Geology Toll form
      function updateGeoTollMTDForecast() {
        try {
          const dateEl = document.getElementById('geoToll_date');
          const dailyForecastEl = document.getElementById('geoToll_daily_forecast');
          const mtdForecastEl = document.getElementById('geoToll_mtd_forecast');
          if (!dateEl || !dailyForecastEl || !mtdForecastEl) return;
          const dateVal = dateEl.value;
          if (!dateVal) { mtdForecastEl.placeholder = ''; return; }
          const d = new Date(dateVal);
          if (isNaN(d)) { mtdForecastEl.placeholder = ''; return; }
          const year = d.getFullYear();
          const month = d.getMonth(); // 0-based
          // find the last Toll record for this month (by date descending)
          const tollRecords = (state.kpi_records || []).filter(r =>
            r.dept === 'Geology' && r.subtype === 'toll' && r.date
          ).map(r => ({ ...r, parsedDate: new Date(r.date) }))
            .filter(r => !isNaN(r.parsedDate) && r.parsedDate.getFullYear() === year && r.parsedDate.getMonth() === month)
            .sort((a, b) => b.parsedDate - a.parsedDate); // most recent first
          const lastRecord = tollRecords[0];
          let lastMTD = 0;
          if (lastRecord && lastRecord.mtd_forecast) {
            const mtdRaw = String(lastRecord.mtd_forecast).replace(/,/g, '').trim();
            lastMTD = parseFloat(mtdRaw) || 0;
          }
          // add current daily forecast
          const dailyRaw = (dailyForecastEl.placeholder || '').replace(/,/g, '').trim();
          const daily = parseFloat(dailyRaw) || 0;
          const total = lastMTD + daily;
          mtdForecastEl.placeholder = total.toLocaleString();
        } catch (e) { console.warn('updateGeoTollMTDForecast error', e); }
      }

      // update Full Forecast (b) placeholder for Geology Toll form
      function updateGeoTollFullForecast() {
        try {
          const dateEl = document.getElementById('geoToll_date');
          const fullForecastEl = document.getElementById('geoToll_fullForecast');
          if (!dateEl || !fullForecastEl) return;
          const dateVal = dateEl.value;
          if (!dateVal) { fullForecastEl.placeholder = ''; return; }
          const d = new Date(dateVal);
          if (isNaN(d)) { fullForecastEl.placeholder = ''; return; }
          const year = d.getFullYear();
          const month = d.getMonth(); // 0-based
          const monthStr = year + '-' + String(month + 1).padStart(2, '0');
          // find matching Fixed Inputs record: dept=Geology, no subtype, kpi=Toll, month matches
          const fixed = (state.kpi_records || []).find(r =>
            r.dept === 'Geology' && !r.subtype && r.kpi === 'Toll' && r.month === monthStr
          );
          if (fixed && fixed.fullForecast !== undefined && fixed.fullForecast !== null) {
            const ffRaw = String(fixed.fullForecast).replace(/,/g, '').trim();
            const ff = parseFloat(ffRaw);
            if (Number.isFinite(ff)) {
              fullForecastEl.placeholder = ff.toLocaleString();
            } else {
              fullForecastEl.placeholder = '';
            }
          } else {
            fullForecastEl.placeholder = '';
          }
        } catch (e) { console.warn('updateGeoTollFullForecast error', e); }
      }

      // update Full Budget (c) placeholder for Geology Toll form
      function updateGeoTollFullBudget() {
        try {
          const dateEl = document.getElementById('geoToll_date');
          const fullBudgetEl = document.getElementById('geoToll_fullBudget');
          if (!dateEl || !fullBudgetEl) return;
          const dateVal = dateEl.value;
          if (!dateVal) { fullBudgetEl.placeholder = ''; return; }
          const d = new Date(dateVal);
          if (isNaN(d)) { fullBudgetEl.placeholder = ''; return; }
          const year = d.getFullYear();
          const month = d.getMonth(); // 0-based
          const monthStr = year + '-' + String(month + 1).padStart(2, '0');
          // find matching Fixed Inputs record: dept=Geology, no subtype, kpi=Toll, month matches
          const fixed = (state.kpi_records || []).find(r =>
            r.dept === 'Geology' && !r.subtype && r.kpi === 'Toll' && r.month === monthStr
          );
          if (fixed && fixed.fullBudget !== undefined && fixed.fullBudget !== null) {
            const fbRaw = String(fixed.fullBudget).replace(/,/g, '').trim();
            const fb = parseFloat(fbRaw);
            if (Number.isFinite(fb)) {
              fullBudgetEl.placeholder = fb.toLocaleString();
            } else {
              fullBudgetEl.placeholder = '';
            }
          } else {
            fullBudgetEl.placeholder = '';
          }
        } catch (e) { console.warn('updateGeoTollFullBudget error', e); }
      }

      // update Outlook (a) placeholder for Geology Toll form
      function updateGeoTollOutlook() {
        try {
          const dateEl = document.getElementById('geoToll_date');
          const dailyActualEl = document.getElementById('geoToll_daily_actual');
          const dailyForecastEl = document.getElementById('geoToll_daily_forecast');
          const fullForecastEl = document.getElementById('geoToll_fullForecast');
          const outlookEl = document.getElementById('geoToll_outlook');
          if (!dateEl || !dailyActualEl || !dailyForecastEl || !fullForecastEl || !outlookEl) return;
          const dateVal = dateEl.value;
          if (!dateVal) { outlookEl.placeholder = ''; return; }
          const d = new Date(dateVal);
          if (isNaN(d)) { outlookEl.placeholder = ''; return; }
          const year = d.getFullYear();
          const month = d.getMonth(); // 0-based
          const day = d.getDate();
          // calculate difference
          const actualRaw = (dailyActualEl.placeholder || '').replace(/,/g, '').trim();
          const forecastRaw = (dailyForecastEl.placeholder || '').replace(/,/g, '').trim();
          const actual = parseFloat(actualRaw) || 0;
          const forecast = parseFloat(forecastRaw) || 0;
          const difference = actual - forecast;
          let outlookValue = 0;
          if (day === 1) {
            // first day of month: Full Forecast + difference
            const fullRaw = (fullForecastEl.placeholder || '').replace(/,/g, '').trim();
            const full = parseFloat(fullRaw) || 0;
            outlookValue = full + difference;
          } else {
            // subsequent days: last record's Outlook + difference
            const tollRecords = (state.kpi_records || []).filter(r =>
              r.dept === 'Geology' && r.subtype === 'toll' && r.date
            ).map(r => ({ ...r, parsedDate: new Date(r.date) }))
              .filter(r => !isNaN(r.parsedDate) && r.parsedDate.getFullYear() === year && r.parsedDate.getMonth() === month)
              .sort((a, b) => b.parsedDate - a.parsedDate); // most recent first
            const lastRecord = tollRecords[0];
            let lastOutlook = 0;
            if (lastRecord && lastRecord.outlook) {
              const outlookRaw = String(lastRecord.outlook).replace(/,/g, '').trim();
              lastOutlook = parseFloat(outlookRaw) || 0;
            }
            outlookValue = lastOutlook + difference;
          }
          outlookEl.placeholder = outlookValue.toLocaleString();
        } catch (e) { console.warn('updateGeoTollOutlook error', e); }
      }

      // compute Full Var placeholder for Geology Toll form: ((Outlook (a) - Full Forecast (b)) / Full Forecast (b)) * 100
      function computeGeoTollFullVar() {
        try {
          const outlookEl = document.getElementById('geoToll_outlook');
          const fullForecastEl = document.getElementById('geoToll_fullForecast');
          const varEl = document.getElementById('geoToll_var3');
          if (!outlookEl || !fullForecastEl || !varEl) return;
          const oRaw = (outlookEl.placeholder || '').replace(/,/g, '').trim();
          const fRaw = (fullForecastEl.placeholder || '').replace(/,/g, '').trim();
          const o = parseFloat(oRaw);
          const f = parseFloat(fRaw);
          if (Number.isFinite(f) && f !== 0 && Number.isFinite(o)) {
            const v = ((o - f) / f) * 100;
            varEl.placeholder = Math.round(v) + '%';
          } else {
            varEl.placeholder = '';
          }
        } catch (e) { console.warn('computeGeoTollFullVar error', e); }
      }

      // update Grade(Day-7) placeholder for Geology Toll form
      function updateGeoTollGradeDay7() {
        try {
          const dateEl = document.getElementById('geoToll_date');
          const gradeDay7El = document.getElementById('geoToll_gradeDay7');
          if (!dateEl || !gradeDay7El) return;
          const dateVal = dateEl.value;
          if (!dateVal) { gradeDay7El.placeholder = ''; return; }
          const d = new Date(dateVal);
          if (isNaN(d)) { gradeDay7El.placeholder = ''; return; }
          // subtract 6 days
          const d7 = new Date(d);
          d7.setDate(d7.getDate() - 6);
          const d7Str = d7.toISOString().slice(0, 10);
          // find record with that date
          const record = (state.kpi_records || []).find(r =>
            r.dept === 'Geology' && r.subtype === 'toll' && r.date === d7Str
          );
          if (record && record.grade !== undefined && record.grade !== null) {
            gradeDay7El.placeholder = String(record.grade);
          } else {
            gradeDay7El.placeholder = '';
          }
        } catch (e) { console.warn('updateGeoTollGradeDay7 error', e); }
      }

      // wire the Geo Toll placeholder computation to Wet Tonnes and Date inputs
      (function wireGeoTollDailyActual() {
        const wetEl = document.getElementById('geoToll_wetTonnes');
        const dateEl = document.getElementById('geoToll_date');
        const actualEl = document.getElementById('geoToll_daily_actual');
        const forecastEl = document.getElementById('geoToll_daily_forecast');
        if (wetEl) wetEl.addEventListener('input', () => {
          updateGeoTollDailyActual();
          updateGeoTollDailyForecast();
          updateGeoTollVar();
          updateGeoTollOutlook();
          computeGeoTollFullVar();
          setTimeout(() => {
            updateGeoTollMTDActual();
            updateGeoTollMTDForecast();
            setTimeout(computeGeoTollVarPlaceholder, 0);
          }, 0);
        });
        if (dateEl) dateEl.addEventListener('input', () => {
          updateGeoTollDailyForecast();
          updateGeoTollVar();
          updateGeoTollFullForecast();
          updateGeoTollFullBudget();
          updateGeoTollOutlook();
          updateGeoTollGradeDay7();
          computeGeoTollFullVar();
          setTimeout(() => {
            updateGeoTollMTDForecast();
            setTimeout(computeGeoTollVarPlaceholder, 0);
          }, 0);
        });
      })();

      // wire events for the Grade - Ore Crushed form
      // compute the Var: (DailyActual - DailyForecast) / DailyForecast
      function computeCrushGradeVar() {
        try {
          const actualEl = document.getElementById('crushGrade_daily_actual');
          const forecastEl = document.getElementById('crushGrade_daily_forecast');
          const varEl = document.getElementById('crushGrade_var1');
          if (!actualEl || !forecastEl || !varEl) return;
          const aRaw = (actualEl.value || '').replace(/,/g, '').trim();
          const fRaw = (forecastEl.value || '').replace(/,/g, '').trim();
          const a = parseFloat(aRaw);
          const f = parseFloat(fRaw);
          if (Number.isFinite(f) && f !== 0 && Number.isFinite(a)) {
            const v = (a - f) / f;
            // show as whole percentage without decimal places (e.g. 12%)
            varEl.value = Math.round(v * 100) + '%';
          } else {
            varEl.value = '';
          }
        } catch (e) { console.warn('computeCrushGradeVar error', e); }
      }

      // copy Daily Forecast into MTD Forecast placeholder
      function updateCrushGradeMTDForecast() {
        try {
          const forecastEl = document.getElementById('crushGrade_daily_forecast');
          const mtdForecastEl = document.getElementById('crushGrade_mtd_forecast');
          if (!forecastEl || !mtdForecastEl) return;
          mtdForecastEl.value = (forecastEl.value || '').trim();
          try { if (typeof updateCrushGradeMTDVarAndMirrors === 'function') updateCrushGradeMTDVarAndMirrors(); } catch (e) { }
        } catch (e) { console.warn('updateCrushGradeMTDForecast error', e); }
      }

      // compute MTD variance and mirror MTD Actual->Outlook and MTD Forecast->FullForecast
      function updateCrushGradeMTDVarAndMirrors() {
        try {
          const mtdActualEl = document.getElementById('crushGrade_mtd_actual');
          const mtdForecastEl = document.getElementById('crushGrade_mtd_forecast');
          const varEl = document.getElementById('crushGrade_var2');
          const outlookEl = document.getElementById('crushGrade_outlook');
          const fullForecastEl = document.getElementById('crushGrade_fullForecast');
          if (!mtdActualEl || !mtdForecastEl) return;

          const aRaw = String(mtdActualEl.value || '').replace(/,/g, '').trim();
          const fRaw = String(mtdForecastEl.value || '').replace(/,/g, '').trim();
          const a = parseFloat(aRaw);
          const f = parseFloat(fRaw);
          if (varEl) {
            if (Number.isFinite(f) && f !== 0 && Number.isFinite(a)) {
              const v = (a - f) / f;
              varEl.value = Math.round(v * 100) + '%';
            } else {
              varEl.value = '';
            }
          }

          // Mirror placeholders/values
          try { if (outlookEl) { outlookEl.placeholder = mtdActualEl.placeholder || (mtdActualEl.value || ''); outlookEl.value = mtdActualEl.value || ''; } } catch (e) { }
          try { if (fullForecastEl) { fullForecastEl.placeholder = mtdForecastEl.placeholder || (mtdForecastEl.value || ''); fullForecastEl.value = mtdForecastEl.value || ''; } } catch (e) { }
        } catch (e) { console.warn('updateCrushGradeMTDVarAndMirrors error', e); }
      }

      // lookup Full Budget (c) from Fixed Inputs when KPI and month match
      function updateCrushGradeFullBudget() {
        try {
          const kEl = document.getElementById('crushGrade_kpi');
          const monthEl = document.getElementById('crushGrade_month');
          const dateEl = document.getElementById('crushGrade_date');
          const fullBudgetEl = document.getElementById('crushGrade_fullBudget');
          if (!kEl || !fullBudgetEl) return;

          // determine month in YYYY-MM (prefer explicit month field, else use date)
          let month = '';
          if (monthEl && /^\d{4}-\d{2}$/.test((monthEl.value || '').trim())) month = (monthEl.value || '').trim();
          else if (dateEl && (dateEl.value || '')) {
            const d = new Date(dateEl.value);
            if (!isNaN(d)) month = d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0');
          }
          if (!month) return; // nothing to match against

          const normalize = s => String(s || '').replace(/\s+/g, ' ').trim().toLowerCase();
          const targetKpi = normalize(kEl.value || kEl.placeholder || '');
          if (!targetKpi) return;

          const fixed = (state.kpi_records || []).find(r => {
            try {
              if (r.dept !== 'Crushing') return false;
              if (r.subtype) return false; // only fixed inputs
              const rMonth = (r.month || '').toString().trim();
              if (rMonth !== month) return false;
              const rK = normalize(r.kpi || '');
              return rK === targetKpi || (rK && rK.includes(targetKpi)) || (targetKpi && targetKpi.includes(rK));
            } catch (e) { return false; }
          });

          if (fixed && fixed.fullBudget !== undefined && fixed.fullBudget !== null) {
            fullBudgetEl.placeholder = fixed.fullBudget;
            fullBudgetEl.value = fixed.fullBudget;
            console.debug('FullBudget matched from Fixed Inputs', fixed.fullBudget);
          } else {
            // clear placeholder/value if no match
            fullBudgetEl.placeholder = '';
            // do not clear user-entered value, only clear if value equals previous matched value? keep simple: leave value
          }
        } catch (e) { console.warn('updateCrushGradeFullBudget error', e); }
      }

      // update month based on date
      function updateCrushGradeMonth() {
        try {
          const dateEl = document.getElementById('crushGrade_date');
          const monthEl = document.getElementById('crushGrade_month');
          if (!dateEl || !monthEl) return;
          const date = dateEl.value;
          if (!date) { monthEl.value = ''; return; }
          const d = new Date(date);
          if (isNaN(d)) { monthEl.value = ''; return; }
          monthEl.value = d.getMonth() + 1; // 1 for Jan, 2 for Feb, etc.
        } catch (e) { console.warn('updateCrushGradeMonth error', e); }
      }

      // compute Full Var: (Outlook - FullForecast) / FullForecast
      function computeCrushGradeFullVar() {
        try {
          const outlookEl = document.getElementById('crushGrade_outlook');
          const fullForecastEl = document.getElementById('crushGrade_fullForecast');
          const varEl = document.getElementById('crushGrade_var3');
          if (!outlookEl || !fullForecastEl || !varEl) return;
          const oRaw = (outlookEl.value || '').replace(/,/g, '').trim();
          const fRaw = (fullForecastEl.value || '').replace(/,/g, '').trim();
          const o = parseFloat(oRaw);
          const f = parseFloat(fRaw);
          if (Number.isFinite(f) && f !== 0 && Number.isFinite(o)) {
            const v = (o - f) / f;
            varEl.value = Math.round(v * 100) + '%';
          } else {
            varEl.value = '';
          }
        } catch (e) { console.warn('computeCrushGradeFullVar error', e); }
      }

      (function wireCrushGradeForecast() {
        const k = document.getElementById('crushGrade_kpi');
        const dt = document.getElementById('crushGrade_date');
        const actual = document.getElementById('crushGrade_daily_actual');
        const forecast = document.getElementById('crushGrade_daily_forecast');
        const outlook = document.getElementById('crushGrade_outlook');
        const fullForecast = document.getElementById('crushGrade_fullForecast');
        if (k) k.addEventListener('input', updateCrushGradeDailyForecast);
        if (dt) dt.addEventListener('change', updateCrushGradeDailyForecast);
        if (dt) dt.addEventListener('change', updateCrushGradeMonth);
        if (actual) actual.addEventListener('input', computeCrushGradeVar);
        if (forecast) forecast.addEventListener('input', computeCrushGradeVar);
        if (forecast) forecast.addEventListener('input', updateCrushGradeMTDForecast);
        if (outlook) outlook.addEventListener('input', computeCrushGradeFullVar);
        if (fullForecast) fullForecast.addEventListener('input', computeCrushGradeFullVar);
        // also update Full Budget when KPI or month/date change
        const monthField = document.getElementById('crushGrade_month');
        if (k) k.addEventListener('input', updateCrushGradeFullBudget);
        if (monthField) monthField.addEventListener('change', updateCrushGradeFullBudget);
        if (dt) dt.addEventListener('change', updateCrushGradeFullBudget);
        // run once on load (update forecast first, then var and MTD forecast)
        setTimeout(() => { updateCrushGradeDailyForecast(); computeCrushGradeVar(); updateCrushGradeMTDForecast(); updateCrushGradeMonth(); computeCrushGradeFullVar(); }, 50);
      })();

      (function wireGeoGradeForecast() {
        const dt = document.getElementById('geoGrade_date');
        const rig = document.getElementById('geoGrade_rig');
        const actual = document.getElementById('geoGrade_daily_actual');
        const forecast = document.getElementById('geoGrade_daily_forecast');
        const mtdActual = document.getElementById('geoGrade_mtd_actual');
        const mtdForecast = document.getElementById('geoGrade_mtd_forecast');
        const fullForecast = document.getElementById('geoGrade_fullForecast');
        const outlook = document.getElementById('geoGrade_outlook');
        if (dt) dt.addEventListener('change', updateGeoGradeDailyForecast);
        if (rig) rig.addEventListener('input', updateGeoGradeDailyForecast);
        if (actual) actual.addEventListener('input', computeGeoGradeVar);
        if (rig) rig.addEventListener('input', computeGeoGradeVar);
        if (actual) actual.addEventListener('input', computeGeoGradeMTDActual);
        if (dt) dt.addEventListener('change', computeGeoGradeMTDActual);
        if (forecast) forecast.addEventListener('input', computeGeoGradeMTDForecast);
        if (dt) dt.addEventListener('change', computeGeoGradeMTDForecast);
        if (mtdActual) mtdActual.addEventListener('input', computeGeoGradeMTDVar);
        if (mtdForecast) mtdForecast.addEventListener('input', computeGeoGradeMTDVar);
        if (rig) rig.addEventListener('input', computeGeoGradeMTDVar);
        if (dt) dt.addEventListener('change', updateGeoGradeFullForecast);
        if (dt) dt.addEventListener('change', updateGeoGradeFullBudget);
        if (actual) actual.addEventListener('input', updateGeoGradeOutlook);
        if (forecast) forecast.addEventListener('input', updateGeoGradeOutlook);
        if (fullForecast) fullForecast.addEventListener('input', updateGeoGradeOutlook);
        if (dt) dt.addEventListener('change', updateGeoGradeOutlook);
        if (outlook) outlook.addEventListener('input', computeGeoGradeFullVar);
        if (fullForecast) fullForecast.addEventListener('input', computeGeoGradeFullVar);
        if (dt) dt.addEventListener('change', updateGeoGradeMonth);
        // run once on load
        setTimeout(() => { updateGeoGradeDailyForecast(); computeGeoGradeVar(); computeGeoGradeMTDActual(); computeGeoGradeMTDForecast(); computeGeoGradeMTDVar(); updateGeoGradeFullForecast(); updateGeoGradeFullBudget(); updateGeoGradeOutlook(); computeGeoGradeFullVar(); updateGeoGradeMonth(); }, 50);
      })();

      // update month based on date for ore
      function updateCrushOreMonth() {
        try {
          const dateEl = document.getElementById('crushOre_date');
          const monthEl = document.getElementById('crushOre_month');
          if (!dateEl || !monthEl) return;
          const date = dateEl.value;
          if (!date) { monthEl.value = ''; return; }
          const d = new Date(date);
          if (isNaN(d)) { monthEl.value = ''; return; }
          monthEl.value = d.getMonth() + 1; // 1 for Jan, 2 for Feb, etc.
        } catch (e) { console.warn('updateCrushOreMonth error', e); }
      }

      // compute daily forecast for ore: fullForecast / days
      function updateCrushOreDailyForecast() {
        try {
          const kpiEl = document.getElementById('crushOre_kpi');
          const dateEl = document.getElementById('crushOre_date');
          const outEl = document.getElementById('crushOre_daily_forecast');
          if (!kpiEl || !dateEl || !outEl) return;
          const kpi = (kpiEl.value || '').trim();
          const normalizeKPI = s => String(s || '').replace(/\s+/g, ' ').trim().toLowerCase();
          const kpiNorm = normalizeKPI(kpi);
          const date = (dateEl.value || '').trim();
          if (!kpi || !date) { outEl.value = ''; return; }
          const d = new Date(date);
          if (isNaN(d)) { outEl.value = ''; return; }
          const month = d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0');
          const fixed = (state.kpi_records || []).find(r => {
            if (r.dept !== 'Crushing') return false;
            if (r.subtype) return false;
            const rMonth = (r.month && String(r.month).trim()) || '';
            if (rMonth !== month) return false;
            const rK = normalizeKPI(r.kpi || '');
            return rK === kpiNorm;
          });
          if (fixed && (fixed.fullForecast !== undefined && fixed.fullForecast !== null) && (fixed.days !== undefined && fixed.days !== null)) {
            const ff = parseFloat(String(fixed.fullForecast).replace(/,/g, ''));
            const days = parseFloat(String(fixed.days).replace(/,/g, ''));
            if (Number.isFinite(ff) && Number.isFinite(days) && days !== 0) {
              let val = Math.round(ff / days);
              if (val >= 1000) {
                val = val.toLocaleString();
              }
              outEl.value = val;
            } else {
              outEl.value = '';
            }
          } else {
            outEl.value = '';
          }
        } catch (e) { console.warn('updateCrushOreDailyForecast error', e); }
      }

      // compute full forecast for ore: directly from fixed inputs
      function updateCrushOreFullForecast() {
        try {
          const kpiEl = document.getElementById('crushOre_kpi');
          const dateEl = document.getElementById('crushOre_date');
          const outEl = document.getElementById('crushOre_fullForecast');
          if (!kpiEl || !dateEl || !outEl) return;
          const kpi = (kpiEl.value || '').trim();
          const normalizeKPI = s => String(s || '').replace(/\s+/g, ' ').trim().toLowerCase();
          const kpiNorm = normalizeKPI(kpi);
          const date = (dateEl.value || '').trim();
          if (!kpi || !date) { outEl.value = ''; return; }
          const d = new Date(date);
          if (isNaN(d)) { outEl.value = ''; return; }
          const month = d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0');
          const fixed = (state.kpi_records || []).find(r => {
            if (r.dept !== 'Crushing') return false;
            if (r.subtype) return false;
            const rMonth = (r.month && String(r.month).trim()) || '';
            if (rMonth !== month) return false;
            const rK = normalizeKPI(r.kpi || '');
            return rK === kpiNorm;
          });
          if (fixed && (fixed.fullForecast !== undefined && fixed.fullForecast !== null)) {
            outEl.value = fixed.fullForecast;
          } else {
            outEl.value = '';
          }
        } catch (e) { console.warn('updateCrushOreFullForecast error', e); }
      }

      // compute full budget for ore: directly from fixed inputs
      function updateCrushOreFullBudget() {
        try {
          const kpiEl = document.getElementById('crushOre_kpi');
          const dateEl = document.getElementById('crushOre_date');
          const outEl = document.getElementById('crushOre_fullBudget');
          if (!kpiEl || !dateEl || !outEl) return;
          const kpi = (kpiEl.value || '').trim();
          const normalizeKPI = s => String(s || '').replace(/\s+/g, ' ').trim().toLowerCase();
          const kpiNorm = normalizeKPI(kpi);
          const date = (dateEl.value || '').trim();
          if (!kpi || !date) { outEl.value = ''; return; }
          const d = new Date(date);
          if (isNaN(d)) { outEl.value = ''; return; }
          const month = d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0');
          const fixed = (state.kpi_records || []).find(r => {
            if (r.dept !== 'Crushing') return false;
            if (r.subtype) return false;
            const rMonth = (r.month && String(r.month).trim()) || '';
            if (rMonth !== month) return false;
            const rK = normalizeKPI(r.kpi || '');
            return rK === kpiNorm;
          });
          if (fixed && (fixed.fullBudget !== undefined && fixed.fullBudget !== null)) {
            outEl.value = fixed.fullBudget;
          } else {
            outEl.value = '';
          }
        } catch (e) { console.warn('updateCrushOreFullBudget error', e); }
      }

      // compute var for ore: (DailyActual - DailyForecast) / DailyForecast
      function computeCrushOreVar() {
        try {
          const actualEl = document.getElementById('crushOre_daily_actual');
          const forecastEl = document.getElementById('crushOre_daily_forecast');
          const varEl = document.getElementById('crushOre_var1');
          if (!actualEl || !forecastEl || !varEl) return;
          const aRaw = (actualEl.value || '').replace(/,/g, '').trim();
          const fRaw = (forecastEl.value || '').replace(/,/g, '').trim();
          const a = parseFloat(aRaw);
          const f = parseFloat(fRaw);
          if (Number.isFinite(f) && f !== 0 && Number.isFinite(a)) {
            const v = (a - f) / f;
            // show as whole percentage without decimal places (e.g. 12%)
            varEl.value = Math.round(v * 100) + '%';
          } else {
            varEl.value = '';
          }
        } catch (e) { console.warn('computeCrushOreVar error', e); }
      }

      // compute MTD Actual for ore: sum of all Daily Actual in the same month + current Daily Actual
      function computeCrushOreMTDActual() {
        try {
          const dateEl = document.getElementById('crushOre_date');
          const dailyActualEl = document.getElementById('crushOre_daily_actual');
          const mtdActualEl = document.getElementById('crushOre_mtd_actual');
          if (!dateEl || !dailyActualEl || !mtdActualEl) return;
          const date = (dateEl.value || '').trim();
          const current = parseFloat(String(dailyActualEl.value || '').replace(/,/g, '')) || 0;
          if (!date) {
            mtdActualEl.value = current.toLocaleString();
            return;
          }
          const d = new Date(date);
          if (isNaN(d)) { mtdActualEl.value = ''; return; }
          const month = String(d.getMonth() + 1);
          // sum daily_actual from saved records with matching month, excluding the editing record
          let sum = 0;
          (state.kpi_records || []).forEach(r => {
            if (r.dept === 'Crushing' && r.subtype === 'ore' && r.month === month && r.daily_actual && r.id !== editingKPIId) {
              const val = parseFloat(String(r.daily_actual).replace(/,/g, ''));
              if (Number.isFinite(val)) sum += val;
            }
          });
          // add current daily actual
          const cur = parseFloat(String(dailyActualEl.value || '').replace(/,/g, ''));
          if (Number.isFinite(cur)) sum += cur;
          // set the value with formatting
          mtdActualEl.value = sum.toLocaleString();
        } catch (e) { console.warn('computeCrushOreMTDActual error', e); }
      }

      // compute MTD var for ore: (MTD Actual - MTD Forecast) / MTD Forecast
      function computeCrushOreMTDVar() {
        try {
          const mtdActualEl = document.getElementById('crushOre_mtd_actual');
          const mtdForecastEl = document.getElementById('crushOre_mtd_forecast');
          const varEl = document.getElementById('crushOre_var2');
          if (!mtdActualEl || !mtdForecastEl || !varEl) return;
          const aRaw = (mtdActualEl.value || '').replace(/,/g, '').trim();
          const fRaw = (mtdForecastEl.value || '').replace(/,/g, '').trim();
          const a = parseFloat(aRaw);
          const f = parseFloat(fRaw);
          if (Number.isFinite(f) && f !== 0 && Number.isFinite(a)) {
            const v = (a - f) / f;
            varEl.value = Math.round(v * 100) + '%';
          } else {
            varEl.value = '';
          }
        } catch (e) { console.warn('computeCrushOreMTDVar error', e); }
      }

      // compute Full Var for ore: (Outlook - FullForecast) / FullForecast
      function computeCrushOreFullVar() {
        try {
          const outlookEl = document.getElementById('crushOre_outlook');
          const fullForecastEl = document.getElementById('crushOre_fullForecast');
          const varEl = document.getElementById('crushOre_var3');
          if (!outlookEl || !fullForecastEl || !varEl) return;
          const oRaw = (outlookEl.value || '').replace(/,/g, '').trim();
          const fRaw = (fullForecastEl.value || '').replace(/,/g, '').trim();
          const o = parseFloat(oRaw);
          const f = parseFloat(fRaw);
          if (Number.isFinite(f) && f !== 0 && Number.isFinite(o)) {
            const v = (o - f) / f;
            varEl.value = Math.round(v * 100) + '%';
          } else {
            varEl.value = '';
          }
        } catch (e) { console.warn('computeCrushOreFullVar error', e); }
      }

      // compute Outlook (a) for ore: ((daysInMonth - day) / day + 1) * MTD Actual
      function updateCrushOreOutlook() {
        try {
          const dateEl = document.getElementById('crushOre_date');
          const mtdActualEl = document.getElementById('crushOre_mtd_actual');
          const outlookEl = document.getElementById('crushOre_outlook');
          if (!dateEl || !mtdActualEl || !outlookEl) return;
          const date = (dateEl.value || '').trim();
          const mtdActualRaw = (mtdActualEl.value || '').replace(/,/g, '').trim();
          if (!date || !mtdActualRaw) { outlookEl.value = ''; return; }
          const d = new Date(date);
          if (isNaN(d)) { outlookEl.value = ''; return; }
          const year = d.getFullYear();
          const month = d.getMonth(); // 0-based
          const day = d.getDate();
          const daysInMonth = new Date(year, month + 1, 0).getDate();
          const remaining = daysInMonth - day;
          const ratio = (remaining / day) + 1;
          const mtdActual = parseFloat(mtdActualRaw);
          if (Number.isFinite(mtdActual)) {
            let val = Math.floor(ratio * mtdActual);
            if (val >= 1000) {
              val = val.toLocaleString();
            }
            outlookEl.value = val;
          } else {
            outlookEl.value = '';
          }
        } catch (e) { console.warn('updateCrushOreOutlook error', e); }
      }

      // Compute MTD Forecast for ore: sum of MTD Forecast from records with matching month + Daily Forecast
      function computeCrushOreMTDForecast() {
        try {
          const dateEl = document.getElementById('crushOre_date');
          const dailyForecastEl = document.getElementById('crushOre_daily_forecast');
          const mtdForecastEl = document.getElementById('crushOre_mtd_forecast');
          const dailyActualEl = document.getElementById('crushOre_daily_actual');
          if (!dateEl || !dailyForecastEl || !mtdForecastEl || !dailyActualEl) return;
          const dailyActualValue = (dailyActualEl.value || '').trim();
          if (!dailyActualValue) {
            // If no daily actual, maintain daily forecast value
            mtdForecastEl.value = dailyForecastEl.value || '';
            return;
          }
          // Get month from date
          const dateValue = (dateEl.value || '').trim();
          if (!dateValue) {
            mtdForecastEl.value = dailyForecastEl.value || '';
            return;
          }
          const d = new Date(dateValue);
          if (isNaN(d)) {
            mtdForecastEl.value = dailyForecastEl.value || '';
            return;
          }
          const month = String(d.getMonth() + 1);
          // sum mtd_forecast from saved records with matching month, excluding the editing record
          let sum = 0;
          (state.kpi_records || []).forEach(r => {
            if (r.dept === 'Crushing' && r.subtype === 'ore' && r.month === month && r.mtd_forecast && r.id !== editingKPIId) {
              const val = parseFloat(String(r.mtd_forecast).replace(/,/g, ''));
              if (Number.isFinite(val)) sum += val;
            }
          });
          // add current daily forecast
          const current = parseFloat(String(dailyForecastEl.value || '').replace(/,/g, ''));
          if (Number.isFinite(current)) sum += current;
          // set the value
          mtdForecastEl.value = sum.toLocaleString();
        } catch (e) { console.warn('computeCrushOreMTDForecast error', e); }
      }

      (function wireCrushOreForecast() {
        const k = document.getElementById('crushOre_kpi');
        const dt = document.getElementById('crushOre_date');
        const actual = document.getElementById('crushOre_daily_actual');
        const forecast = document.getElementById('crushOre_daily_forecast');
        const mtdActual = document.getElementById('crushOre_mtd_actual');
        const mtdForecast = document.getElementById('crushOre_mtd_forecast');
        const outlook = document.getElementById('crushOre_outlook');
        const fullForecast = document.getElementById('crushOre_fullForecast');
        if (k) k.addEventListener('input', updateCrushOreDailyForecast);
        if (dt) dt.addEventListener('change', updateCrushOreDailyForecast);
        if (k) k.addEventListener('input', updateCrushOreFullForecast);
        if (dt) dt.addEventListener('change', updateCrushOreFullForecast);
        if (k) k.addEventListener('input', updateCrushOreFullBudget);
        if (dt) dt.addEventListener('change', updateCrushOreFullBudget);
        if (dt) dt.addEventListener('change', updateCrushOreMonth);
        if (dt) dt.addEventListener('change', updateCrushOreOutlook);
        if (dt) dt.addEventListener('change', computeCrushOreMTDActual);
        if (actual) actual.addEventListener('input', () => {
          computeCrushOreMTDActual();
          computeCrushOreMTDVar();
          computeCrushOreMTDForecast();
        });
        if (actual) actual.addEventListener('input', computeCrushOreVar);
        if (actual) actual.addEventListener('input', updateCrushOreOutlook);
        if (actual) actual.addEventListener('input', computeCrushOreFullVar);
        if (forecast) forecast.addEventListener('input', computeCrushOreVar);
        if (dt) dt.addEventListener('change', computeCrushOreMTDForecast);
        if (forecast) forecast.addEventListener('input', computeCrushOreMTDForecast);
        // Format Daily Actual on input
        if (actual) actual.addEventListener('input', () => {
          const val = actual.value.replace(/,/g, '');
          const num = parseFloat(val);
          if (!isNaN(num)) actual.value = num.toLocaleString();
        });
        if (mtdActual) mtdActual.addEventListener('input', computeCrushOreMTDVar);
        if (mtdActual) mtdActual.addEventListener('input', updateCrushOreOutlook);
        if (dt) dt.addEventListener('change', updateCrushOreOutlook);
        if (mtdForecast) mtdForecast.addEventListener('input', computeCrushOreMTDVar);
        if (outlook) outlook.addEventListener('input', computeCrushOreFullVar);
        if (fullForecast) fullForecast.addEventListener('input', computeCrushOreFullVar);
        // run once on load
        setTimeout(() => { updateCrushOreDailyForecast(); updateCrushOreFullForecast(); updateCrushOreFullBudget(); updateCrushOreMonth(); computeCrushOreVar(); computeCrushOreMTDActual(); computeCrushOreMTDVar(); updateCrushOreOutlook(); computeCrushOreFullVar(); computeCrushOreMTDForecast(); }, 50);
      })();

      // Ensure Daily Forecast placeholder/value is mirrored into the corresponding MTD Forecast input
      (function syncDailyPlaceholderAndValue() {
        try {
          const dailySelector = 'input[id$="_daily_forecast"], input[placeholder*="daily forecast" i]';

          function findMTDFor(daily) {
            try {
              const id = (daily.id || '');
              if (id && id.toLowerCase().endsWith('_daily_forecast')) {
                const prefix = id.slice(0, -'_daily_forecast'.length);
                const cand = document.getElementById(prefix + '_mtd_forecast');
                if (cand) return cand;
              }
              // scan nearby inputs in the same row/container
              const container = daily.closest('tr') || daily.closest('tbody') || daily.closest('.vertical-form') || daily.parentElement || document;
              if (container) {
                const candidates = Array.from(container.querySelectorAll('input'));
                // prefer inputs with id or placeholder mentioning 'mtd'
                let mtd = candidates.find(i => { const id = (i.id || '').toLowerCase(); const ph = (i.placeholder || '').toLowerCase(); return id.includes('mtd') || ph.includes('mtd'); });
                if (mtd) return mtd;
                // fallback: placeholder contains 'MTD Forecast' text
                mtd = candidates.find(i => (i.placeholder || '').toLowerCase().includes('mtd forecast'));
                if (mtd) return mtd;
              }
            } catch (e) { }
            return null;
          }

          const watched = new Map(); // dailyEl -> { mtd, lastValue, lastPlaceholder, mo }

          function registerDaily(d) {
            if (watched.has(d)) return;
            const mtd = findMTDFor(d);
            if (!mtd) return;
            // initial sync
            try {
              if ((d.placeholder || '').trim()) mtd.placeholder = d.placeholder;
            } catch (e) { }
            try {
              // For Crushing ore form, don't sync value if Daily Actual has a value
              const shouldSyncValue = !(d.id === 'crushOre_daily_forecast' && (document.getElementById('crushOre_daily_actual')?.value || '').trim());
              if (shouldSyncValue && (d.value || '').trim()) mtd.value = d.value;
            } catch (e) { }
            const info = { mtd, lastValue: d.value || '', lastPlaceholder: d.placeholder || '' };
            // observe placeholder attribute changes
            try {
              const mo = new MutationObserver((mut) => {
                mut.forEach(m => {
                  if (m.type === 'attributes' && m.attributeName === 'placeholder') {
                    try { info.mtd.placeholder = d.placeholder || ''; info.lastPlaceholder = d.placeholder || ''; console.debug('synced placeholder (mutObs)', d.placeholder); } catch (e) { }
                  }
                });
              });
              mo.observe(d, { attributes: true, attributeFilter: ['placeholder'] });
              info.mo = mo;
            } catch (e) { }
            watched.set(d, info);
          }

          // initial scan
          Array.from(document.querySelectorAll(dailySelector)).forEach(registerDaily);

          // watch for dynamic additions
          const docMo = new MutationObserver(muts => {
            muts.forEach(mu => {
              mu.addedNodes && mu.addedNodes.forEach(n => {
                try { if (n && n.querySelectorAll) { Array.from(n.querySelectorAll(dailySelector)).forEach(registerDaily); } } catch (e) { }
              });
            });
          });
          docMo.observe(document.body, { childList: true, subtree: true });

          // poll for property (.value) changes and for placeholders that weren't caught by attribute observer
          setInterval(() => {
            watched.forEach((info, d) => {
              try {
                // For Crushing ore form, don't sync value if Daily Actual has a value
                const shouldSyncValue = !(d.id === 'crushOre_daily_forecast' && (document.getElementById('crushOre_daily_actual')?.value || '').trim());
                if (shouldSyncValue && d.value !== info.lastValue) { info.mtd.value = d.value; info.lastValue = d.value; console.debug('synced value (poll)', d.value); }
                if (d.placeholder !== info.lastPlaceholder) { info.mtd.placeholder = d.placeholder || ''; info.lastPlaceholder = d.placeholder || ''; console.debug('synced placeholder (poll)', d.placeholder); }
              } catch (e) { }
            });
          }, 200);

        } catch (e) { console.warn('syncDailyPlaceholderAndValue error', e); }
      })();

      // Generic wiring: copy Daily Forecast -> MTD Forecast for inputs following common id/placeholder patterns
      (function wireGenericDailyToMTD() {
        try {
          // 1) Strong id-pattern match: <prefix>_daily_forecast -> <prefix>_mtd_forecast
          document.querySelectorAll('input[id$="_daily_forecast"]').forEach(inp => {
            inp.addEventListener('input', () => {
              const id = inp.id || '';
              const prefix = id.slice(0, -'_daily_forecast'.length);
              if (!prefix) return;
              const mtd = document.getElementById(prefix + '_mtd_forecast');
              if (mtd) {
                // For Crushing ore form, don't sync if Daily Actual has a value
                if (!(id === 'crushOre_daily_forecast' && (document.getElementById('crushOre_daily_actual')?.value || '').trim())) {
                  mtd.value = inp.value;
                  console.debug('copied by id-pattern', inp.id, '->', mtd.id);
                }
              }
            });
          });

          // 2) Delegated fallback: any input whose placeholder or nearby label appears to be a Daily Forecast
          document.addEventListener('input', (ev) => {
            const t = ev.target;
            if (!(t && t.tagName && t.tagName.toLowerCase() === 'input')) return;
            const ph = (t.placeholder || '').toLowerCase();
            // check placeholder contains both words 'daily' and 'forecast'
            if (!(ph.includes('daily') && ph.includes('forecast'))) return;

            // search for an MTD Forecast input in the same row/container
            const container = t.closest('tr') || t.closest('tbody') || t.closest('.vertical-form') || t.parentElement || document;
            if (!container) return;
            const candidates = Array.from(container.querySelectorAll('input'));
            // prefer inputs whose id explicitly references mtd
            let mtd = candidates.find(i => { const id = (i.id || '').toLowerCase(); return id.includes('mtd_forecast') || id.includes('_mtd_') || id.endsWith('_mtd_forecast') || id.includes('_mtd'); });
            if (!mtd) {
              // fallback: match placeholder containing 'mtd' or 'mtd forecast'
              mtd = candidates.find(i => { const p = (i.placeholder || '').toLowerCase(); return p.includes('mtd') || p.includes('mtd forecast') || p.includes('mtd_forecast'); });
            }
            if (!mtd) {
              // as a last resort, match inputs whose label text (previous sibling) contains 'MTD'
              mtd = candidates.find(i => {
                const prev = i.previousElementSibling; if (!prev) return false; const txt = (prev.textContent || '').toLowerCase(); return txt.includes('mtd');
              });
            }
            if (mtd) { mtd.value = t.value; console.debug('copied by container-scan', t.placeholder || t.id, '->', mtd.placeholder || mtd.id); }
          }, { capture: true });
        } catch (e) { console.warn('wireGenericDailyToMTD error', e); }
      })();

      // compute MTD Actual by finding matching Grade records and adding their MTD Actual to current Daily Actual
      function updateCrushGradeMTDActual() {
        try {
          const kEl = document.getElementById('crushGrade_kpi');
          const dateEl = document.getElementById('crushGrade_date');
          const dailyActualEl = document.getElementById('crushGrade_daily_actual');
          const mtdEl = document.getElementById('crushGrade_mtd_actual');
          if (!kEl || !dateEl || !dailyActualEl || !mtdEl) return;
          const kpi = (kEl.value || '').trim();
          const date = (dateEl.value || '').trim();
          if (!kpi || !date) { mtdEl.value = ''; return; }
          const d = new Date(date);
          if (isNaN(d)) { mtdEl.value = ''; return; }
          const month = d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0');

          // helper: convert a stored record month/date to YYYY-MM where possible
          function recordToYYYYMM(rec) {
            if (!rec) return '';
            const tryFromString = s => {
              if (!s) return '';
              const t = String(s).trim();
              if (/^\d{4}-\d{2}$/.test(t)) return t;
              const d = new Date(t);
              if (!isNaN(d)) return d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0');
              // try patterns like DD-MMM-YYYY or DD/MM/YYYY
              const parts1 = t.match(/^(\d{1,2})[-\/](\w{3,})[-\/](\d{4})$/);
              if (parts1) { const dd = parts1[1]; const mon = parts1[2]; const yy = parts1[3]; const ddm = new Date(yy + ' ' + mon + ' ' + dd); if (!isNaN(ddm)) return ddm.getFullYear() + '-' + String(ddm.getMonth() + 1).padStart(2, '0'); }
              // fallback
              return '';
            };
            let out = '';
            if (rec.month) out = tryFromString(rec.month);
            if (!out && rec.date) out = tryFromString(rec.date);
            return out || '';
          }

          // normalize KPI for tolerant matching
          const normalizeKPI = s => String(s || '').replace(/\s+/g, ' ').trim().toLowerCase();
          const kpiNorm = normalizeKPI(kpi);
          // find grade records in state matching dept=Crushing, subtype=grade, same KPI and month
          const matches = (state.kpi_records || []).filter(r => {
            try {
              if (r.dept !== 'Crushing') return false;
              if (r.subtype !== 'grade') return false;
              const rKpiNorm = normalizeKPI(r.kpi || '');
              // tolerant KPI match: exact or substring one-way
              const kpiMatches = (rKpiNorm === kpiNorm) || (rKpiNorm && rKpiNorm.includes(kpiNorm)) || (kpiNorm && kpiNorm.includes(rKpiNorm));
              if (!kpiMatches) return false;
              const rMonth = recordToYYYYMM(r);
              if (rMonth === month) return true;
              // fallback: try parsing r.date directly and compare year/month
              if (r.date) { const rd = new Date(r.date); if (!isNaN(rd)) { const ym = rd.getFullYear() + '-' + String(rd.getMonth() + 1).padStart(2, '0'); if (ym === month) return true; } }
              if (r.month) { const rm = recordToYYYYMM({ month: r.month }); if (rm === month) return true; }
              return false;
            } catch (e) { return false; }
          });

          // sumproduct formula as requested:
          // numerator = sum_over_matches(r.daily_actual * r.daily_forecast) + (form.daily_actual * form.daily_forecast)
          // denominator = sum_over_matches(r.daily_forecast) + form.daily_forecast
          // result = numerator / denominator
          let numerator = 0;
          let denomSum = 0;
          matches.forEach(r => {
            const daRaw = (r.daily_actual !== undefined && r.daily_actual !== null) ? String(r.daily_actual) : '';
            const dfRaw = (r.daily_forecast !== undefined && r.daily_forecast !== null) ? String(r.daily_forecast) : '';
            const da = parseFloat(daRaw.toString().replace(/,/g, ''));
            const df = parseFloat(dfRaw.toString().replace(/,/g, ''));
            if (Number.isFinite(da) && Number.isFinite(df)) {
              numerator += da * df;
            }
            if (Number.isFinite(df)) denomSum += df;
          });

          const formDailyActual = parseFloat((dailyActualEl.value || '').toString().replace(/,/g, ''));
          const formDailyForecast = parseFloat(((document.getElementById('crushGrade_daily_forecast') || {}).value || '').toString().replace(/,/g, ''));
          if (Number.isFinite(formDailyActual) && Number.isFinite(formDailyForecast)) {
            numerator += formDailyActual * formDailyForecast;
          }
          if (Number.isFinite(formDailyForecast)) denomSum += formDailyForecast;

          let res = '';
          if (denomSum === 0) {
            // fallback: if no forecast weights, show form daily actual (or blank if not numeric)
            if (Number.isFinite(formDailyActual)) res = formDailyActual;
            else res = '';
          } else {
            res = numerator / denomSum;
          }

          if (Number.isFinite(res)) {
            mtdEl.value = (Math.round(res * 100) / 100).toFixed(2);
          } else {
            mtdEl.value = '';
          }
          try { if (typeof updateCrushGradeMTDVarAndMirrors === 'function') updateCrushGradeMTDVarAndMirrors(); } catch (e) { }
        } catch (e) { console.warn('updateCrushGradeMTDActual error', e); }
      }

      // wire MTD updater to KPI, Date and Daily Actual changes and run after forecast/var initialization
      (function wireCrushGradeMTD() {
        const k = document.getElementById('crushGrade_kpi');
        const dt = document.getElementById('crushGrade_date');
        const actual = document.getElementById('crushGrade_daily_actual');
        if (k) k.addEventListener('input', updateCrushGradeMTDActual);
        if (dt) dt.addEventListener('change', updateCrushGradeMTDActual);
        if (actual) actual.addEventListener('input', updateCrushGradeMTDActual);
        // also update variance/mirrors when MTD values change
        const mtdActual = document.getElementById('crushGrade_mtd_actual');
        const mtdForecast = document.getElementById('crushGrade_mtd_forecast');
        if (mtdActual) mtdActual.addEventListener('input', () => { try { updateCrushGradeMTDVarAndMirrors(); } catch (e) { } });
        if (mtdForecast) mtdForecast.addEventListener('input', () => { try { updateCrushGradeMTDVarAndMirrors(); } catch (e) { } });
        setTimeout(updateCrushGradeMTDActual, 150);
      })();

      // compute variance for Full Budget (c) Var when Daily Actual changes
      function updateCrushGradeVar3() {
        try {
          const outlookEl = document.getElementById('crushGrade_outlook');
          const fullForecastEl = document.getElementById('crushGrade_fullForecast');
          const var3El = document.getElementById('crushGrade_var3');
          if (!outlookEl || !fullForecastEl || !var3El) return;
          const outlook = parseFloat((outlookEl.value || '').replace(/,/g, '')) || 0;
          const fullForecast = parseFloat((fullForecastEl.value || '').replace(/,/g, '')) || 0;
          if (fullForecast === 0) {
            var3El.value = '';
            return;
          }
          const variance = ((outlook - fullForecast) / fullForecast) * 100;
          if (Number.isFinite(variance)) {
            var3El.value = Math.round(variance) + '%';
          } else {
            var3El.value = '';
          }
        } catch (e) { console.warn('updateCrushGradeVar3 error', e); }
      }

      // wire the variance computation to Daily Actual input
      (function wireCrushGradeVar3() {
        const dailyActualEl = document.getElementById('crushGrade_daily_actual');
        if (dailyActualEl) dailyActualEl.addEventListener('input', updateCrushGradeVar3);
        // also update when outlook or fullForecast change, in case they are entered after
        const outlookEl = document.getElementById('crushGrade_outlook');
        const fullForecastEl = document.getElementById('crushGrade_fullForecast');
        if (outlookEl) outlookEl.addEventListener('input', updateCrushGradeVar3);
        if (fullForecastEl) fullForecastEl.addEventListener('input', updateCrushGradeVar3);
      })();

      // OHS fixed form helpers
      const btnOHSFixedClear = document.getElementById('btnOHSFixedClear');
      if (btnOHSFixedClear) btnOHSFixedClear.addEventListener('click', () => {
        ['ohsKPI', 'ohsTargetMonth', 'ohsNumDays', 'ohsFullForecast', 'ohsFullBudget'].forEach(id => { const el = document.getElementById(id); if (el) el.value = ''; });
        const now = new Date(); const yyyy = now.getFullYear(); const mm = String(now.getMonth() + 1).padStart(2, '0'); const val = yyyy + '-' + mm;
        const m = document.getElementById('ohsTargetMonth'); if (m) m.value = val;
      });
      const btnOHSFixedSave = document.getElementById('btnOHSFixedSave');
      if (btnOHSFixedSave) btnOHSFixedSave.addEventListener('click', () => {
        // gather fields and persist into state.kpi_records under dept 'OHS'
        const kpi = (document.getElementById('ohsKPI') || {}).value || '';
        const month = (document.getElementById('ohsTargetMonth') || {}).value || '';
        const days = (document.getElementById('ohsNumDays') || {}).value || '';
        const fullForecast = (document.getElementById('ohsFullForecast') || {}).value || '';
        const fullBudget = (document.getElementById('ohsFullBudget') || {}).value || '';
        if (!kpi) { alert('Choose KPI'); return; }
        const rec = { kpi, month, days, fullForecast, fullBudget };
        addKPIRecord('OHS', rec);
        // clear fields after successful save
        ['ohsKPI', 'ohsTargetMonth', 'ohsNumDays', 'ohsFullForecast', 'ohsFullBudget'].forEach(id => { const el = document.getElementById(id); if (el) el.value = ''; });
        alert('Record saved');
      });

      // wire OHS Full Budget to automatically set Full Forecast to Full Budget / 12
      (function wireOHSFullBudget() {
        const ohsFullBudgetEl = document.getElementById('ohsFullBudget');
        if (ohsFullBudgetEl) ohsFullBudgetEl.addEventListener('input', () => {
          const val = parseFloat(ohsFullBudgetEl.value.replace(/,/g, ''));
          const forecastEl = document.getElementById('ohsFullForecast');
          if (forecastEl) {
            if (Number.isFinite(val)) {
              const forecast = val / 12;
              forecastEl.value = Math.round(forecast);
            } else {
              forecastEl.value = '';
            }
          }
        });
      })();

      // OHS Safety form helpers
      const btnOHSSafetyClear = document.getElementById('btnOHSSafetyClear');
      if (btnOHSSafetyClear) btnOHSSafetyClear.addEventListener('click', () => {
        ['ohsSafety_kpi', 'ohsSafety_date', 'ohsSafety_daily_actual', 'ohsSafety_daily_forecast', 'ohsSafety_var1', 'ohsSafety_mtd_actual', 'ohsSafety_mtd_forecast', 'ohsSafety_var2', 'ohsSafety_outlook', 'ohsSafety_fullForecast', 'ohsSafety_fullBudget', 'ohsSafety_var3', 'ohsSafety_month'].forEach(id => { const el = document.getElementById(id); if (el) el.value = id === 'ohsSafety_mtd_forecast' ? '2' : ''; });
        const k = document.getElementById('ohsSafety_kpi'); if (k) k.value = 'Safety Incidents';
      });
      const btnOHSSafetySave = document.getElementById('btnOHSSafetySave');
      if (btnOHSSafetySave) btnOHSSafetySave.addEventListener('click', () => {
        const kpi = (document.getElementById('ohsSafety_kpi') || {}).value || '';
        const date = (document.getElementById('ohsSafety_date') || {}).value || '';
        const daily_actual = (document.getElementById('ohsSafety_daily_actual') || {}).value || '';
        const daily_forecast = (document.getElementById('ohsSafety_daily_forecast') || {}).value || '0';
        const var1 = (document.getElementById('ohsSafety_var1') || {}).value || '';
        const mtd_actual = (document.getElementById('ohsSafety_mtd_actual') || {}).value || '';
        const mtd_forecast = (document.getElementById('ohsSafety_mtd_forecast') || {}).value || '';
        const var2 = (document.getElementById('ohsSafety_var2') || {}).value || '';
        const outlook = (document.getElementById('ohsSafety_outlook') || {}).value || '';
        const fullForecast = (document.getElementById('ohsSafety_fullForecast') || {}).value || '';
        const fullBudget = (document.getElementById('ohsSafety_fullBudget') || {}).value || '';
        const var3 = (document.getElementById('ohsSafety_var3') || {}).value || '';
        const month = (document.getElementById('ohsSafety_month') || {}).value || '';
        if (!kpi) { alert('Enter KPI'); return; }
        const rec = { subtype: 'safety', kpi, date, daily_actual, daily_forecast, var1, mtd_actual, mtd_forecast, var2, outlook, fullForecast, fullBudget, var3, month };
        if (editingKPIId) {
          const existing = (state.kpi_records || []).find(r => r.id === editingKPIId);
          if (existing && existing.subtype === 'safety') rec.id = editingKPIId;
        }
        addKPIRecord('OHS', rec);
        ['ohsSafety_kpi', 'ohsSafety_date', 'ohsSafety_daily_actual', 'ohsSafety_daily_forecast', 'ohsSafety_var1', 'ohsSafety_mtd_actual', 'ohsSafety_mtd_forecast', 'ohsSafety_var2', 'ohsSafety_outlook', 'ohsSafety_fullForecast', 'ohsSafety_fullBudget', 'ohsSafety_var3', 'ohsSafety_month'].forEach(id => { const el = document.getElementById(id); if (el) el.value = id === 'ohsSafety_mtd_forecast' ? '2' : ''; });
        editingKPIId = null;
        alert('Safety record saved');
      });

      // compute variances for OHS Safety
      function computeOHSSafetyVar1() {
        const actualEl = document.getElementById('ohsSafety_daily_actual');
        const forecastEl = document.getElementById('ohsSafety_daily_forecast');
        const varEl = document.getElementById('ohsSafety_var1');
        if (!actualEl || !forecastEl || !varEl) return;
        const a = parseFloat(actualEl.value.replace(/,/g, ''));
        const f = parseFloat(forecastEl.value.replace(/,/g, '')) || 0;
        if (Number.isFinite(a) && Number.isFinite(f)) {
          if (a === 0) {
            varEl.value = '100%';
          } else if (a < 0) {
            varEl.value = '-100%';
          } else if (f === 0) {
            varEl.value = '-100%';
          } else {
            const v = ((a - f) / f) * 100;
            varEl.value = Math.round(v) + '%';
          }
        } else {
          varEl.value = '';
        }
      }

      function computeOHSSafetyVar2() {
        const mtdActualEl = document.getElementById('ohsSafety_mtd_actual');
        const mtdForecastEl = document.getElementById('ohsSafety_mtd_forecast');
        const varEl = document.getElementById('ohsSafety_var2');
        if (!mtdActualEl || !mtdForecastEl || !varEl) return;
        const a = parseFloat(mtdActualEl.value.replace(/,/g, ''));
        const f = parseFloat(mtdForecastEl.value.replace(/,/g, ''));
        if (a > 4) {
          varEl.value = '-100%';
        } else if (Number.isFinite(a) && Number.isFinite(f) && f !== 0) {
          const v = ((f - a) / f) * 100;
          varEl.value = Math.round(v) + '%';
        } else {
          varEl.value = '';
        }
      }

      function computeOHSSafetyOutlook() {
        const dateEl = document.getElementById('ohsSafety_date');
        const mtdActualEl = document.getElementById('ohsSafety_mtd_actual');
        const fullForecastEl = document.getElementById('ohsSafety_fullForecast');
        const outlookEl = document.getElementById('ohsSafety_outlook');
        if (!dateEl || !mtdActualEl || !fullForecastEl || !outlookEl) return;
        const dateVal = dateEl.value;
        if (!dateVal) { outlookEl.value = ''; return; }
        const date = new Date(dateVal);
        if (isNaN(date)) { outlookEl.value = ''; return; }
        const year = date.getFullYear();
        const month = date.getMonth();
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        const dayOfMonth = date.getDate();
        const remainingDays = daysInMonth - dayOfMonth;
        if (remainingDays <= 0) { outlookEl.value = ''; return; }
        const mtdActual = parseFloat(mtdActualEl.value.replace(/,/g, '')) || 0;
        const fullForecast = parseFloat(fullForecastEl.value.replace(/,/g, '')) || 0;
        const result = mtdActual + ((fullForecast - mtdActual) / remainingDays);
        outlookEl.value = Math.round(result).toString();
      }

      function computeOHSSafetyVar3() {
        const outlookEl = document.getElementById('ohsSafety_outlook');
        const fullForecastEl = document.getElementById('ohsSafety_fullForecast');
        const varEl = document.getElementById('ohsSafety_var3');
        if (!outlookEl || !fullForecastEl || !varEl) return;
        const a = parseFloat(outlookEl.value.replace(/,/g, ''));
        const f = parseFloat(fullForecastEl.value.replace(/,/g, ''));
        if (Number.isFinite(a) && Number.isFinite(f)) {
          if (f === 0) {
            varEl.value = '-100%';
          } else {
            const v = ((a - f) / f) * 100;
            varEl.value = Math.round(v) + '%';
          }
        } else {
          varEl.value = '';
        }
      }

      function computeOHSSafetyMTDActual() {
        const dateEl = document.getElementById('ohsSafety_date');
        const kpiEl = document.getElementById('ohsSafety_kpi');
        const dailyActualEl = document.getElementById('ohsSafety_daily_actual');
        const mtdActualEl = document.getElementById('ohsSafety_mtd_actual');
        if (!dateEl || !kpiEl || !dailyActualEl || !mtdActualEl) return;
        const dateVal = dateEl.value;
        const kpiVal = kpiEl.value.trim();
        const dailyActual = parseFloat(dailyActualEl.value.replace(/,/g, '')) || 0;
        if (!dateVal || !kpiVal) {
          mtdActualEl.value = dailyActual.toLocaleString();
          return;
        }
        const monthVal = dateVal.substring(0, 7);
        // Find previous records in the same month for the same KPI, before this date
        const currentDate = new Date(dateVal);
        const currentMonth = currentDate.getMonth();
        const currentYear = currentDate.getFullYear();
        const prevRecords = (state.kpi_records || []).filter(r => {
          if (r.dept !== 'OHS' || r.subtype !== 'safety' || r.kpi !== kpiVal || !r.date) return false;
          const rDate = new Date(r.date);
          if (isNaN(rDate)) return false;
          if (rDate.getFullYear() !== currentYear || rDate.getMonth() !== currentMonth) return false;
          return rDate < currentDate;
        });
        let prevSum = 0;
        prevRecords.forEach(r => {
          const val = parseFloat(String(r.daily_actual).replace(/,/g, ''));
          if (Number.isFinite(val)) prevSum += val;
        });
        const newMTD = prevSum + dailyActual;
        mtdActualEl.value = newMTD.toLocaleString();
      }

      // wire OHS Safety variances
      (function wireOHSSafetyVars() {
        const actualEl = document.getElementById('ohsSafety_daily_actual');
        const forecastEl = document.getElementById('ohsSafety_daily_forecast');
        const dateEl = document.getElementById('ohsSafety_date');
        const mtdActualEl = document.getElementById('ohsSafety_mtd_actual');
        const mtdForecastEl = document.getElementById('ohsSafety_mtd_forecast');
        const fullForecastEl = document.getElementById('ohsSafety_fullForecast');
        const outlookEl = document.getElementById('ohsSafety_outlook');
        if (actualEl) actualEl.addEventListener('input', () => {
          computeOHSSafetyVar1();
          computeOHSSafetyMTDActual();
          computeOHSSafetyVar2();
          computeOHSSafetyOutlook();
          computeOHSSafetyVar3();
        });
        if (mtdActualEl) mtdActualEl.addEventListener('input', computeOHSSafetyVar2);
        if (mtdForecastEl) mtdForecastEl.addEventListener('input', computeOHSSafetyVar2);
        if (mtdActualEl) mtdActualEl.addEventListener('input', computeOHSSafetyOutlook);
        if (fullForecastEl) fullForecastEl.addEventListener('input', computeOHSSafetyOutlook);
        if (outlookEl) outlookEl.addEventListener('input', computeOHSSafetyVar3);
        if (fullForecastEl) fullForecastEl.addEventListener('input', computeOHSSafetyVar3);
        if (dateEl) dateEl.addEventListener('change', () => {
          // Then compute MTD Actual
          computeOHSSafetyMTDActual();
          // Then set MTD Forecast to 2
          const mtdForecastEl = document.getElementById('ohsSafety_mtd_forecast');
          if (mtdForecastEl) mtdForecastEl.value = '2';
          // Then compute Var2
          computeOHSSafetyVar2();
          // Set Full Forecast and Full Budget to 1, and month to month number
          if (dateEl.value) {
            const fullForecastEl = document.getElementById('ohsSafety_fullForecast');
            if (fullForecastEl) fullForecastEl.value = '0';
            const fullBudgetEl = document.getElementById('ohsSafety_fullBudget');
            if (fullBudgetEl) fullBudgetEl.value = '0';
            const monthEl = document.getElementById('ohsSafety_month');
            if (monthEl) {
              const date = new Date(dateEl.value);
              if (!isNaN(date)) {
                monthEl.value = date.getMonth() + 1;
              }
            }
          }
          // Compute Outlook and Var3
          computeOHSSafetyOutlook();
          computeOHSSafetyVar3();
        });
      })();

      // OHS Environmental form helpers
      const btnOHSEnvironmentalClear = document.getElementById('btnOHSEnvironmentalClear');
      if (btnOHSEnvironmentalClear) btnOHSEnvironmentalClear.addEventListener('click', () => {
        ['ohsEnvironmental_kpi', 'ohsEnvironmental_date', 'ohsEnvironmental_daily_actual', 'ohsEnvironmental_daily_forecast', 'ohsEnvironmental_var1', 'ohsEnvironmental_mtd_actual', 'ohsEnvironmental_mtd_forecast', 'ohsEnvironmental_var2', 'ohsEnvironmental_outlook', 'ohsEnvironmental_fullForecast', 'ohsEnvironmental_fullBudget', 'ohsEnvironmental_var3', 'ohsEnvironmental_month'].forEach(id => { const el = document.getElementById(id); if (el) el.value = ''; });
        const k = document.getElementById('ohsEnvironmental_kpi'); if (k) k.value = 'Environmental Incidents';
      });
      const btnOHSEnvironmentalSave = document.getElementById('btnOHSEnvironmentalSave');
      if (btnOHSEnvironmentalSave) btnOHSEnvironmentalSave.addEventListener('click', () => {
        const kpi = (document.getElementById('ohsEnvironmental_kpi') || {}).value || '';
        const date = (document.getElementById('ohsEnvironmental_date') || {}).value || '';
        const daily_actual = (document.getElementById('ohsEnvironmental_daily_actual') || {}).value || '';
        const daily_forecast = (document.getElementById('ohsEnvironmental_daily_forecast') || {}).value || '0';
        const var1 = (document.getElementById('ohsEnvironmental_var1') || {}).value || '';
        const mtd_actual = (document.getElementById('ohsEnvironmental_mtd_actual') || {}).value || '';
        const mtd_forecast = (document.getElementById('ohsEnvironmental_mtd_forecast') || {}).value || '';
        const var2 = (document.getElementById('ohsEnvironmental_var2') || {}).value || '';
        const outlook = (document.getElementById('ohsEnvironmental_outlook') || {}).value || '';
        const fullForecast = (document.getElementById('ohsEnvironmental_fullForecast') || {}).value || '';
        const fullBudget = (document.getElementById('ohsEnvironmental_fullBudget') || {}).value || '';
        const var3 = (document.getElementById('ohsEnvironmental_var3') || {}).value || '';
        const month = (document.getElementById('ohsEnvironmental_month') || {}).value || '';
        if (!kpi) { alert('Enter KPI'); return; }
        const rec = { subtype: 'environmental', kpi, date, daily_actual, daily_forecast, var1, mtd_actual, mtd_forecast, var2, outlook, fullForecast, fullBudget, var3, month };
        if (editingKPIId) {
          const existing = (state.kpi_records || []).find(r => r.id === editingKPIId);
          if (existing && existing.subtype === 'environmental') rec.id = editingKPIId;
        }
        addKPIRecord('OHS', rec);
        ['ohsEnvironmental_kpi', 'ohsEnvironmental_date', 'ohsEnvironmental_daily_actual', 'ohsEnvironmental_daily_forecast', 'ohsEnvironmental_var1', 'ohsEnvironmental_mtd_actual', 'ohsEnvironmental_mtd_forecast', 'ohsEnvironmental_var2', 'ohsEnvironmental_outlook', 'ohsEnvironmental_fullForecast', 'ohsEnvironmental_fullBudget', 'ohsEnvironmental_var3', 'ohsEnvironmental_month'].forEach(id => { const el = document.getElementById(id); if (el) el.value = ''; });
        editingKPIId = null;
        alert('Environmental record saved');
      });

      // compute variances for OHS Environmental
      function computeOHSEnvironmentalVar1() {
        const actualEl = document.getElementById('ohsEnvironmental_daily_actual');
        const forecastEl = document.getElementById('ohsEnvironmental_daily_forecast');
        const varEl = document.getElementById('ohsEnvironmental_var1');
        if (!actualEl || !forecastEl || !varEl) return;
        const a = parseFloat(actualEl.value.replace(/,/g, ''));
        const f = parseFloat(forecastEl.value.replace(/,/g, '')) || 0;
        if (Number.isFinite(a) && Number.isFinite(f)) {
          if (a === 0) {
            varEl.value = '100%';
          } else if (a < 0) {
            varEl.value = '-100%';
          } else if (f === 0) {
            varEl.value = '-100%';
          } else {
            const v = ((a - f) / f) * 100;
            varEl.value = Math.round(v) + '%';
          }
        } else {
          varEl.value = '';
        }
      }

      function computeOHSEnvironmentalVar2() {
        const mtdActualEl = document.getElementById('ohsEnvironmental_mtd_actual');
        const mtdForecastEl = document.getElementById('ohsEnvironmental_mtd_forecast');
        const varEl = document.getElementById('ohsEnvironmental_var2');
        if (!mtdActualEl || !mtdForecastEl || !varEl) return;
        const a = parseFloat(mtdActualEl.value.replace(/,/g, ''));
        const f = parseFloat(mtdForecastEl.value.replace(/,/g, ''));
        if (Number.isFinite(a) && Number.isFinite(f)) {
          if (a === 0) {
            varEl.value = '-100%';
          } else {
            const v = ((f - a) / a) * 100;
            varEl.value = Math.round(v) + '%';
          }
        } else {
          varEl.value = '';
        }
      }

      function computeOHSEnvironmentalOutlook() {
        const dateEl = document.getElementById('ohsEnvironmental_date');
        const mtdActualEl = document.getElementById('ohsEnvironmental_mtd_actual');
        const fullForecastEl = document.getElementById('ohsEnvironmental_fullForecast');
        const outlookEl = document.getElementById('ohsEnvironmental_outlook');
        if (!dateEl || !mtdActualEl || !fullForecastEl || !outlookEl) return;
        const dateVal = dateEl.value;
        if (!dateVal) { outlookEl.value = ''; return; }
        const date = new Date(dateVal);
        if (isNaN(date)) { outlookEl.value = ''; return; }
        const year = date.getFullYear();
        const month = date.getMonth();
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        const dayOfMonth = date.getDate();
        const remainingDays = daysInMonth - dayOfMonth;
        if (remainingDays <= 0) { outlookEl.value = ''; return; }
        const mtdActual = parseFloat(mtdActualEl.value.replace(/,/g, '')) || 0;
        const fullForecast = parseFloat(fullForecastEl.value.replace(/,/g, '')) || 0;
        const result = mtdActual + ((fullForecast - mtdActual) / remainingDays);
        outlookEl.value = Math.round(result).toString();
      }

      function computeOHSEnvironmentalVar3() {
        const outlookEl = document.getElementById('ohsEnvironmental_outlook');
        const fullForecastEl = document.getElementById('ohsEnvironmental_fullForecast');
        const varEl = document.getElementById('ohsEnvironmental_var3');
        if (!outlookEl || !fullForecastEl || !varEl) return;
        const a = parseFloat(outlookEl.value.replace(/,/g, ''));
        const f = parseFloat(fullForecastEl.value.replace(/,/g, ''));
        if (Number.isFinite(a) && Number.isFinite(f)) {
          if (f === 0) {
            varEl.value = '-100%';
          } else {
            const v = ((a - f) / f) * 100;
            varEl.value = Math.round(v) + '%';
          }
        } else {
          varEl.value = '';
        }
      }

      function computeOHSEnvironmentalMTDActual() {
        const dateEl = document.getElementById('ohsEnvironmental_date');
        const kpiEl = document.getElementById('ohsEnvironmental_kpi');
        const dailyActualEl = document.getElementById('ohsEnvironmental_daily_actual');
        const mtdActualEl = document.getElementById('ohsEnvironmental_mtd_actual');
        if (!dateEl || !kpiEl || !dailyActualEl || !mtdActualEl) return;
        const dateVal = dateEl.value;
        const kpiVal = kpiEl.value.trim();
        const dailyActual = parseFloat(dailyActualEl.value.replace(/,/g, '')) || 0;
        if (!dateVal || !kpiVal) {
          mtdActualEl.value = dailyActual.toLocaleString();
          return;
        }
        const monthVal = dateVal.substring(0, 7);
        // Find previous records in the same month for the same KPI, before this date
        const prevRecords = (state.kpi_records || []).filter(r => r.dept === 'OHS' && r.subtype === 'environmental' && r.kpi === kpiVal && r.date && r.date.startsWith(monthVal) && r.date < dateVal);
        let prevSum = 0;
        prevRecords.forEach(r => {
          const val = parseFloat(String(r.daily_actual).replace(/,/g, ''));
          if (Number.isFinite(val)) prevSum += val;
        });
        const newMTD = prevSum + dailyActual;
        mtdActualEl.value = newMTD.toLocaleString();
      }

      // wire OHS Environmental variances
      (function wireOHSEnvironmentalVars() {
        const actualEl = document.getElementById('ohsEnvironmental_daily_actual');
        const forecastEl = document.getElementById('ohsEnvironmental_daily_forecast');
        const dateEl = document.getElementById('ohsEnvironmental_date');
        const mtdActualEl = document.getElementById('ohsEnvironmental_mtd_actual');
        const mtdForecastEl = document.getElementById('ohsEnvironmental_mtd_forecast');
        const fullForecastEl = document.getElementById('ohsEnvironmental_fullForecast');
        const outlookEl = document.getElementById('ohsEnvironmental_outlook');
        if (actualEl) actualEl.addEventListener('input', () => {
          computeOHSEnvironmentalVar1();
          computeOHSEnvironmentalMTDActual();
          computeOHSEnvironmentalVar2();
          computeOHSEnvironmentalOutlook();
          computeOHSEnvironmentalVar3();
        });
        if (mtdActualEl) mtdActualEl.addEventListener('input', computeOHSEnvironmentalVar2);
        if (mtdForecastEl) mtdForecastEl.addEventListener('input', computeOHSEnvironmentalVar2);
        if (mtdActualEl) mtdActualEl.addEventListener('input', computeOHSEnvironmentalOutlook);
        if (fullForecastEl) fullForecastEl.addEventListener('input', computeOHSEnvironmentalOutlook);
        if (outlookEl) outlookEl.addEventListener('input', computeOHSEnvironmentalVar3);
        if (fullForecastEl) fullForecastEl.addEventListener('input', computeOHSEnvironmentalVar3);
        if (dateEl) dateEl.addEventListener('change', () => {
          // Then compute MTD Actual
          computeOHSEnvironmentalMTDActual();
          // Then set MTD Forecast to 0
          const mtdForecastEl = document.getElementById('ohsEnvironmental_mtd_forecast');
          if (mtdForecastEl) mtdForecastEl.value = '0';
          // Then compute Var2
          computeOHSEnvironmentalVar2();
          // Set Full Forecast and Full Budget to 0, and month to month number
          if (dateEl.value) {
            const fullForecastEl = document.getElementById('ohsEnvironmental_fullForecast');
            if (fullForecastEl) fullForecastEl.value = '0';
            const fullBudgetEl = document.getElementById('ohsEnvironmental_fullBudget');
            if (fullBudgetEl) fullBudgetEl.value = '0';
            const monthEl = document.getElementById('ohsEnvironmental_month');
            if (monthEl) {
              const date = new Date(dateEl.value);
              if (!isNaN(date)) {
                monthEl.value = date.getMonth() + 1;
              }
            }
          }
          // Compute Outlook and Var3
          computeOHSEnvironmentalOutlook();
          computeOHSEnvironmentalVar3();
        });
      })();

      // OHS Property form helpers
      const btnOHSPropertyClear = document.getElementById('btnOHSPropertyClear');
      if (btnOHSPropertyClear) btnOHSPropertyClear.addEventListener('click', () => {
        ['ohsProperty_kpi', 'ohsProperty_date', 'ohsProperty_daily_actual', 'ohsProperty_daily_forecast', 'ohsProperty_var1', 'ohsProperty_mtd_actual', 'ohsProperty_mtd_forecast', 'ohsProperty_var2', 'ohsProperty_outlook', 'ohsProperty_fullForecast', 'ohsProperty_fullBudget', 'ohsProperty_var3', 'ohsProperty_month'].forEach(id => { const el = document.getElementById(id); if (el) el.value = id === 'ohsProperty_mtd_forecast' ? '0' : ''; });
        const k = document.getElementById('ohsProperty_kpi'); if (k) k.value = 'Property Damage';
      });
      const btnOHSPropertySave = document.getElementById('btnOHSPropertySave');
      if (btnOHSPropertySave) btnOHSPropertySave.addEventListener('click', () => {
        const kpi = (document.getElementById('ohsProperty_kpi') || {}).value || '';
        const date = (document.getElementById('ohsProperty_date') || {}).value || '';
        const daily_actual = (document.getElementById('ohsProperty_daily_actual') || {}).value || '';
        const daily_forecast = (document.getElementById('ohsProperty_daily_forecast') || {}).value || '0';
        const var1 = (document.getElementById('ohsProperty_var1') || {}).value || '';
        const mtd_actual = (document.getElementById('ohsProperty_mtd_actual') || {}).value || '';
        const mtd_forecast = (document.getElementById('ohsProperty_mtd_forecast') || {}).value || '';
        const var2 = (document.getElementById('ohsProperty_var2') || {}).value || '';
        const outlook = (document.getElementById('ohsProperty_outlook') || {}).value || '';
        const fullForecast = (document.getElementById('ohsProperty_fullForecast') || {}).value || '';
        const fullBudget = (document.getElementById('ohsProperty_fullBudget') || {}).value || '';
        const var3 = (document.getElementById('ohsProperty_var3') || {}).value || '';
        const month = (document.getElementById('ohsProperty_month') || {}).value || '';
        if (!kpi) { alert('Enter KPI'); return; }
        const rec = { subtype: 'property', kpi, date, daily_actual, daily_forecast, var1, mtd_actual, mtd_forecast, var2, outlook, fullForecast, fullBudget, var3, month };
        if (editingKPIId) {
          const existing = (state.kpi_records || []).find(r => r.id === editingKPIId);
          if (existing && existing.subtype === 'property') rec.id = editingKPIId;
        }
        addKPIRecord('OHS', rec);
        ['ohsProperty_kpi', 'ohsProperty_date', 'ohsProperty_daily_actual', 'ohsProperty_daily_forecast', 'ohsProperty_var1', 'ohsProperty_mtd_actual', 'ohsProperty_mtd_forecast', 'ohsProperty_var2', 'ohsProperty_outlook', 'ohsProperty_fullForecast', 'ohsProperty_fullBudget', 'ohsProperty_var3', 'ohsProperty_month'].forEach(id => { const el = document.getElementById(id); if (el) el.value = id === 'ohsProperty_mtd_forecast' ? '2' : id === 'ohsProperty_fullForecast' || id === 'ohsProperty_fullBudget' ? '1' : ''; });
        const k = document.getElementById('ohsProperty_kpi'); if (k) k.value = 'Property Damage';
        editingKPIId = null;
        alert('Property record saved');
      });

      // compute variances for OHS Property
      function computeOHSPropertyVar1() {
        const actualEl = document.getElementById('ohsProperty_daily_actual');
        const forecastEl = document.getElementById('ohsProperty_daily_forecast');
        const varEl = document.getElementById('ohsProperty_var1');
        if (!actualEl || !forecastEl || !varEl) return;
        const a = parseFloat(actualEl.value.replace(/,/g, ''));
        const f = parseFloat(forecastEl.value.replace(/,/g, '')) || 0;
        if (Number.isFinite(a) && Number.isFinite(f)) {
          if (a === 0) {
            varEl.value = '100%';
          } else if (a < 0) {
            varEl.value = '-100%';
          } else if (f === 0) {
            varEl.value = '-100%';
          } else {
            const v = ((a - f) / f) * 100;
            varEl.value = Math.round(v) + '%';
          }
        } else {
          varEl.value = '';
        }
      }

      function computeOHSPropertyVar2() {
        const mtdActualEl = document.getElementById('ohsProperty_mtd_actual');
        const mtdForecastEl = document.getElementById('ohsProperty_mtd_forecast');
        const varEl = document.getElementById('ohsProperty_var2');
        if (!mtdActualEl || !mtdForecastEl || !varEl) return;
        const a = parseFloat(mtdActualEl.value.replace(/,/g, ''));
        const f = parseFloat(mtdForecastEl.value.replace(/,/g, ''));
        if (a > 4) {
          varEl.value = '-100%';
        } else if (Number.isFinite(a) && Number.isFinite(f) && f !== 0) {
          const v = ((f - a) / f) * 100;
          varEl.value = Math.round(v) + '%';
        } else {
          varEl.value = '';
        }
      }

      function computeOHSPropertyOutlook() {
        const dateEl = document.getElementById('ohsProperty_date');
        const mtdActualEl = document.getElementById('ohsProperty_mtd_actual');
        const fullForecastEl = document.getElementById('ohsProperty_fullForecast');
        const outlookEl = document.getElementById('ohsProperty_outlook');
        if (!dateEl || !mtdActualEl || !fullForecastEl || !outlookEl) return;
        const dateVal = dateEl.value;
        if (!dateVal) { outlookEl.value = ''; return; }
        const date = new Date(dateVal);
        if (isNaN(date)) { outlookEl.value = ''; return; }
        const year = date.getFullYear();
        const month = date.getMonth();
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        const dayOfMonth = date.getDate();
        const remainingDays = daysInMonth - dayOfMonth;
        if (remainingDays <= 0) { outlookEl.value = ''; return; }
        const mtdActual = parseFloat(mtdActualEl.value.replace(/,/g, '')) || 0;
        const fullForecast = parseFloat(fullForecastEl.value.replace(/,/g, '')) || 0;
        const result = mtdActual + ((fullForecast - mtdActual) / remainingDays);
        outlookEl.value = Math.round(result).toString();
      }

      function computeOHSPropertyVar3() {
        const outlookEl = document.getElementById('ohsProperty_outlook');
        const fullForecastEl = document.getElementById('ohsProperty_fullForecast');
        const varEl = document.getElementById('ohsProperty_var3');
        if (!outlookEl || !fullForecastEl || !varEl) return;
        const a = parseFloat(outlookEl.value.replace(/,/g, ''));
        const f = parseFloat(fullForecastEl.value.replace(/,/g, ''));
        if (a > 1) {
          varEl.value = '-100%';
        } else if (Number.isFinite(a) && Number.isFinite(f) && f !== 0) {
          const v = ((f - a) / f) * 100;
          varEl.value = Math.round(v) + '%';
        } else {
          varEl.value = '';
        }
      }

      function computeOHSPropertyMTDActual() {
        const dateEl = document.getElementById('ohsProperty_date');
        const kpiEl = document.getElementById('ohsProperty_kpi');
        const dailyActualEl = document.getElementById('ohsProperty_daily_actual');
        const mtdActualEl = document.getElementById('ohsProperty_mtd_actual');
        if (!dateEl || !kpiEl || !dailyActualEl || !mtdActualEl) return;
        const dateVal = dateEl.value;
        const kpiVal = kpiEl.value.trim();
        const dailyActual = parseFloat(dailyActualEl.value.replace(/,/g, '')) || 0;
        if (!dateVal || !kpiVal) {
          mtdActualEl.value = dailyActual.toLocaleString();
          return;
        }
        const monthVal = dateVal.substring(0, 7);
        // Find previous records in the same month for the same KPI, before this date
        const prevRecords = (state.kpi_records || []).filter(r => r.dept === 'OHS' && r.subtype === 'property' && r.kpi === kpiVal && r.date && r.date.startsWith(monthVal) && r.date < dateVal).sort((a, b) => b.date.localeCompare(a.date));
        let prevMTD = 0;
        if (prevRecords.length > 0) {
          prevMTD = parseFloat(prevRecords[0].mtd_actual.replace(/,/g, '')) || 0;
        }
        const newMTD = prevMTD + dailyActual;
        mtdActualEl.value = newMTD.toLocaleString();
      }

      // update MTD Forecast for OHS Property: get from Fixed Inputs matching KPI and month
      function updateOHSPropertyMTDForecast() {
        try {
          const kpiEl = document.getElementById('ohsProperty_kpi');
          const dateEl = document.getElementById('ohsProperty_date');
          const outEl = document.getElementById('ohsProperty_mtd_forecast');
          if (!kpiEl || !dateEl || !outEl) return;
          const kpi = (kpiEl.value || '').trim();
          const date = (dateEl.value || '').trim();
          if (!kpi || !date) { outEl.value = ''; return; }
          const d = new Date(date);
          if (isNaN(d)) { outEl.value = ''; return; }
          const month = d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0');
          // find fixed OHS record with matching KPI and month
          const fixed = (state.kpi_records || []).find(r => {
            if (r.dept !== 'OHS') return false;
            if (r.subtype) return false; // only fixed inputs
            const rKPI = (r.kpi || '').toString().trim();
            const rMonth = (r.month || '').toString().trim();
            // Normalize month to YYYY-MM format
            let normalizedRMonth = rMonth;
            if (/^(\d{2})-(\d{4})$/.test(rMonth)) {
              normalizedRMonth = rMonth.replace(/^(\d{2})-(\d{4})$/, '$2-$1');
            } else {
              normalizedRMonth = rMonth.replace(/(\d{4})-(\d)$/, '$1-0$2');
            }
            return rKPI === kpi && normalizedRMonth === month;
          });
          if (fixed && (fixed.fullForecast !== undefined && fixed.fullForecast !== null)) {
            outEl.value = fixed.fullForecast;
          } else {
            outEl.value = '';
          }
        } catch (e) { console.warn('updateOHSPropertyMTDForecast error', e); }
      }

      // wire OHS Property variances
      (function wireOHSPropertyVars() {
        const actualEl = document.getElementById('ohsProperty_daily_actual');
        const forecastEl = document.getElementById('ohsProperty_daily_forecast');
        const dateEl = document.getElementById('ohsProperty_date');
        const kpiEl = document.getElementById('ohsProperty_kpi');
        const mtdActualEl = document.getElementById('ohsProperty_mtd_actual');
        const mtdForecastEl = document.getElementById('ohsProperty_mtd_forecast');
        const fullForecastEl = document.getElementById('ohsProperty_fullForecast');
        const outlookEl = document.getElementById('ohsProperty_outlook');
        if (actualEl) actualEl.addEventListener('input', () => {
          computeOHSPropertyVar1();
          computeOHSPropertyMTDActual();
          computeOHSPropertyVar2();
          computeOHSPropertyOutlook();
          computeOHSPropertyVar3();
        });
        if (mtdActualEl) mtdActualEl.addEventListener('input', computeOHSPropertyVar2);
        if (mtdForecastEl) mtdForecastEl.addEventListener('input', computeOHSPropertyVar2);
        if (mtdActualEl) mtdActualEl.addEventListener('input', computeOHSPropertyOutlook);
        if (fullForecastEl) fullForecastEl.addEventListener('input', computeOHSPropertyOutlook);
        if (outlookEl) outlookEl.addEventListener('input', computeOHSPropertyVar3);
        if (fullForecastEl) fullForecastEl.addEventListener('input', computeOHSPropertyVar3);
        if (kpiEl) kpiEl.addEventListener('input', updateOHSPropertyMTDForecast);
        if (dateEl) dateEl.addEventListener('change', () => {
          // Update MTD Forecast from Fixed Inputs, set Full Forecast and Full Budget to 1, and month to month number
          if (dateEl.value) {
            updateOHSPropertyMTDForecast();
            const fullForecastEl = document.getElementById('ohsProperty_fullForecast');
            if (fullForecastEl) fullForecastEl.value = '1';
            const fullBudgetEl = document.getElementById('ohsProperty_fullBudget');
            if (fullBudgetEl) fullBudgetEl.value = '1';
            const monthEl = document.getElementById('ohsProperty_month');
            if (monthEl) {
              const date = new Date(dateEl.value);
              if (!isNaN(date)) {
                monthEl.value = date.getMonth() + 1;
              }
            }
          }
          // Compute Outlook and Var3
          computeOHSPropertyOutlook();
          computeOHSPropertyVar3();
        });
      })();

      // wire the variance computation and MTD Forecast to inputs for Geology Ore
      (function wireGeoOreVar() {
        const dailyActualEl = document.getElementById('geoOre_daily_actual');
        const dailyForecastEl = document.getElementById('geoOre_daily_forecast');
        const mtdForecastEl = document.getElementById('geoOre_mtd_forecast');
        const outlookEl = document.getElementById('geoOre_outlook');
        const fullForecastEl = document.getElementById('geoOre_fullForecast');
        const dateEl = document.getElementById('geoOre_date');
        if (dailyActualEl) dailyActualEl.addEventListener('input', () => { computeGeoOreVar(); computeGeoOreMTDActual(); computeGeoOreMTDVar(); computeGeoOreFullVar(); computeGeoOreMTDForecast(); });
        if (dailyForecastEl) dailyForecastEl.addEventListener('input', () => { computeGeoOreVar(); computeGeoOreMTDForecast(); });
        if (mtdForecastEl) mtdForecastEl.addEventListener('input', computeGeoOreMTDVar);
        if (outlookEl) outlookEl.addEventListener('input', computeGeoOreFullVar);
        if (fullForecastEl) fullForecastEl.addEventListener('input', computeGeoOreFullVar);
        if (dateEl) dateEl.addEventListener('change', () => { computeGeoOreMTDForecast(); computeGeoOreMTDActual(); computeGeoOreMTDVar(); });
      })();

      // wire month update from date for Geology Ore
      (function wireGeoOreMonth() {
        const dateEl = document.getElementById('geoOre_date');
        if (dateEl) dateEl.addEventListener('change', () => {
          const monthEl = document.getElementById('geoOre_month');
          if (monthEl && dateEl.value) {
            const date = new Date(dateEl.value);
            if (!isNaN(date)) {
              monthEl.value = date.getMonth() + 1;
            }
          }
          // recompute MTD values when date changes
          computeGeoOreMTDActual();
          computeGeoOreMTDVar();
        });
      })();

      (function setDefaultMonthInputs() {
        const now = new Date(); const yyyy = now.getFullYear(); const mm = String(now.getMonth() + 1).padStart(2, '0'); const val = yyyy + '-' + mm;
        ['geoTargetMonth', 'crushTargetMonth'].forEach(id => { const el = document.getElementById(id); if (el && el.type === 'month') el.value = val; });
      })();

      // show default section (Add Employee) on first load
      // only if user clicks nothing; caller can choose otherwise
      // do not auto-show if user is deep-linking via import state; show Add Employee by default
      showSection('addEmployee');
      // update dashboard whenever requests/employees change
      const originalRenderRequests = renderRequests;
      renderRequests = function () { originalRenderRequests(); try { renderDashboard(); } catch (e) { } };
    })();
  </script>
</body>

</html>